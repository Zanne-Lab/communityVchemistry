---
title: "Does endophyte diversity explain decay?"
author: "Marissa Lee"
date: "12/2/2018"
output: github_document
---

```{r, include = F}
#chunk options
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

Load libraries, functions
```{r load}

#---------------------------#
#libraries
library(tidyverse) # ggplot2, dplyr, tidyr, readr, purrr
#library(tidymodels) # broom
#library(sjstats) #provides function eta_sq() to extract r2 for each predictor in a lm
library(grid) #plotting
library(gridExtra) # plotting
#library(GGally) # bivariate plots
#library(lmtest) # for coxtest()
library(vegan) #diversity metrics
library(rioja) #WA-PLS

#---------------------------#
#fxns
source('code/helper_fxns.R')
sourceDir('code')
```

Load data
```{r}
#---------------------------#
#data

# samples and decay
stemSamples <- load_stemSamples() # this function is in load_microbeData.R
initial_mass <- read_in_initial_mass()
harvest_mass <- LoadHarvestFiles()
pmr <- Calc_massRemaining(initial_mass, harvest_mass) # calculate percent mass remaining (pmr)
pmr_byStem <- AvgPMR_byStem(pmr, long.form = F) # average pmr for each stem and timepoint
stem.respVars <- list("time7", "time13", "time25", "time37","time59")
decayfits <- read_csv("derived_data/decayfits.csv") # see 1_decayPatterns.Rmd to update
code.respVars <- list("w.t50","beta","alpha","w.r2")
# weibull params
# beta = scale param = higher values mean *slower* decay
# alpha = scale param = higher values mean more S-shaped

# wood traits
traits.code <- trait.means_byCode(stemSamples, fill.densitybark = TRUE) # averaged by code; if fill.densitybark == TRUE, then use small stem estimates to approximate large stem density and bark thickness
traits.stem <- trait.means_byStem(stemSamples) # averaged by codeStem
trait.order <- traitcol.order()
traitVars <- c(trait.order$phys.cols, trait.order$nutr.cols)
traitVars.stem <- trait.order$stem.trait.cols
traitVars.cfract <- trait.order$cfract.cols

# residuals from 'woodTraits_explainDecay.Rmd'
resids_explainDecay.list <- readRDS(file = "derived_data/resids_explainDecay_list.RData")

# microbes
microb.data <- load_MicrobeCollection(stemSamples)
taxAndFunguild <- microb.data$taxAndFunguild
comm.otu <- microb.data$comm.otu
seqSamples <- microb.data$seqSamples

#check for oomycetes
colnames(comm.otu)[grep("oo", colnames(comm.otu))]
taxAndFunguild %>%
  filter(kingdom != "Fungi")

```

# Diversity (and diversity of specific clades) as a predictor  

**Note that the full community matrix was used for these analyses**

## *Hyp-a (species+size-level)* Greater microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will lead to better-fitting decay models (ne.r2), faster decay (k), and less lagginess (alpha) because of the selection effect for fast decayers and complementarity among taxa for decay.  
Hyp-Alt: Greater microbial diversity will lead to worse-fitting decay models (ne.r2), slower decay (k), and more lagginess (alpha) because taxa will be allocating more of their resources to combat one another.
## *Hyp-b (species+size-level)* Greater saprotroph and basidiomycete richness will lead to better-fitting decay models (ne.r2), faster decay (k), and less lagginess (alpha) because the community does not need to wait for the arrival of key decayers to act on the wood substrate.  
Hyp-Alt: Greater saprotroph and basidiomycete richness will lead to worse-fitting decay models (ne.r2), slower decay (k), and more lagginess (alpha) because decayers will be allocating more of their resources to combat one another.
## *Hyp-c (species+size-level)* Greater pathogen and oomycete richness will lead to worse-fitting decay models (ne.r2), slower decay (k), and more lagginess (alpha) because the presence of these organisms will inhibit the establishment and activity of decayers.
```{r}
result.list <- doAnalysis_endoDiv_explainDecay(taxAndFunguild, comm.otu, decayfits, code.respVars)
result.list$pretty.df
write.csv(result.list$pretty.df, file="output/tables/diversitysummary_code.csv")

#identify significant relationships
result.list$pretty.df %>%
  filter(term %in% c('mean','sizesmall:mean')) %>%
  gather(key = "respvar", value = "coef", -c(source, term)) %>%
  mutate(signif = ifelse(grepl("*", coef, fixed = T), T, F)) %>%
  filter(signif == T)

# make a df summary
tmp <- result.list$pretty.df
tmp %>%
  filter(term %in% c('mean','sizesmall:mean')) %>%
  gather(key = "respvar", value = "coef", -c(source, term)) %>%
  mutate(signif = ifelse(grepl("*", coef, fixed = T), T, F)) %>%
  mutate(model = "code") %>%
  mutate(term.new = ifelse(term == "mean", "diversity", NA)) %>%
  mutate(term.new = ifelse(term == "sizesmall:mean", "size:diversity", term.new)) %>%
  select(-term) -> summ.code
summ.code


```

None of the diversity metrics and decay parameters are significantly related.

## *Hyp-a (stem-level)* Greater microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will lead to less mass remaining esp. at early time steps because of the selection effect for fast decayers and complementarity among taxa for decay. 
Hyp-Alt: Greater microbial diversity will lead to more mass remaining because taxa will be allocating more of their resources to combat one another.
## *Hyp-b (stem-level)* Greater saprotroph and basidiomycete richness will lead to less mass remaining esp. at early time steps because the community does not need to wait for the arrival of key decayers to act on the wood substrate.  
Hyp-Alt: Greater saprotroph and basidiomycete richness will lead to more mass remaining because decayers will be allocating more of their resources to combat one another.
## *Hyp-c (stem-level)* Greater pathogen and oomycete richness will lead to more mass remaining because the presence of these organisms will inhibit the establishment and activity of decayers.
```{r}
result.list.stem <- doAnalysis_endoDiv_explainPMR(taxAndFunguild, comm.otu, pmr_byStem, stem.respVars)
result.list.stem$pretty.df
write.csv(result.list.stem$pretty.df, file="output/tables/diversitysummary_stem.csv")

#identify significant relationships
result.list.stem$pretty.df %>%
   filter(term %in% c('sizesmall:sub_rich','sub_rich')) %>%
   gather(key = "respvar", value = "coef", -c(source, term)) %>%
   mutate(signif = ifelse(grepl("*", coef, fixed = T), T, F)) %>%
   filter(signif == T)


# make a df summary
tmp <- result.list.stem$pretty.df
tmp %>%
  filter(term %in% c('sub_rich','sizesmall:sub_rich')) %>%
  gather(key = "respvar", value = "coef", -c(source, term)) %>%
  mutate(signif = ifelse(grepl("*", coef, fixed = T), T, F)) %>%
  mutate(model = "stem") %>%
  mutate(term.new = ifelse(term == "sub_rich", "diversity", NA)) %>%
  mutate(term.new = ifelse(term == "sizesmall:sub_rich", "size:diversity", term.new)) %>%
  select(-term) -> summ.stem
summ.stem


```

Make a summary table plot
```{r}
summ.code %>%
  full_join(summ.stem) -> tmp
  
p1 <- ggplot(tmp, aes(y = respvar, x = term.new, fill = signif)) +
  geom_tile(color = "black") +
  facet_grid(~source) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Response variable") +
  xlab("Term") +
  ggtitle("Decay explained by diversity")
p1


```


OTU richness and Shannon's H are associated with percent mass remaining at time25 and time37. Pathogen OTU richness is associated with pmr at time 37. In all cases, there is a negative interaction between stem size and diversity.

Plot the relationship between OTU richness and Shannon's H and pmr at time25 and time37
```{r}
p.list <- makefig__RichShannonPMR.stem(taxAndFunguild, comm.otu, pmr_byStem, stem.respVars)
names(p.list)

pdf(file = "output/figures/richness_pmr.pdf", width = 10, height = 5)
grid.arrange(p.list$p.rich, p.list$p.h, ncol = 2)  
dev.off()

```

Not especially convincing relationships. On the whole, diversity is positively correlated with mass remaining in large stems but negatively correlated in small stems.

Plot the relationship between pathogen OTU richness and pmr at time37
```{r}
p <- makefig__pathoRichPMR.stem(taxAndFunguild, comm.otu, pmr_byStem, stem.respVars)
p
ggsave(filename = "output/figures/richness_patho_pmr.pdf", width = 5, height = 3.5)
```

Pathotroph richness is positively correlated with mass remaining in large stems, but negatively correlated in small stems.


##############################################

# Diversity plus traits as a predictor

## *Hyp (species+size-level)* After accounting for variation in decay due to wood traits, average initial microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will predict variation in decay model fit (r2), rate (k), and lagginess (alpha).
```{r}
names(resids_explainDecay.list)
traitResiduals.code <- resids_explainDecay.list$traits.code

result.list <- doAnalysis_endoDiv_explainDecayResids(taxAndFunguild, comm.otu, traitResiduals.code, code.respVars)
result.list$pretty.df
write.csv(result.list$pretty.df, file="output/tables/diversitysummary_code_traitresid.csv")

#identify significant relationships
result.list$pretty.df %>%
  filter(term %in% c('mean','sizesmall','sizesmall:mean')) %>%
  gather(key = "respvar", value = "coef", -c(source, term)) %>%
  mutate(signif = ifelse(grepl("*", coef, fixed = T), T, F)) %>%
  filter(signif == T)

# make a df summary
tmp <- result.list$pretty.df
tmp %>%
  filter(term %in% c('mean','sizesmall:mean')) %>%
  gather(key = "respvar", value = "coef", -c(source, term)) %>%
  mutate(signif = ifelse(grepl("*", coef, fixed = T), T, F)) %>%
  mutate(model = "code") %>%
  mutate(term.new = ifelse(term == "mean", "diversity", NA)) %>%
  mutate(term.new = ifelse(term == "sizesmall:mean", "size:diversity", term.new)) %>%
  select(-term) -> summ.code
summ.code

```

Beyond wood trait data, saprotroph richness improves models for beta and t60. 


## *Hyp (stem-level)* After accounting for variation in decay due to wood traits, initial microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will predict variation in percent mass loss, esp. at early time points.
```{r}
names(resids_explainDecay.list)
traitResiduals.stem <- resids_explainDecay.list$traits.stem

result.list.stem <- doAnalysis_endoDiv_explainPMRResids(taxAndFunguild, comm.otu, traitResiduals.stem, stem.respVars)
write.csv(result.list.stem$pretty.df, file="output/tables/diversitysummary_stem_traitresid.csv")

#identify significant relationships
result.list.stem$pretty.df %>%
  filter(term %in% c('sub_rich','sizesmall','sizesmall:sub_rich')) %>%
  gather(key = "respvar", value = "coef", -c(source, term)) %>%
  mutate(signif = ifelse(grepl("*", coef, fixed = T), T, F)) %>%
  filter(signif == T)

# make a df summary
tmp <- result.list.stem$pretty.df
tmp %>%
  filter(term %in% c('sub_rich','sizesmall:sub_rich')) %>%
  gather(key = "respvar", value = "coef", -c(source, term)) %>%
  mutate(signif = ifelse(grepl("*", coef, fixed = T), T, F)) %>%
  mutate(model = "stem") %>%
  mutate(term.new = ifelse(term == "sub_rich", "diversity", NA)) %>%
  mutate(term.new = ifelse(term == "sizesmall:sub_rich", "size:diversity", term.new)) %>%
  select(-term) -> summ.stem
summ.stem

```

Beyond wood trait data, overall and basidio OTU richness improve model estimates for percent mass remaining at 25 months. Pathotroph richness improves model estmates for pmr at 37 months.


Make a summary table plot
```{r}
summ.code %>%
  full_join(summ.stem) -> tmp
  
p2 <- ggplot(tmp, aes(y = respvar, x = term.new, fill = signif)) +
  geom_tile(color = "black") +
  facet_grid(~source) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Response variable") +
  xlab("Term") +
  ggtitle("Decay residuals explained by diversity")
p2

pdf(file = "output/tables/diversitySummary.pdf", width = 8, height = 8)
grid.arrange(p1, p2)
dev.off()


```


Plot the relationship between Saprotroph richness and beta, t60
```{r}
p <- makefig__saproRichDecayResids(taxAndFunguild, comm.otu, traitResiduals.code, code.respVars)
p
ggsave(filename = "output/figures/richness_sapro_decayResids.pdf", width = 5, height = 3.5)

```

Higher saprotroph richness leads to smaller beta and t70 values (i.e. faster mass loss) than would be expected based on wood traits alone, especially in large stems.

Plot the relationship between OTU richness, basidio richness and residuals of pmr at time25
```{r}
p <- makefig__richPMRResids(taxAndFunguild, comm.otu, traitResiduals.stem, stem.respVars) 
p
ggsave(filename = "output/figures/richness_PMRResids.pdf", width = 5, height = 3.5)
```

In small stems, more OTU richness is associated with less mass remaining after 25 months than would be expected based on wood traits alone. This relationship looks heavily influenced by 1 outlier w/ high OTU (and basidio) richness


Plot the relationship between Pathotroph OTU richness and residuals of pmr at time37
```{r}
p <- makefig__path_richPMRResids(taxAndFunguild, comm.otu, traitResiduals.stem, stem.respVars)
p
ggsave(filename = "output/figures/richness_patho_time37Resids.pdf", width = 5, height = 3.5)

```


In small stems, more pathotroph OTUs is associated with less mass remaining after 37 months than would be expected based on wood traits alone.

