---
title: "Does chemistry or community better predict mass loss?"
date: "10/23/2017"
output: github_document
---


```{r, echo=FALSE, message=FALSE}
#chunk options
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)

#libraries
library(knitr) #r markdown
library(readr) #read/write
library(magrittr) #data formatting
library(tidyr) #data formatting
library(dplyr) #data formatting
library(ggplot2) #plotting
library(grid) #plotting
devtools::install_github("cornwell-lab-unsw/litterfitter") #fit decay models to timeseries
library(litterfitter) #fit decay models to timeseries
library(lmtest) # for coxtest()
library(vegan) #diversity metrics
library(rioja) #WA-PLS

#library(colorspace)
#library(gridExtra)

#fxns
source("code/summaryTable_fxns.R")
source("code/analysisDF_fxns.R")

#source("code/distance_fxns.R")
#source("code/otuIDs_fxns.R")

```

### Load microbial community data
```{r, echo=FALSE}
source("code/load_microbeData_fxns.R")

#stem sample meta data
#stemSamples<-load_stemSamples() #uncomment if the data changes
#write_csv(stemSamples, "derived_data/stemSamples.csv")
stemSamples<-read_csv("derived_data/stemSamples.csv")

#OTU table
#fung.otu<-load_matotu() #uncomment if the data changes
#comm.otu<-add_oomycetes(fung.otu) #add the oomycetes #uncomment if the data changes
#write.csv(comm.otu, "derived_data/comm_otu.csv")
comm.otu<-read.csv("derived_data/comm_otu.csv", row.names=1)
#plot_sampleEffortCurves(comm.otu) #this takes a while... uncomment if the data changes

#create sequence sample meta data table
#seqSamples<-load_seqSamples(comm.otu, stemSamples) #uncomment if the data changes
#write_csv(seqSamples, "derived_data/seqSamples.csv")
seqSamples<-read_csv("derived_data/seqSamples.csv")

#taxon lookup info
#taxAndFunguild<-load_TaxAndFunguild(comm.otu) #uncomment if the data changes
#write_csv(taxAndFunguild, "derived_data/taxaAndFunguild.csv")
taxAndFunguild<-read_csv("derived_data/taxaAndFunguild.csv")

```

### Load wood trait data
```{r, echo=FALSE}
source("code/load_traitData_fxns.R")

# species+size-level trait data
#traits.mean<-mergeTraitData() #uncomment if the data changes
#write_csv(traits.mean, "derived_data/traits_code.csv") 
traits.code<-read_csv("derived_data/traits_code.csv")

# stem-level trait data
#traits.codeStem<-mergeTraitData_byStem() #uncomment if the data changes
#write_csv(traits.codeStem, "derived_data/traits_stem.csv")
traits.stem<-read_csv("derived_data/traits_stem.csv")
```

### Load decay data
```{r}
source("code/load_decayData_fxns.R")

# load mass loss data and calculate percent mass remaining (pmr)
#initial_mass <- read_in_initial_mass() #uncomment if the data changes
#harvest_mass<-LoadHarvestFiles()
#pmr<-Calc_massRemaining(initial_mass, harvest_mass)
#write.csv(pmr,"derived_data/pmr.csv")
pmr<-read.csv("derived_data/pmr.csv", row.names=1)

# average pmr for each stem and timepoint
pmr_byStem<-AvgPMR_byStem(pmr)

# calculate decay trajectory fits for each species+size
#decayfits <- fit_all_curves(pmr, stemSamples) #this recalculates all the curve fits, uncomment if the data changes
#write_csv(decayfits,"derived_data/decayfits.csv")
decayfits <- read_csv("derived_data/decayfits.csv")

# ggplot(decayfits,aes(x=t70,y=w.t70,col=size))+
#   geom_point()+
#   labs(x="Time to 30% mass loss (negative exponential)", 
#        y="Time to 30% mass loss (Weibull)")+
#   geom_abline(slope=1,intercept=0,linetype="dashed")+theme_bw()

rm(pmr_df)

```

Figure 1. Wood species x decay params
```{r}

#make plot of decay params by wood species
decayfits.p<-left_join(decayfits, stemSamples)

# t70
p.t70<-ggplot(decayfits.p, aes(x=reorder(Binomial, -t70), y=t70, shape=size)) + 
  geom_point() +
  #geom_errorbar(aes(ymin=t70.lower, ymax=t70.upper)) +
  coord_flip() +
  xlab("Wood species") + ylab("Time to 70% mass remaining (years)") + theme_bw() +
  scale_shape_manual(values=c('large'=19, 'small'=1)) + 
  guides(shape=F) + 
  theme(plot.margin = unit(c(0,1,0,0), "lines"))

# k
p.k<-ggplot(decayfits.p, aes(x=reorder(Binomial, -t70), y=k, shape=size)) + 
  geom_point() +
  geom_errorbar(aes(ymin=k.lower, ymax=k.upper)) +
  coord_flip() +
  xlab("Wood species") + ylab("k (year^-1)") + theme_bw() +
  scale_shape_manual(values=c('large'=19, 'small'=1)) + 
  guides(shape=F) +
  theme(axis.text.y = element_blank(), 
            axis.ticks.y = element_blank(), 
            axis.title.y = element_blank(),
            plot.margin = unit(c(0,1,0,0), "lines"),
            plot.background = element_blank())

# ne.r2
p.r2<-ggplot(decayfits.p, aes(x=reorder(Binomial, -t70), y=ne.r2, shape=size)) + 
  geom_point() +
  coord_flip() +
  xlab("Wood species") + ylab("Neg. expon. R2") + theme_bw() +
  scale_shape_manual(values=c('large'=19, 'small'=1)) + 
  guides(shape=F) +
  theme(axis.text.y = element_blank(), 
            axis.ticks.y = element_blank(), 
            axis.title.y = element_blank(),
            plot.margin = unit(c(0,1,0,0), "lines"),
            plot.background = element_blank())

pdf("output/decayfits.pdf", width=10, height=6)
grid.newpage()
grid.draw(cbind(ggplotGrob(p.t70), ggplotGrob(p.k), ggplotGrob(p.r2), size = "last"))
dev.off()

rm(p.t70, p.k, p.r2)

```

Figure 2. Time x percent mass remaining by wood species
```{r}

#make a long version of pmr.byStem.df.w
pmr_byStem %>%
  gather(key="time",value="mean.pmr", 4:8, na.rm=TRUE) %>%
  separate(time, into=c("drop","timeNum"), sep="time") %>%
  mutate(timeNum=as.numeric(timeNum)) %>%
  mutate(species=tolower(code)) %>%
  mutate(size = case_when(code == species ~ "small", 
                          code != species ~ "large")) %>%
  select(-drop) -> pmr.byStem.df

#order the wood species by t70 to match species order in previous figure
woodSp.o<-levels(reorder(decayfits.p$species, -decayfits.p$t70))
pmr.byStem.df$species<-factor(pmr.byStem.df$species, levels=rev(woodSp.o))

p.pmrBystem<-ggplot(pmr.byStem.df, aes(x=timeNum, y=mean.pmr*100, group=codeStem, linetype=size)) + 
  geom_line() + facet_wrap(~species) +
  xlab("Time (years)") + ylab("Mass remaining (%)") + theme_bw() +
  scale_linetype_manual(values=c(2,1)) + guides(linetype=FALSE)

pdf("output/pmr_byStem.pdf", width=6, height=6)
p.pmrBystem
dev.off()

rm(decayfits.p, woodSp.o, p.pmrBystem, pmr.byStem.df)

```


##########################################

# Wood traits as a predictor

We expect initial wood traits will explain varitation in species+size decay rate (k and t70), species+size lagginess (alpha), and stem-level percent mass remaining at 7, 13, 25, and 37 months of decay. Specifically, we expect samples with (a) high water percent, (b) low density and total C, (c) high macro and micro nutrients, and (d) thicker bark (potential mech: limiting microbial colonization) to have faster decay and less lagginess. 

## *Hyp (species+size-level)* Species+size-level initial wood traits will predict variation decay rates and lagginess.
```{r, include=FALSE}

#merge traits and response variables into 1 df
decayfits %>%
  select(code, species, size, ne.r2, k, t70, alpha) %>%
  left_join(traits.code) %>% 
  filter(!is.na(P)) %>%
  filter(!is.na(waterperc)) -> decayfits.traits

#set up full models
respVars <- list("k","t70","ne.r2")
rhs <- "size + waterperc + density + barkthick + P + K + Ca + Mn + Fe + Zn + N + C"
mod.full.list<-lapply(respVars, ModelFit_manyYs, rhs, curr.data=decayfits.traits) # summaryTable_fxns.R

#do stepwise model selection
mod.select.list<-lapply(mod.full.list, function(x) {
  x.updated<-update(x, . ~ ., data = model.frame(x)) 
  mod.select<-step(x.updated, direction="backward")
  return(mod.select)
  })

#summarize the best models
prettyTab <- MakeLmSummaryTable(respvars=unlist(respVars), mod.list=mod.select.list, termorder="codeTraits") # summaryTable_fxns.R
prettyTab
write.csv(prettyTab, "output/traitsummary_code.csv")

#extract and save the residuals
dataset.list<-rep(list(decayfits.traits), length(respVars))
names(mod.select.list)<-respVars
traitResiduals.code<-ExtractResids(mod.list=mod.select.list, dataset.list=dataset.list, sampleName = "code") # summaryTable_fxns.R

rm(mod.full.list, mod.select.list, 
   prettyTab, decayfits.traits)

```

## *Hyp (stem-level)* Stem-level initial wood traits will predict variation in percent mass loss at each time step.

First, we need to decide what trait data (and samples) to include in this analysis since we don't have full coverage of stem-level trait data. 
Density and bark thickness were only measured on small sized stems.  If there is not be very much within-species variation in these traits that contribute to variation in percent mass loss than we can justify including species-level estimates of these traits in the stem-level model. 

Plot the small-sized stem-level measures of density and barkthick
```{r, echo=FALSE}

# prep a dataset with pmr, stem-level and code-level density and barkthick
traits.stem %>%
  filter(size=="small") %>%
  select(codeStem, code, density, barkthick) %>%
  filter(!is.na(density) & !is.na(barkthick)) %>%
  rename("density_stem"="density",
         "barkthick_stem"="barkthick") -> db.stem
traits.code %>%
  filter(size=="small") %>%
  select(code, density, barkthick) %>%
  filter(!is.na(density) & !is.na(barkthick)) %>%
  rename("density_code"="density",
         "barkthick_code"="barkthick") -> db.code
db.stem %>%
  left_join(db.code) %>%
  left_join(pmr_byStem) -> db.df

# look at the within-species variation in density and barkthick
p.denVar<-ggplot(db.df, aes(x=reorder(code, density_code), y=density_stem)) + 
  geom_point(pch=1) + theme_bw() + coord_flip() +
  xlab("Wood species") + ylab("Density (g/cm3)")
p.barVar<-ggplot(db.df, aes(x=reorder(code, barkthick_code), y=barkthick_stem)) + 
  geom_point(pch=1) + theme_bw() + coord_flip() +
  xlab("Wood species") + ylab("Bark thickness (mm)") +
  theme(axis.text.y = element_blank(), 
            axis.ticks.y = element_blank(), 
            axis.title.y = element_blank(),
            plot.margin = unit(c(0,1,0,0), "lines"),
            plot.background = element_blank())

pdf("output/variation_densityNbarkthick.pdf", width=8, height=6)
grid.newpage()
grid.draw(cbind(ggplotGrob(p.denVar), ggplotGrob(p.barVar), size = "last"))
dev.off()

rm(db.stem, db.code, p.denVar, p.barVar)

```

Compare model fits (r2) using stem and species-level data to identify how much information about percent mass remaining is lost by using species-level estimates...For density, it looks like stem-level data improves model fit a tiny bit for early percent mass remaining time points (after 7 and 13 months) but not later time points. For barkthickness, fits are about the same.
```{r, echo=FALSE}

#set up models
respVars <- list("time7", "time13", "time25", "time37")
mod.stem_density.list <- lapply(respVars, ModelFit_manyYs, rhs="density_stem", curr.data=db.df) # summaryTable_fxns.R
mod.code_density.list <- lapply(respVars, ModelFit_manyYs, rhs="density_code", curr.data=db.df) # summaryTable_fxns.R
mod.stem_barkthick.list <- lapply(respVars, ModelFit_manyYs, rhs="barkthick_stem", curr.data=db.df) # summaryTable_fxns.R
mod.code_barkthick.list <- lapply(respVars, ModelFit_manyYs, rhs="barkthick_code", curr.data=db.df) # summaryTable_fxns.R

#cox test to compare non-nested models
#Do_coxTests(mod.stem_density.list, mod.code_density.list, respvars=unlist(respVars))
#Do_coxTests(mod.stem_barkthick.list, mod.code_barkthick.list, respvars=unlist(respVars))

#compare model r2s
density.r2s<-Do_compareR2(mod.stem_density.list, mod.code_density.list, respvars=unlist(respVars))
barkthick.r2s<-Do_compareR2(mod.stem_barkthick.list, mod.code_barkthick.list, respvars=unlist(respVars))
density.r2s %>%
  rename('density_code_r2'='code.r2s',
         'density_stem_r2'='stem.r2s') %>%
  left_join(barkthick.r2s) %>%
  rename('barkthick_code_r2'='code.r2s',
         'barkthick_stem_r2'='stem.r2s') -> compare.r2.Tab
compare.r2.Tab
write.csv(compare.r2.Tab, file="output/smallsize_codeVstem_r2s.csv")

rm(db.df, mod.stem_density.list, mod.code_density.list, mod.stem_barkthick.list, mod.code_barkthick.list,
   density.r2s, barkthick.r2s, compare.r2.Tab)

```

Compile a "stem-level" dataframe with (a) stem-level percent mass remaining values, (b) stem-level traits including waterperc and chemistry along, and (c) small species-level density and bark thickness data. 
```{r, include=FALSE}

# create dataframes
# stem-level waterperc, xrf, and CN and (small) species-level barkthickness and density
datasets<-lapply(respVars, function(x) {
  result<-CreateTraitPMRpair(x, traits.stem, traits.code, pmr_byStem) #analysisDF_fxns.R
  return(result)
})
names(datasets)<-respVars

#set up full models
rhs <- "size + waterperc + density_smspp + barkthick_smspp + P + K + Ca + Mn + Fe + Zn + N + C"
lhs <- "curr.pmr"
mod.full.list<-lapply(datasets, function(x) {
  result<-ModelFit_manyYs(y=lhs, rhs=rhs, curr.data=x)
  return(result)
})

#do stepwise model selection
mod.select.list<-lapply(mod.full.list, function(x) {
  x.updated<-update(x, . ~ ., data = model.frame(x)) 
  mod.select<-step(x.updated, direction="backward")
  return(mod.select)
  })

#summarize the best models
prettyTab <- MakeLmSummaryTable(respvars=unlist(respVars), mod.list=mod.select.list, termorder="stemTraits") # summaryTable_fxns.R
prettyTab
write.csv(prettyTab, "output/traitsummary_stem.csv")

#extract and save the residuals
traitResiduals.stem<-ExtractResids(mod.list=mod.select.list, dataset.list=datasets, sampleName = "codeStem") # summaryTable_fxns.R

rm(dataset.list, datasets, lhs, rhs, mod.full.list, mod.select.list, respVars, prettyTab)

```



##########################################

# Community as a predictor

Filter community matrix to include only taxa that are present in a least 20% of all the samples. This step removes taxa that may not contribute much to our understanding of the relationship between species’ multivariate abundance and environment.
```{r, echo=FALSE}

minSamps<-floor(dim(comm.otu)[1] * .2) #how many samples is 20% of them?
dat1 <- apply(comm.otu>0, 2, sum) #how many samples does each OTU show up in?
comm.otu.trimmed <- comm.otu[,dat1>minSamps]

paste("Keep", dim(comm.otu.trimmed)[2], "of", dim(comm.otu)[2], "OTUs")

rm(minSamps, dat1)

```

## *Hyp (species+size-level)* Species+size-level (average) initial microbial community composition will predict variation in decay model fit (r2), rate (t70, k), and lagginess (alpha).
```{r, include=FALSE, results=FALSE, message=FALSE}

#average OTU abundances by code
codeOTUabund<-AverageOTUabund_byCode(comm.otu, seqSamples) #analysisDF_fxns.R
codeOTUabund.trim<-AverageOTUabund_byCode(comm.otu.trimmed, seqSamples) #analysisDF_fxns.R

#get rid of decayfits rows for which there is missing community data... this is eusc
#decayfits[!decayfits$code %in% row.names(codeOTUabund),]$code
decayfits.trim<-decayfits[decayfits$code %in% row.names(codeOTUabund),]

#fit models
respVars <- list(t70 = decayfits.trim$t70,
                 k = decayfits.trim$k,
                 ne.r2 = decayfits.trim$ne.r2)
cvfit.notrim<-lapply(respVars, function(x) {fitNcrossval_WAPLS(curr.comm = codeOTUabund, curr.respVar = x)}) #analysisDF_fxns.R
cvfit.trim<-lapply(respVars, function(x) {fitNcrossval_WAPLS(curr.comm = codeOTUabund.trim, curr.respVar = x)}) #analysisDF_fxns.R

#perform randomization t-test to test the significance of a cross-validated model
wapls.out.notrim<-lapply(cvfit.notrim, rand.t.test)
wapls.out.trim<-lapply(cvfit.trim, rand.t.test)

#make summary table
prettyTab.notrim<-MakeSummaryTable_comcomp(wapls.out=wapls.out.notrim, respvars=names(respVars))
prettyTab.trim<-MakeSummaryTable_comcomp(wapls.out=wapls.out.trim, respvars=names(respVars))
prettyTab.notrim$trim<-"no"
prettyTab.trim$trim<-"yes"
prettyTabs.code<-rbind(prettyTab.trim, prettyTab.notrim)

rm(decayfits.trim, respVars, 
   cvfit.notrim, cvfit.trim, 
   wapls.out.notrim, wapls.out.trim, 
   prettyTab.notrim, prettyTab.trim)

```

## *Hyp (stem-level)* Stem-level initial microbial communitiy compositions will predict variation in percent mass loss, particularly in the early stages of decay.
```{r, include=FALSE}

respVars <- list("time7", "time13", "time25", "time37")

# create dataframes
datasets.notrim<-lapply(respVars, function(x) {CreateCommPMRpair(x, comm.mat=comm.otu, pmr_byStem)} ) #analysisDF_fxns.R
names(datasets.notrim)<-unlist(respVars)
datasets.trim<-lapply(respVars, function(x) {CreateCommPMRpair(x, comm.mat=comm.otu.trimmed, pmr_byStem)} ) #analysisDF_fxns.R
names(datasets.trim)<-unlist(respVars)

#fit models
cvfit.notrim<-lapply(datasets.notrim, function(x) {fitNcrossval_WAPLS(curr.comm = x[['comm']], curr.respVar = x[['pmr']][['curr.time']])})
cvfit.trim<-lapply(datasets.trim, function(x) {fitNcrossval_WAPLS(curr.comm = x[['comm']], curr.respVar = x[['pmr']][['curr.time']])})

#perform randomization t-test to test the significance of a cross-validated model....
wapls.out.notrim<-lapply(cvfit.notrim, rand.t.test)
wapls.out.trim<-lapply(cvfit.trim, rand.t.test)

#make summary table
prettyTab.notrim<-MakeSummaryTable_comcomp(wapls.out=wapls.out.notrim, respvars=unlist(respVars))
prettyTab.trim<-MakeSummaryTable_comcomp(wapls.out=wapls.out.trim, respvars=unlist(respVars))
prettyTab.notrim$trim<-"no"
prettyTab.trim$trim<-"yes"
prettyTabs.stem<-rbind(prettyTab.trim, prettyTab.notrim)

# merge code and stem-level summary tables
tmp<-left_join(prettyTabs.code, prettyTabs.stem)
commTab<-tmp[,c("trim","stat","t70","k","ne.r2",unlist(respVars))]
commTab
write.csv(commTab, file="output/commcompsummary.csv")

rm(datasets.notrim, datasets.trim,
   respVars, 
   tmp, commTab,
   wapls.out.notrim, wapls.out.trim, 
   prettyTab.notrim, prettyTab.trim,
   prettyTabs.code, prettyTabs.stem)

```
Comp01 (of the non-trimmed community) is a significant predictor of percent mass remaining at 37 months. This is likely an underlying signature of wood traits on the initial microbial community that is driving the relationship between the community and the mass remaining after 37 months.  Check this out by plotting OTU trait-associated coefs (from boral) versus component coef estimate.

Plot of OTU functional and phylogenetic categories versus signif WA-PLS score.  Remember that higher WA-PLS scores are associated more more mass remaingin after 37 months.
```{r, echo=FALSE, message=FALSE, warning=FALSE}

coef.comp <- cvfit.notrim$time37$coefficients[,'Comp01']
coef.comp.df <- data.frame(OTUId=names(coef.comp), coefComp=coef.comp)

#create df of OTU taxon and guild info matched with coef value
coef.comp.df %>% left_join(taxAndFunguild) -> coef.comp.ann

#shorten x axis labels
orgNames<-levels(factor(coef.comp.ann$Trophic.Mode))
newNames<-gsub('troph', '', orgNames)
coef.comp.ann %>% mutate(Trophic.Mode.short = factor(Trophic.Mode, labels = newNames)) -> coef.comp.ann

p.troph<-ggplot(coef.comp.ann, aes(x=Trophic.Mode.short, y=coefComp)) + 
  geom_jitter(alpha=.5, pch=16) +
  xlab("Trophic mode") + ylab("Component coefficient estimate") +
  theme_classic() +
  geom_hline(yintercept=0, linetype=2) +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

p.king<-ggplot(coef.comp.ann, aes(x=kingdom, y=coefComp)) + 
  geom_jitter(alpha=.5) + 
  xlab("Kingdom") + ylab("Component coefficient estimate") +
  theme_classic() +
  geom_hline(yintercept=0, linetype=2) +
  theme(axis.text.y = element_blank(), 
            axis.ticks.y = element_blank(), 
            axis.title.y = element_blank(),
            plot.margin = unit(c(0,1,0,0), "lines"),
            plot.background = element_blank(),
        axis.text.x = element_text(angle = 70, hjust = 1))

p.phylum<-ggplot(coef.comp.ann, aes(x=phylum, y=coefComp)) + 
  geom_jitter(alpha=.5) + 
  xlab("Phylum") + ylab("Component coefficient estimate") +
  theme_classic() +
  geom_hline(yintercept=0, linetype=2) +
  theme(axis.text.y = element_blank(), 
            axis.ticks.y = element_blank(), 
            axis.title.y = element_blank(),
            plot.margin = unit(c(0,1,0,0), "lines"),
            plot.background = element_blank(),
        axis.text.x = element_text(angle = 70, hjust = 1))

pdf("output/signif_wapls_otuCats.pdf", width=10, height=6)
grid.newpage()
grid.draw(cbind(ggplotGrob(p.troph), ggplotGrob(p.king), ggplotGrob(p.phylum), size = "last"))
dev.off()

rm(coef.comp.df, coef.comp, newNames, orgNames, p.king, p.phylum, p.troph)

```

Plot OTU wood trait estimates (from boral) versus signif WA-PLS score.
```{r, echo=FALSE}

xVar.df<-read.csv("data/xVar_OTUcoefs.csv", row.names=1) #import wood trait coefs estimated by boral in the wooddecay repo

xVar.df %>%
  left_join(coef.comp.ann) %>% # left join is going to drop the oomycetes that weren't included in the boral analysis
  filter(runNum=="runNum1") -> tmp.df #just look at the first model run estimates

# look at the wood traits included in the best model to explain pmr at 37 months
read.csv("output/traitsummary_stem.csv")
# larger size stems, less water content, less thick bark, more C, more P, more Mn
# size was included as a roweffect in the boral model, so there are no OTU-specific estimates

tmp.df %>%
  select(OTUId, phylum, Trophic.Mode, coefComp, waterperc, barkthick, P) %>%
  gather(key="trait", value="coefEst", -(1:4)) %>%
  arrange(-coefComp) -> tmp.df1

p<-ggplot(tmp.df1, aes(x=coefComp, y=coefEst)) + 
  geom_point() + theme_bw() +
  ylab("Assoc. w/ more mass at 37 mo. (WA-PLS score)") + 
  xlab("Wood trait response (boral coef estimate)") +
  facet_grid(phylum~ trait)

pdf("output/signif_wapls_otuBoral.pdf", width=6, height=6)
p
dev.off()

rm(xVar.df, tmp.df, tmp.df1, p,
   cvfit.notrim, cvfit.trim)

```
When looking at these barkthickness OTU coefs, remember that the boral model was fit based on small species-level bark thickness data...The asco response to barkthickness seems to be driving the WA-PLS association. 



##########################################

# Community+traits as a predictor

## *Hyp (species+size-level)* After accounting for variation in decay due to wood traits, average initial microbial communitiy compositions will predict variation in decay model fit (r2), rate (t70, k), and lagginess (alpha).
```{r, include=FALSE, results=FALSE, message=FALSE}
#run rioja::WAPLS on wood trait residuals

#average OTU abundances by code
#codeOTUabund
#codeOTUabund.trim

#unique(traitResiduals.code$resp)
respVars <- list("k","t70","ne.r2")

# create dataframes
datasets.notrim<-lapply(respVars, function(x) {
  CreateCommTraitResidpair(respVar=x, 
                           comm.mat=codeOTUabund, 
                           traitResiduals = traitResiduals.code,
                           sampleName = "code")} ) #analysisDF_fxns.R
names(datasets.notrim)<-unlist(respVars)
datasets.trim<-lapply(respVars, function(x) {
  CreateCommTraitResidpair(respVar=x, 
                           comm.mat=codeOTUabund.trim, 
                           traitResiduals = traitResiduals.code,
                           sampleName = "code")} ) #analysisDF_fxns.R
names(datasets.trim)<-unlist(respVars)

#fit models
cvfit.notrim<-lapply(datasets.notrim, function(x) {
  fitNcrossval_WAPLS(curr.comm = x[['comm']], 
                     curr.respVar = x[['traitresid']][['resid']])
  })
cvfit.trim<-lapply(datasets.trim, function(x) {
  fitNcrossval_WAPLS(curr.comm = x[['comm']], 
                     curr.respVar = x[['traitresid']][['resid']])
  })

#perform randomization t-test to test the significance of a cross-validated model....
wapls.out.notrim<-lapply(cvfit.notrim, rand.t.test)
wapls.out.trim<-lapply(cvfit.trim, rand.t.test)

#make summary table
prettyTab.notrim<-MakeSummaryTable_comcomp(wapls.out=wapls.out.notrim, respvars=unlist(respVars))
prettyTab.trim<-MakeSummaryTable_comcomp(wapls.out=wapls.out.trim, respvars=unlist(respVars))
prettyTab.notrim$trim<-"no"
prettyTab.trim$trim<-"yes"
prettyTabs.code<-rbind(prettyTab.trim, prettyTab.notrim)

rm(respVars, datasets.notrim, datasets.trim, cvfit.notrim, cvfit.trim, wapls.out.notrim, wapls.out.trim, 
   prettyTab.notrim, prettyTab.trim)

```

## *Hyp (stem-level)* After accounting for variation in decay due to wood traits (no models with density, includes small-species level bark thickness), stem-specific initial microbial communitiy compositions will predict variation in percent mass loss, particularly in the early stages of decay.
```{r, include=FALSE, results=FALSE, message=FALSE}
#run rioja::WAPLS on wood trait residuals

respVars <- list("time7", "time13", "time25", "time37")

# create dataframes
datasets.notrim<-lapply(respVars, function(x) {
  CreateCommTraitResidpair(respVar=x, 
                           comm.mat=comm.otu, 
                           traitResiduals = traitResiduals.stem,
                           sampleName = "codeStem")} ) #analysisDF_fxns.R
names(datasets.notrim)<-unlist(respVars)
datasets.trim<-lapply(respVars, function(x) {
  CreateCommTraitResidpair(respVar=x, 
                           comm.mat=comm.otu.trimmed, 
                           traitResiduals = traitResiduals.stem,
                           sampleName = "codeStem")} ) #analysisDF_fxns.R
names(datasets.trim)<-unlist(respVars)

#fit models
cvfit.notrim<-lapply(datasets.notrim, function(x) {
  fitNcrossval_WAPLS(curr.comm = x[['comm']], 
                     curr.respVar = x[['traitresid']][['resid']])
  })
cvfit.trim<-lapply(datasets.trim, function(x) {
  fitNcrossval_WAPLS(curr.comm = x[['comm']], 
                     curr.respVar = x[['traitresid']][['resid']])
  })

#perform randomization t-test to test the significance of a cross-validated model....
wapls.out.notrim<-lapply(cvfit.notrim, rand.t.test)
wapls.out.trim<-lapply(cvfit.trim, rand.t.test)

#make summary table
prettyTab.notrim<-MakeSummaryTable_comcomp(wapls.out=wapls.out.notrim, respvars=unlist(respVars))
prettyTab.trim<-MakeSummaryTable_comcomp(wapls.out=wapls.out.trim, respvars=unlist(respVars))
prettyTab.notrim$trim<-"no"
prettyTab.trim$trim<-"yes"
prettyTabs.stem<-rbind(prettyTab.trim, prettyTab.notrim)

#Notes about how to interpret WA-PLS...
#rand.t.test(fit.tr.t13.cv.nt) # comp2 has a signif pval, but...
#screeplot(fit.tr.t13.cv.nt)
#There are two cases where there's a large % decrease in model RMSE from Component 1 to Component 2. This happens when using the whole community dataset to predict trait residuals at time13 and time37. In both cases the cross-validated RMSE is way higher than the model RMSE for all the components, suggesting that even the first community component doesn't perform well on the leave-one-out validation dataset.  Also, the cross-validated R-squared values (correlation between the observed and predicted values from the "loo" validation dataset) show that the model fit decreases after Component 1.  If there were a global maximum such that we saw an increase in R2 after adding more Components then maybe we could interpret Component 2, but there is no evidence of a better fitting model with more components based on the cross-validation results.

# merge code and stem-level summary tables
tmp<-left_join(prettyTabs.code, prettyTabs.stem)
commTab<-tmp[,c("trim","stat","t70","k","ne.r2",unlist(respVars))]
commTab
write.csv(commTab, file="output/commcompsummary_traitresid.csv")

rm(respVars, datasets.notrim, datasets.trim, cvfit.notrim, cvfit.trim, wapls.out.notrim, wapls.out.trim, 
   prettyTab.notrim, prettyTab.trim,
   prettyTabs.code, prettyTabs.stem,
   tmp, commTab)

```



##########################################

# Diversity (and diversity of specific clades) as a predictor  

**Note that the full community matrix was used for these analyses**

## *Hyp-a (species+size-level)* Greater microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will lead to better-fitting decay models (ne.r2), faster decay (k), and less lagginess (alpha) because of the selection effect for fast decayers and complementarity among taxa for decay.  
Hyp-Alt: Greater microbial diversity will lead to worse-fitting decay models (ne.r2), slower decay (k), and more lagginess (alpha) because taxa will be allocating more of their resources to combat one another.
## *Hyp-b (species+size-level)* Greater saprotroph and basidiomycete richness will lead to better-fitting decay models (ne.r2), faster decay (k), and less lagginess (alpha) because the community does not need to wait for the arrival of key decayers to act on the wood substrate.  
Hyp-Alt: Greater saprotroph and basidiomycete richness will lead to worse-fitting decay models (ne.r2), slower decay (k), and more lagginess (alpha) because decayers will be allocating more of their resources to combat one another.
## *Hyp-c (species+size-level)* Greater pathogen and oomycete richness will lead to worse-fitting decay models (ne.r2), slower decay (k), and more lagginess (alpha) because the presence of these organisms will inhibit the establishment and activity of decayers.
```{r, echo=FALSE}

# summarize the diversity in each sample
rich.df<-Calc_richOTU(taxAndFunguild, comm.otu)
H.df<-Calc_H.OTU(taxAndFunguild, comm.otu)
sapro.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Sapro", taxAndFunguild, comm.otu=comm.otu)  
basidio.df<-Calc_richOTUtype(colNam="phylum", grepTerm="Basid", taxAndFunguild, comm.otu=comm.otu)
path.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Patho", taxAndFunguild, comm.otu=comm.otu)
oomy.df<-Calc_richOTUtype(colNam="kingdom", grepTerm="Protist", taxAndFunguild, comm.otu=comm.otu) # have to do this with the full community matrix because there are so few of these guys
richList<-list(rich.df, H.df, sapro.df, basidio.df, path.df, oomy.df)
richNames<-c("Richness","ShannonsH","Sapro.rich","Basidio.rich","Patho.rich","Oomy.rich")

#create a set of richness and decay dataframes
rich.decayfits<-lapply(richList, function(x) {CreateRichDecayfits_df(otutype.df=x, decayfits=decayfits)})

# fit models
rhs <- "size + mean"
lhs <- list("t70","k","ne.r2")

richType.list<-list()
for(i in 1:length(rich.decayfits)){
  resp.list<-list()
  for(k in 1:length(lhs)){
    resp.list[[k]]<-ModelFit_manyYs(y = lhs[[k]], rhs = rhs, curr.data = rich.decayfits[[i]]) 
  }
  names(resp.list)<-lhs
  richType.list[[i]]<-resp.list
}
names(richType.list)<-richNames

#summarize
pretty.list<-lapply(richType.list, MakeSummaryTable_diversity, respvars=lhs)
summ<-lapply(pretty.list, function(x){
  selectrows<-c("mean","numdf","dendf","r.squared")
  x.df<-x[x$term %in% selectrows & !is.na(x$term),]
  x.df$term<-c("estim.se","numdf","dendf","r.squared")
  colnames(x.df)[1]<-"valueType"
  return(x.df)
} )
summ.df<-bind_rows(summ, .id="variable")
summ.df

write.csv(summ.df, file="output/diversitysummary_code.csv")

rm()


```


## *Hyp-a (stem-level)* Greater microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will lead to less mass remaining esp. at early time steps because of the selection effect for fast decayers and complementarity among taxa for decay.  
Hyp-Alt: Greater microbial diversity will lead to more mass remaining because taxa will be allocating more of their resources to combat one another.
## *Hyp-b (stem-level)* Greater saprotroph and basidiomycete richness will lead to less mass remaining esp. at early time steps because the community does not need to wait for the arrival of key decayers to act on the wood substrate.  
Hyp-Alt: Greater saprotroph and basidiomycete richness will lead to more mass remaining because decayers will be allocating more of their resources to combat one another.
## *Hyp-c (stem-level)* Greater pathogen and oomycete richness will lead to more mass remaining because the presence of these organisms will inhibit the establishment and activity of decayers.
```{r, echo=FALSE, include=FALSE}

# summarize the diversity in each sample
rich.df<-Calc_richOTU(taxAndFunguild, comm.otu) #codeStem rows that need to be excluded because it just used the seq_sampName information....this will get fixed in the next step
H.df<-Calc_H.OTU(taxAndFunguild, comm.otu)
sapro.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Sapro", taxAndFunguild, comm.otu=comm.otu)  
basidio.df<-Calc_richOTUtype(colNam="phylum", grepTerm="Basid", taxAndFunguild, comm.otu=comm.otu)
patho.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Patho", taxAndFunguild, comm.otu=comm.otu)  
oomy.df<-Calc_richOTUtype(colNam="kingdom", grepTerm="Protist", taxAndFunguild, comm.otu=comm.otu)

# create a merged df with pmr
rich.pmr<-left_join(pmr.byStem.df.w, rich.df) %>% filter(!is.na(seq_sampName))
H.pmr<-left_join(pmr.byStem.df.w, H.df) %>% filter(!is.na(seq_sampName))
sapro.pmr<-left_join(pmr.byStem.df.w, sapro.df) %>% filter(!is.na(seq_sampName))
basidio.pmr<-left_join(pmr.byStem.df.w, basidio.df) %>% filter(!is.na(seq_sampName))
patho.pmr<-left_join(pmr.byStem.df.w, patho.df) %>% filter(!is.na(seq_sampName))
oomy.pmr<-left_join(pmr.byStem.df.w, oomy.df) %>% filter(!is.na(seq_sampName))

# fit models
mod1<-lm(time7~size+sub_rich, data=rich.pmr)
mod2<-lm(time13~size+sub_rich, data=rich.pmr)
mod3<-lm(time25~size+sub_rich, data=rich.pmr)
mod4<-lm(time37~size+sub_rich, data=rich.pmr)
mod.rich<-list(mod1, mod2, mod3, mod4)

mod1<-lm(time7~size+sub_rich, data=H.pmr)
mod2<-lm(time13~size+sub_rich, data=H.pmr)
mod3<-lm(time25~size+sub_rich, data=H.pmr)
mod4<-lm(time37~size+sub_rich, data=H.pmr)
mod.H<-list(mod1, mod2, mod3, mod4)

mod1<-lm(time7~size+sub_rich, data=sapro.pmr)
mod2<-lm(time13~size+sub_rich, data=sapro.pmr)
mod3<-lm(time25~size+sub_rich, data=sapro.pmr)
mod4<-lm(time37~size+sub_rich, data=sapro.pmr)
mod.sapro<-list(mod1, mod2, mod3, mod4)

mod1<-lm(time7~size+sub_rich, data=basidio.pmr)
mod2<-lm(time13~size+sub_rich, data=basidio.pmr)
mod3<-lm(time25~size+sub_rich, data=basidio.pmr)
mod4<-lm(time37~size+sub_rich, data=basidio.pmr)
mod.basidio<-list(mod1, mod2, mod3, mod4)

mod1<-lm(time7~size+sub_rich, data=patho.pmr)
mod2<-lm(time13~size+sub_rich, data=patho.pmr)
mod3<-lm(time25~size+sub_rich, data=patho.pmr)
mod4<-lm(time37~size+sub_rich, data=patho.pmr)
mod.patho<-list(mod1, mod2, mod3, mod4)

mod1<-lm(time7~size+sub_rich, data=oomy.pmr)
mod2<-lm(time13~size+sub_rich, data=oomy.pmr)
mod3<-lm(time25~size+sub_rich, data=oomy.pmr)
mod4<-lm(time37~size+sub_rich, data=oomy.pmr)
mod.oomy<-list(mod1, mod2, mod3, mod4)

#summarize
xVars<-c("Richness","ShannonsH","Sapro.rich","Basidio.rich","Patho.rich","Oomy.rich")
respvars<-unlist(timeList)
mod.list<-list(mod.rich, 
               mod.H,
               mod.sapro,
               mod.basidio,
               mod.patho,
               mod.oomy)
pretty.list<-lapply(mod.list, MakeSummaryTable_diversity, respvars=respvars)
names(pretty.list)<-xVars
summ<-lapply(pretty.list, function(x){
  selectrows<-c("sub_rich","numdf","dendf","r.squared")
  x.df<-x[x$term %in% selectrows & !is.na(x$term),]
  x.df$term<-c("estim.se","numdf","dendf","r.squared")
  colnames(x.df)[1]<-"valueType"
  return(x.df)
} )
names(summ)<-xVars
summ.df<-bind_rows(summ, .id="variable")
summ.df

write.csv(summ.df, file="output/diversitysummary_stems.csv")

```


##############################################

# Diversity plus traits as a predictor

## *Hyp (species+size-level)* After accounting for variation in decay due to wood traits, average initial microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will predict variation in decay model fit (r2), rate (k), and lagginess (alpha).
```{r, echo=FALSE}

#run lm mods on wood trait residuals
mod.rich<-FitResid_diversity(rich.spdf=rich.spdf, trait.residuals)
mod.H<-FitResid_diversity(rich.spdf=H.spdf, trait.residuals)
mod.sapro<-FitResid_diversity(rich.spdf=saprorich.spdf, trait.residuals)
mod.basid<-FitResid_diversity(rich.spdf=basidrich.spdf, trait.residuals)
mod.path<-FitResid_diversity(rich.spdf=pathrich.spdf, trait.residuals)
mod.oomy<-FitResid_diversity(rich.spdf=oomyrich.spdf, trait.residuals)


lapply(mod.rich, anova)
#lapply(mod.H, anova)
#lapply(mod.sapro, anova) #marginally signif alpha
#lapply(mod.basid, anova)
#lapply(mod.path, anova) #marginally signif for alpha
#lapply(mod.oomy, anova)

# summarize
xVars<-c("Richness","ShannonsH","Sapro.rich","Basidio.rich","Patho.rich","Oomy.rich")
respvars<-c("r2","k","t70")
mod.list<-list(mod.rich, 
               mod.H,
               mod.sapro,
               mod.basidio,
               mod.patho,
               mod.oomy)
mod.list
pretty.list<-lapply(mod.list, MakeSummaryTable_diversity, respvars=respvars)
names(pretty.list)<-xVars
summ<-lapply(pretty.list, function(x){
  selectrows<-c("sub_rich","dendf","r.squared")
  x.df<-x[x$term %in% selectrows & !is.na(x$term),]
  x.df$term<-c("estim.se","dendf","r.squared")
  colnames(x.df)[1]<-"valueType"
  return(x.df)
} )
names(summ)<-xVars
summ.df.traitresid<-bind_rows(summ, .id="variable")
summ.df.traitresid

write.csv(summ.df.traitresid, file="output/diversitysummary_stems_traitresid.csv")

```

## *Hyp (stem-level)* After accounting for variation in decay due to wood traits, initial microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will predict variation in percent mass loss, esp. at early time points.
```{r}

# summarize the presence of ... in each sample (same as chunks above)
rich.df<-Calc_richOTU(taxAndFunguild, comm.otu) 
H.df<-Calc_H.OTU(taxAndFunguild, comm.otu)
sapro.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Sapro", taxAndFunguild, comm.otu=comm.otu)  
basidio.df<-Calc_richOTUtype(colNam="phylum", grepTerm="Basid", taxAndFunguild, comm.otu=comm.otu)
patho.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Patho", taxAndFunguild, comm.otu=comm.otu)  
oomy.df<-Calc_richOTUtype(colNam="kingdom", grepTerm="Protist", taxAndFunguild, comm.otu=comm.otu)

# create a merged df with trait residuals
trait.residuals.list<-list(t7=traitResid.t7, 
                           t13=traitResid.t13, 
                           t25=traitResid.t25, 
                           t37=traitResid.t37)

#merge the trait residuals and diversity dataframe
rich.tr.list<-Create_rich_tr_DF(trait.residuals.list, rich.df)
H.tr.list<-Create_rich_tr_DF(trait.residuals.list, H.df)
sapro.tr.list<-Create_rich_tr_DF(trait.residuals.list, sapro.df)
basidio.tr.list<-Create_rich_tr_DF(trait.residuals.list, basidio.df)
patho.tr.list<-Create_rich_tr_DF(trait.residuals.list, patho.df)
oomy.tr.list<-Create_rich_tr_DF(trait.residuals.list, oomy.df)

# fit models
mod.rich<-FitResid_diversity_byStem(rich.tr.list)
mod.H<-FitResid_diversity_byStem(H.tr.list)
mod.sapro<-FitResid_diversity_byStem(sapro.tr.list)
mod.basidio<-FitResid_diversity_byStem(basidio.tr.list)
mod.patho<-FitResid_diversity_byStem(patho.tr.list)
mod.oomy<-FitResid_diversity_byStem(oomy.tr.list)

# summarize
xVars<-c("Richness","ShannonsH","Sapro.rich","Basidio.rich","Patho.rich","Oomy.rich")
respvars<-unlist(timeList)
mod.list<-list(mod.rich, 
               mod.H,
               mod.sapro,
               mod.basidio,
               mod.patho,
               mod.oomy)
pretty.list<-lapply(mod.list, MakeSummaryTable_diversity, respvars=respvars)
names(pretty.list)<-xVars
summ<-lapply(pretty.list, function(x){
  selectrows<-c("sub_rich","dendf","r.squared")
  x.df<-x[x$term %in% selectrows & !is.na(x$term),]
  x.df$term<-c("estim.se","dendf","r.squared")
  colnames(x.df)[1]<-"valueType"
  return(x.df)
} )
names(summ)<-xVars
summ.df.traitresid<-bind_rows(summ, .id="variable")
summ.df.traitresid

write.csv(summ.df.traitresid, file="output/diversitysummary_stems_traitresid.csv")

```


##############################################

# Relationship between wood traits and community

## *Hyp (species+size-level)* Initial microbial communitiy compositions will covary with initial wood traits
```{r}

#stem-level trait set
traits.codeStem %>%
    filter(!is.na(waterperc) & !is.na(P) & !is.na(K) & 
             !is.na(Ca) & !is.na(Mn) & !is.na(Fe) & !is.na(Zn) & !is.na(N) & !is.na(C)) -> curr.traits
  
#add species-level traits, get rid of rows for which there is missing community data
  traits.mean %>%
    select(code, barkthick) %>%
    rename('barkthick_smspp'='barkthick')-> select.traits.mean
  curr.traits %>%
    left_join(select.traits.mean) %>%
    filter(codeStem %in% row.names(comm.otu)) %>%
    select(codeStem, size, waterperc, barkthick_smspp, P, K, Ca, Mn, Fe, Zn, N, C) -> curr.traits

#make sure dimensions of the community matrix match
comm.otu1<-comm.otu[row.names(comm.otu) %in% curr.traits$codeStem,]

#make a envVars matrix for model fitting
envVars<-as.matrix(curr.traits[,-(1:2)])

#fit models
fit.cca <- cca(comm.otu1 ~ envVars)
#fit.cca
#plot(fit.cca)
anova(fit.cca)

```

## *Hyp (code-level)* Average initial microbial communitiy compositions will covary with initial wood traits
```{r, echo=FALSE}

#average OTU abundances by code
meanOTUabund.trim2<-AverageOTUabund_byCode(comm.otu.trimmed, seqSamples)

#get rid of missing data from traits.mean
traits.mean %>%
  filter(!is.na(waterperc)) %>% #get NaN row
  filter(code %in% row.names(meanOTUabund.trim2)) -> traits.mean.trim #get rid of rows for which there is missing community data... this is eusc

#make sure dimensions of the community matrix match
meanOTUabund.trim3<-meanOTUabund.trim2[row.names(meanOTUabund.trim2) %in% traits.mean.trim$code,]

#make a envVars matrix for model fitting
envVars<-as.matrix(traits.mean.trim[,-(1:3)])

#fit models
fit.cca <- cca(meanOTUabund.trim3 ~ envVars)
#fit.cca
#plot(fit.cca)
#anova(fit.cca)


```



##############################################

## Extra pieces

1. *code/testing_time_zero.Rmd* -- Including t=0 points to fit decay model affects the liklihood and the model selection criteria, but the curve fits are identical with this formulation.  Excluding the t=0 fits has an effect of prefering simpler models, which is the same effect as increasing the penalty for model complexity. 

2. *code/initialDist_vs_decayDist_btwCode.Rmd* -- No apparent relationship between species+size dissimilarities in initial microbial community composition (bray and jaccard) and decay trajectory params

3. *code/boralOTUpairs_vs_decay.Rmd* -- No apparent relationship between frequency of boral-ID'd positively/negatively correlated OTU pairs and decay params

4. *code/withinInitialDist_vs_decayR2.Rmd* -- No apparent relationship between initial microbial diversity WITHIN species+size and decay model R2

5. *code/unexpectedTaxa.Rmd* -- Mycorrhizal fungi and animal-associated fungi that somehow made it into our OTU table


