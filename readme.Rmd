---
title: "Community v chemistry -- Recent analyses"
date: "10/23/2017"
output: github_document
---

```{r, include = F}
#chunk options
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

```{r load}
# load libraries and fxns

#libraries
library(knitr) #r markdown
library(readr) #read/write
library(magrittr) #data formatting
library(tidyr) #data formatting
library(dplyr) #data formatting
library(ggplot2) #plotting
library(grid) #plotting
library(gridExtra) #plotting
library(corrplot) #plotting
#devtools::install_github("cornwell-lab-unsw/litterfitter") #fit decay models to timeseries
#library(litterfitter) #fit decay models to timeseries
library(lmtest) # for coxtest()
#library(vegan) #diversity metrics
#library(rioja) #WA-PLS
library(GGally)

#fxns
source('code/helper_fxns.R')
sourceDir('code')

```

## Repo outline

### Main analyses

1. How do wood species and sizes vary in decay?
- script: *decayPatterns.Rmd*
- summary: output/decayfits.pdf
```{r load_massloss}

#---------------------------#
#data

# stems in the study
stemSamples <- load_stemSamples() # this function is in load_microbeData.R

# stem mass
initial_mass <- read_in_initial_mass()
harvest_mass <- LoadHarvestFiles()
pmr <- Calc_massRemaining(initial_mass, harvest_mass) # calculate percent mass remaining (pmr)
pmr_byStem <- AvgPMR_byStem(pmr) # average pmr for each stem and timepoint
stem.respVars <- list("time7", "time13", "time25", "time37","time59")

# decay fits
#decayfits <- fit_all_curves(pmr, stemSamples) #this recalculates all the curve fits, uncomment if the data changes; for each species+size
#write_csv(decayfits,"derived_data/decayfits.csv")
decayfits <- read_csv("derived_data/decayfits.csv")
indx <- unique(stemSamples[,c("code","Binomial","size")])
decayfits %>%
  left_join(indx) -> decayfits
code.respVars <- list("k","t50","ne.r2", "alpha","beta","w.t50","w.r2") # weibull params: alpha = shape param, beta = scale param

#---------------------------#
# main figures and tables

#Fig 1
makefig__decayfits(decayfits) # output/figures/maintext/decayfits.pdf
# why are there no error bars for t50?

#Fig 2
makefig__pmr_byStem(pmr_byStem) # output/figures/maintext/pmr_byStem.pdf


#---------------------------#
# supplementary figures and tables

#Fig S1
makefig__compare_t50_aic(decayfits) # output/figures/supplementary/compare_t50.pdf

```

2. Do wood traits explain decay? 
- script: *woodtraits_explainDecay.Rmd*
- summary: 
    - Fast decayers (alpha) have low density
    - Samples with S-shaped trajectories (beta) have low N and high density
    - Difficult to predict decayers (low r2) have low N, high density, and belong to the small size class
    - Low water content predicts more mass remaining across all time points
    - Low N and small size class predict more mass remaining at early-mid time points
    - High C predicts more mass remaining at late time points
```{r load_woodtraits}

#---------------------------#
#data

#trait.data.l <- mergeTraitData() # all trait data
traits.code <- trait.means_byCode(stemSamples, fill.densitybark = TRUE) # averaged by code; if fill.densitybark == TRUE, then use small stem estimates to approximate large stem density and bark thickness
#trait.sds_byCode(stemSamples) # within code variation
#trait.n_byCode(stemSamples) # number of code samples that were aggregated
traits.stem <- trait.means_byStem(stemSamples) # averaged by codeStem
#trait.sds_byStem(stemSamples) # within codeStem variation
#trait.n_byStem(stemSamples) # number of codeStem samples that were aggregated

#---------------------------#
# main figures and tables

#Fig 3
makefig__traits_explain_decayParams(decayfits, traits.code, 
                                    code.respVars, use.cache = T) # output/figures/maintext/traits_explain_decayparams.pdf
# remove color for R2 and just report that in the figure legend. make this into a horizontal bar plot to show the coef magnitudes

#Fig 4
makefig__traits_explain_pmr(traits.stem, traits.code, pmr_byStem, 
                            stem.respVars, use.cache = T) # output/figures/maintext/traits_explain_pmr.pdf
# see updates above

#---------------------------#
# supplementary figures and tables

#Fig S3
makefig__variation_densityNbarkthick(traits.stem, traits.code, pmr_byStem) # output/figures/supplementary/variation_densityNbarkthick.pdf

#Table S1
cox.df <- doAnalysis_variation_densityNbarkthick(traits.stem, traits.code, pmr_byStem, stem.respVars) 
write.csv(cox.df, file="output/tables/supplementary/smallsize_codeVstem_cox.csv")

```

3. Does endophyte composition explain decay?
- script: *endoComp_explainDecay.Rmd*
- summary: No. There is a relationship between composition and percent mass remaining after 37 months, but this is likely driven by the role of water content on the microbial community and decay.
```{r load_microbes}

#---------------------------#
#data

# wood trait residuals (see `woodTraits_explainDecay.Rmd')
result.traitsDecay <- doAnalysis_traits_explain_decayParams(decayfits, traits.code, code.respVars, use.cache = T)
traitResiduals.code <- result.traitsDecay$traitResiduals.code
result.traitsPMR <- doAnalysis_traits_explain_pmr(pmr_byStem, traits.code, traits.stem, stem.respVars, use.cache = T)
traitResiduals.stem <- result.traitsPMR$traitResiduals.stem

#microbes
microb.data <- load_MicrobeCollection(stemSamples)
taxAndFunguild <- microb.data$taxAndFunguild
comm.otu <- microb.data$comm.otu
seqSamples <- microb.data$seqSamples

#---------------------------#
# main figures and tables

#---------------------------#
# supplementary figures and tables

#Fig S4
#plot_sampleEffortCurves(comm.otu) # output/figures/supplementary/sampleEffortCurve.pdf; #this takes a while... uncomment if the data changes

#Fig S5
makefig__wapls_score_time37(comm.otu, pmr_byStem, stem.respVars, taxAndFunguild) # output/figures/supplementary/wapls_score_time37.pdf
# remember that this fig does not include oomycetes because we do not have boral coef estimates for them
#otucats <- maketab__wapls_score_time37_otuCats(cvfit.results.stem, taxAndFunguild)
#write.csv(otucats, file = "output/tables/supplementary/wapls_score_time37_otuCats.csv")

#Fig S6
makefigs__endoComp_woodTraits(comm.otu, seqSamples, traits.code, traits.stem, use.cache = T) # output/figures/supplementary/dbRDA_code.pdf
# figure only shows results from the trimmed community dataset
tab.list <- maketabs__endoComp_woodTraits(comm.otu, seqSamples, traits.code, use.cache = T)
write.csv(tab.list$an.nt.code, file="output/tables/supplementary/dbRDAanova_nt_code.csv")
write.csv(tab.list$an.t.code, file="output/tables/supplementary/dbRDAanova_t_code.csv")
write.csv(tab.list$an.nt.stem, file="output/tables/supplementary/dbRDAanova_nt_stem.csv")
write.csv(tab.list$an.t.stem, file="output/tables/supplementary/dbRDAanova_t_stem.csv")

#Table S2
cvfit.results.code <- doAnalysis_endoComp_explainDecay(comm.otu, seqSamples, decayfits, code.respVars, use.cache = T)
cvfit.results.stem <- doAnalysis_endoComp_explainPMR(comm.otu, pmr_byStem, stem.respVars)
commTab <- maketab_endoComp_explain(cvfit.results.code, cvfit.results.stem, code.respVars, stem.respVars)
write.csv(commTab, file="output/tables/supplementary/commcompsummary.csv")

#Table S3
cvfit.results.code <- doAnalysis_endoComp_explainDecayResids(comm.otu, seqSamples, decayfits, 
                                                             code.respVars, traitResiduals.code, use.cache = T)
cvfit.results.stem <- doAnalysis_endoComp_explainPMRResids(comm.otu, pmr_byStem, stem.respVars, traitResiduals.stem)
commTab <- maketab_endoComp_explain(cvfit.results.code, cvfit.results.stem, code.respVars, stem.respVars)
write.csv(commTab, file="output/tables/supplementary/commcompsummary_traitresid.csv")

```


4. Does endophyte diversity explain decay? *
- script: *endoDiv_explainDecay.Rmd*
- add bonferonni correction for multiple comparisons?
- summary:
    - More saprotrophs leads to less mass remaining after 25 and 37 months, but only in small stems
    - More pathotrophs leads to less mass remaining after 37 months, but only in small stems
    - Higher saprotroph richness leads to faster decay than would be expected based on wood traits alone
    - Higher saprotroph richness leads to trajectories that are less s-shaped than based on wood traits alone
```{r load_microbesdiv}

#---------------------------#
# main figures and tables

# see output/tables/diversitySummary.pdf

#---------------------------#
# supplementary figures and tables

#Fig S7
makefig__RichShannonPMR.stem(taxAndFunguild, comm.otu, pmr_byStem, stem.respVars) # output/figures/supplementary/richness_pmr.pdf

#Fig S8
makefig__pathoRichPMR.stem(taxAndFunguild, comm.otu, pmr_byStem, stem.respVars) # output/figures/supplementary/richness_patho_pmr.pdf

#Fig S9
makefig__saproRichDecayResids(taxAndFunguild, comm.otu, traitResiduals.code, code.respVars) # output/figures/supplementary/richness_sapro_decayResids.pdf

#Fig S10
makefig__richPMRResids(taxAndFunguild, comm.otu, traitResiduals.stem, stem.respVars) # output/figures/supplementary/richness_PMRResids.pdf

#Fig S11
makefig__path_richPMRResids(taxAndFunguild, comm.otu, traitResiduals.stem, stem.respVars) # output/figures/supplementary/richness_patho_time37Resids.pdf

#Table S4
result.list <- doAnalysis_endoDiv_explainDecay(taxAndFunguild, comm.otu, decayfits, code.respVars)
write.csv(result.list$pretty.df, file="output/tables/supplementary/diversitysummary_code.csv")

#Table S5
result.list.stem <- doAnalysis_endoDiv_explainPMR(taxAndFunguild, comm.otu, pmr_byStem, stem.respVars)
write.csv(result.list.stem$pretty.df, file="output/tables/supplementary/diversitysummary_stem.csv")

#Table S6
result.list <- doAnalysis_endoDiv_explainDecayResids(taxAndFunguild, comm.otu, traitResiduals.code, code.respVars)
write.csv(result.list$pretty.df, file="output/tables/supplementary/diversitysummary_code_traitresid.csv")

#Table S7
result.list.stem <- doAnalysis_endoDiv_explainPMRResids(taxAndFunguild, comm.otu, traitResiduals.stem, stem.respVars)
write.csv(result.list.stem$pretty.df, file="output/tables/supplementary/diversitysummary_stem_traitresid.csv")

```



### Other pieces

- How does including t=0 points affect the decay model fit? Including it affects the liklihood and the model selection criteria, but the curve fits are identical.  Excluding t=0 leads to prefering simpler models, which is the same effect as increasing the penalty for model complexity -- *code/testing_time_zero.Rmd* 

- Do endophyte community dissimilarities correlate with decay trajectory parameters? No relationships -- *code/initialDist_vs_decayDist_btwCode.Rmd*

- Is there a relationship between the frequency of highly correlated (negative or positive) OTU pairs identified via boral and decay parameters? Nope -- *code/boralOTUpairs_vs_decay.Rmd*

- Is there a relationship between initial microbial diversity WITHIN species+size categories and decay model R2? Nope -- *code/withinInitialDist_vs_decayR2.Rmd*

- Exclude mycorrhizal fungi and animal-associated fungi that somehow made it into our OTU table -- *code/unexpectedTaxa.Rmd*


### Need to continue incorporating C fract analyses into "woodTraits_explainDecay.Rmd"

Check out correlations among C fractions and other traits. Exclude two samples for which there isn't waterperc data. Remember that there is no stem-level barkthick or density data for large stem samples.
```{r}
cfract.load<- load_Cfract()
cfract.load %>%
  select(-Total) -> cfract.load
traits.stem %>%
  left_join(cfract.load) %>%
  filter(!is.na(Arabinose)) %>%
  select(-c(barkthick, density)) -> traits.stem.sel
#two samples are missing waterperc data
traits.stem.sel %>%
  filter(is.na(waterperc)) %>%
  select(codeStem, waterperc) 
#remove them
traits.stem.sel %>%
  filter(!is.na(waterperc)) -> traits.stem.sel

#grab just the matrix of traits
traits.stem.sel %>%
  select(-c(species, size, code, unique, Stem)) -> matonly
matonly.s <- scale(as.matrix(matonly[,-1]))

# plot correlations
pdf(file = "output/corplot.pdf")
corrplot(cor(matonly.s), type = "lower")
dev.off()

```

Kick out traits that are highly correlated
- C and perc.Total.lignin are highly positive correlated (0.81); keep perc.Total.lignin
- Glucose+Xylose and perc.Total.lignin are highly negatively correlated (-.89, -.73); keep perc.Total.lignin.
```{r}
#update
traits.stem.sel %>%
  select(-c(Glucose, Xylose, C)) -> traits.stem.sel
traits.stem.sel %>%
  select(-c(species, size, code, unique, Stem)) -> matonly
matonly.s <- scale(as.matrix(matonly[,-1]))

# plot correlations again
corrplot(cor(matonly.s), type = "lower")

cor(matonly.s)

```

Plot variation in C fractions w/in and between species
```{r}

traits.stem.sel %>%
  select(-c(Ca, Fe, K, Mn, N, P, waterperc, Zn)) %>%
  gather(key = "trait", value = "trait.val", -c(codeStem, species, size, code, unique, Stem)) -> tmp

ggplot(tmp, aes(x = reorder(species, trait.val), y = trait.val)) +
  geom_point() +
  facet_wrap(~trait, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

Check out samples in trait space
```{r}
pca <- prcomp(matonly.s)
df <- data.frame(pca$x[,1:2], 
                 traits.stem.sel[,c("codeStem","species","code","size")])
datapc <- data.frame(varnames=rownames(pca$rotation), pca$rotation[,1:2])
mult <- min(
  (max(df[,"PC1"]) - min(df[,"PC2"])/(max(datapc[,"PC2"])-min(datapc[,"PC2"]))),
  (max(df[,"PC2"]) - min(df[,"PC1"])/(max(datapc[,"PC1"])-min(datapc[,"PC1"])))
)
datapc <- transform(datapc,
                    v1 = .7 * mult * datapc$PC1,
                    v2 = .7 * mult * datapc$PC2)
  

plot_12 <- ggplot(data=datapc, aes(x=v1, y=v2, label=varnames)) + 
  geom_text(size=3, vjust=1, color=1) + 
  geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),
               arrow=arrow(length=unit(0.2,"cm")), alpha=0.75, color=1) + 
  coord_fixed() +
  geom_text(mapping=aes(x=PC1, y=PC2, 
                        color = species, label = code), data=df, inherit.aes = FALSE) +
  theme_bw() + xlab("PC1 (24%)") + ylab("PC2 (16%)") +
  guides(color = F)
plot_12
ggsave(plot_12, filename = "output/stem_traitord.pdf")
# for some reason this plot knit with more extra data points? it seems to work fine in ggsave

summary(pca)
```
![](output/stem_traitord.pdf)

Load new versions of trait data
```{r}
traits.code <- trait.means_byCode_new(stemSamples, fill.densitybark = T)
traits.stem <- trait.means_byStem_new(stemSamples)

# remove traits that are highly correlated with others
exclude <- c("Glucose","Xylose","C")
traits.code %>%
  select(-exclude) -> traits.code
traits.stem %>%
  select(-exclude) -> traits.stem

# remove observations w/o C fract data
traits.code %>%
  filter(!is.na(Arabinose)) -> traits.code.tmp
traits.stem %>%
  filter(!is.na(Arabinose)) -> traits.stem.tmp

# remove density and barkthickness from stem data
traits.stem.tmp %>%
  select(-c("barkthick","density")) -> traits.stem.tmp

```

Do wood C fractions explain decay?

(by code)
Note that there are only 12 observations by code, so that limits the number of traits we can include in the model. Not including micronutrients

```{r}
#merge traits and response variables into 1 df
decayfits %>%
  select(code, species, size, 
         ne.r2, k, t50, 
         w.r2, alpha, beta, w.t50) %>%
  left_join(traits.code) %>% 
  filter(!is.na(P)) %>%
  filter(!is.na(waterperc)) -> decayfits.traits
# subset by wood fract data
decayfits.traits %>%
  filter(!is.na(Arabinose)) -> decayfits.traits

# scale all the traits
decayfits.traits %>%
  select(waterperc, N, P, perc.Total.lignin, Rhamnose, Arabinose, Galactose, Mannose) -> mat
decayfits.traits %>%
  select(-c(waterperc, N, P, perc.Total.lignin, Rhamnose, Arabinose, Galactose, Mannose)) -> tmp
decayfits.traits.s <- data.frame(tmp, scale(mat))

#set up full models
respVars <- list("k","t50","ne.r2", "alpha","beta","w.t50","w.r2")
rhs <- "waterperc + N + P + perc.Total.lignin + Rhamnose + Arabinose + Galactose + Mannose" # got rid of size because only looking at large stems
mod.full.list<-lapply(respVars, ModelFit_manyYs, rhs, curr.data=decayfits.traits.s) # summaryTable_fxns.R

#do stepwise model selection #uncomment if data changes
mod.select.list<-lapply(mod.full.list, function(x) {
  x.updated<-update(x, . ~ ., data = model.frame(x))
  mod.select<-step(x.updated, direction="backward")
  return(mod.select)
  })
names(mod.select.list) <- respVars

#plot
sum.list<-lapply(mod.select.list, summary)
coefs.df<-PullLmCoefs(sum.list, unlist(respVars))
fitstat.df<-PullLmFitStats(sum.list, unlist(respVars))
fitstat.df %>%
  gather(key = "respvar", value = "value", -c(term)) %>%
  filter(term == "r.squared") %>%
  select(-term) %>%
  rename('r.squared'=value) -> r2.df
coefs.df %>%
  left_join(r2.df) %>%
  filter(respvar %in% c("alpha","beta","w.t50","w.r2")) -> coefs.df

unique(coefs.df$term)
# term.order <- c("(Intercept)","waterperc","N","perc.Total.lignin","Arabinose","Galactose","Mannose","Rhamnose")
# coefs.df$term <- factor(coefs.df$term, levels = rev(term.order))

coefs.df %>%
  filter(term != "(Intercept)") -> tmp
p <- ggplot(tmp, aes(x = est, y = term, color = stars)) +
  geom_point() +
  geom_errorbarh(aes(xmin = est - se, xmax = est + se)) +
  facet_wrap(~respvar, scales = "free_x") +
  geom_vline(xintercept = 0, linetype = 2) +
  scale_color_manual(values = c("gray","black","blue","red")) +
  ylab("Predictor variable") +
  xlab("Coef. estimate (+/- SE)")
p
ggsave(p, filename = "output/cfract_code.pdf")

```


(by stem) -- I want to update this so that the traits values are scaled before running the models
```{r}
# create dataframes
# stem-level waterperc, xrf, and CN and (small) species-level barkthickness and density

respVars <- list("time7", "time13", "time25", "time37","time59")

traits.stem.tmp %>%
  filter(!is.na(P)) %>%
  filter(!is.na(waterperc)) %>%
  filter(!is.na(Arabinose)) -> traits.stem.tmp

# scale all the traits
traits.stem.tmp %>%
  select(waterperc, N, P, perc.Total.lignin, Rhamnose, Arabinose, Galactose, Mannose) -> mat
traits.stem.tmp %>%
  select(codeStem) -> tmp
traits.stem.tmp.s <- data.frame(tmp, scale(mat[,-1]))
traits.stem.tmp.s

datasets<-lapply(respVars, function(x) {
  result<-CreateTraitPMRpair(x, traits.stem, traits.code, pmr_byStem) #analysisDF_fxns.R
  return(result)
})
names(datasets)<-respVars

#set up full models
rhs <- "waterperc + N + Arabinose + Galactose + Mannose + perc.Total.lignin + Rhamnose"
lhs <- "curr.pmr"
mod.full.list<-lapply(datasets, function(x) {
  result<-ModelFit_manyYs(y=lhs, rhs=rhs, curr.data=x)
  return(result)
})

#do stepwise model selection
mod.select.list<-lapply(mod.full.list, function(x) {
  x.updated<-update(x, . ~ ., data = model.frame(x))
  mod.select<-step(x.updated, direction="backward")
  return(mod.select)
  })

#plot
sum.list<-lapply(mod.select.list, summary)
coefs.df<-PullLmCoefs(sum.list, unlist(respVars))
fitstat.df<-PullLmFitStats(sum.list, unlist(respVars))
fitstat.df %>%
  gather(key = "respvar", value = "value", -c(term)) %>%
  filter(term == "r.squared") %>%
  select(-term) %>%
  rename('r.squared'=value) -> r2.df
coefs.df %>%
  left_join(r2.df) -> coefs.df

coefs.df$respvar<- factor(coefs.df$respvar, levels = c("time7","time13","time25","time37","time59"))
coefs.df
term.order <- c("(Intercept)","waterperc","N","perc.Total.lignin","Arabinose","Galactose","Mannose","Rhamnose")
coefs.df$term <- factor(coefs.df$term, levels = rev(term.order))

coefs.df %>%
  filter(term != "(Intercept)") -> tmp
p.stem <- ggplot(tmp, aes(x = est, y = term, color = stars)) +
  geom_point() +
  geom_errorbarh(aes(xmin = est - se, xmax = est + se)) +
  facet_grid(~respvar, scales = "free_x") +
  geom_vline(xintercept = 0, linetype = 2) +
  scale_color_manual(values = c("gray","black","blue","red")) +
  ylab("Predictor variable") +
  xlab("Coef. estimate (+/- SE)")
p.stem

ggsave(p.stem, filename = "output/cfract_stem.pdf")




```


Visualize the relationship between wood C fractions and endophyte communities
```{r}

#microbes
microb.data <- load_MicrobeCollection(stemSamples)
taxAndFunguild <- microb.data$taxAndFunguild
comm.otu <- microb.data$comm.otu
seqSamples <- microb.data$seqSamples

cfract.load<- load_Cfract()
mat.otu <- sub.comm.otu <- comm.otu[row.names(comm.otu) %in% cfract.load$unique,]
dim(mat.otu)

xVars <- cfract.load
xVars %>%
  select(-c(Total, unique, Stem, size)) -> envVars
dim(envVars)  

# transform otu tab
mat.otu.t<-decostand(mat.otu, 'hellinger')
  
# unconstrained mod
mod.obj <- capscale(mat.otu.t ~ 1, data = envVars, distance='bray')
  
  # do envfit
  envfit.obj <- envfit(mod.obj, envVars)
  
  # collect site scores from mod.obj
  scrs <- as.data.frame(scores(mod.obj, display = "sites"))
  scrs
  scrs <- cbind(scrs, seq_sampName = row.names(scrs))
  scrs %>%
    left_join(seqSamples) -> scrs
  
  # collect vector scores from envfit.obj
  spp.scrs <- as.data.frame(scores(envfit.obj, display = "vectors"))
  spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs), pval = envfit.obj$vectors$pvals)
  
  # plot
  mult <- 2 #multiplier for the arrows and text for envfit
  mult.text <- 2.3
  p <- ggplot(scrs) +
    geom_text(mapping = aes(x = MDS1, y = MDS2, label = code,
                             color = species), size = 3) +
    coord_fixed() + ## need aspect ratio of 1!
    geom_segment(data = spp.scrs,
                 aes(x = 0, xend = mult*MDS1, y = 0, yend = mult*MDS2),
                 arrow = arrow(length = unit(0.2, "cm")), colour = 1) +
    geom_text(data = spp.scrs, 
              aes(x = mult.text*MDS1, y = mult.text*MDS2, 
                  label = Species), size = 4, fontface = "bold") +
    xlab("PCoA 1") + ylab("PCoA 2")
  p
  ggsave(file="output/unconstrained_envfit.pdf", width = 8, height = 5)

```

Does adding C fraction data explain more variation in endophyte composition? How much? Doubles the unique info (with the caveat that I didn't include micronutrients)

X1 = original trait set: waterperc, C, N, and P
X2 = C fractions: perc.Total.lignin, Rhamnose, Arabinose, Galactose, Mannose
```{r}

traits.stem <- trait.means_byStem_new(stemSamples)

# remove traits that are highly correlated with others
exclude <- c("Glucose","Xylose") # don't get rid of C
traits.stem %>%
  select(-exclude) -> traits.stem

# remove observations w/o C fract data
traits.stem %>%
  filter(!is.na(Arabinose)) -> traits.stem.tmp

# remove density and barkthickness from stem data
traits.stem.tmp %>%
  select(-c("barkthick","density")) -> traits.stem.tmp

traits.stem.tmp %>%
  filter(!is.na(P)) %>%
  filter(!is.na(waterperc)) %>%
  filter(!is.na(Arabinose)) -> traits.stem.tmp

# scale all the traits
traits.stem.tmp %>%
  select(waterperc, N, P,C, perc.Total.lignin, Rhamnose, Arabinose, Galactose, Mannose) -> mat
traits.stem.tmp %>%
  select(codeStem) -> tmp
traits.stem.tmp.s <- data.frame(tmp, scale(mat[,-1]))
traits.stem.tmp.s

colnames(traits.stem.tmp.s)
envVars <- traits.stem.tmp.s

# remove communities with missing waterperc data
mat.otu <- sub.comm.otu <- comm.otu[row.names(comm.otu) %in% envVars$codeStem,]
dim(mat.otu)
dim(envVars)

# transform otu tab
mat.otu.t<-decostand(mat.otu, 'hellinger')

# extract the unconstrained and constrained mod
 # unconstrained mod

mod0 <- capscale(mat.otu.t ~ 1, data = envVars[,-1], distance='bray')
  # constrained mod
modfull <- capscale(mat.otu.t ~ ., data=envVars[,-1], distance='bray')

# model selection
modstep <- ordistep(mod0, scope=formula(modfull))
  
# summary table for the best model
df <- data.frame(term=row.names(modstep$anova), modstep$anova)
df %>%
    separate(term, into=c("drop","term")) %>%
    select(-drop) %>%
    rename('pval'=`Pr..F.`) -> df
df
write.csv(df, file = "output/constrained_bestmodelsummaryAllTraits.csv")

envVars %>%
  select(waterperc, N, P,C) -> orig.traits
envVars %>%
  select(perc.Total.lignin, Rhamnose, Arabinose, Galactose, Mannose) -> C.fract

endo.var <- varpart(vegdist(mat.otu.t, distance = 'bray'),
                        ~ as.matrix(orig.traits),
                        ~ as.matrix(C.fract))
    var.fract <- endo.var$part
    plot(endo.var)
    
    orig.traits
    C.fract





```



