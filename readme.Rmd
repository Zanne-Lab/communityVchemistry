---
title: "Does chemistry or community better predict mass loss?"
author: "Marissa Lee"
date: "10/23/2017"
output: github_document
---

```{r,message=FALSE}
#chunk options
knitr::opts_chunk$set(echo = TRUE)

#libraries
devtools::install_github("cornwell-lab-unsw/litterfitter")
library(dplyr)
library(ggplot2)
library(readr)
library(vegan)
library(knitr)
library(litterfitter)
library(magrittr)
library(tidyr)
source("code/load_fxns.R")
source("code/curve_fitting_fxns.R")
source("code/distance_fxns.R")
library(gridExtra)
```

### Load microbial community data
```{r message=FALSE}
fung.otu<-load_matotu()
comm.otu<-add_oomycetes(fung.otu)
#plot_sampleEffortCurves(comm.otu)
```

### Load wood trait data
```{r message=FALSE}
traits.mean<-mergeTraitData()
traits.long<-as.data.frame(gather(traits.mean, key=trait, value=value, -(1:3)))

ggplot(traits.long, aes(x=species_lower, y=value, color=size)) + 
  geom_point() + 
  facet_wrap(~trait, scales="free") +
  mytheme + theme(axis.text.x = element_text(angle = 90, hjust = 1))

# #the Fe values for large stems are not 0, they are just small values
# subset(traits.long, trait=="Fe") %>%
#   ggplot(aes(x=species_lower, y=value, color=size)) + 
#   geom_point() +
#   facet_wrap(~size, scales="free")
```

### Load mass loss data
```{r}

#initial mass
initial_mass <- read_in_initial_mass()
# initial_mass %>%
#   mutate(SpeciesCode=tolower(Species))%>%
#   ggplot(aes(y=totalSampleDryMass,x=SpeciesCode,fill=size))+
#   geom_violin()+ 
#   theme(axis.text.x=element_text(angle=90,hjust=1)) + 
#   scale_y_log10()

#mass at harvest
harvest_mass<-LoadHarvestFiles()

#create a complete sample mass df for all time points
mass.data<-bind_rows(initial_mass, harvest_mass)

#check for missing data
mass.data %>%
  filter(is.na(totalSampleDryMass)) %>%
  knitr::kable()

```
Identify outliers in mass loss data
```{r message=FALSE}
mass.data %>% 
  ggplot(aes(x=time, y=totalSampleDryMass)) + geom_point(alpha=0.6)+theme_bw() 
mass.data[which.max(mass.data$totalSampleDryMass),]
outlier.uniques<-as.character(mass.data[which.max(mass.data$totalSampleDryMass),"unique"])
outlier.uniques
```
...another view...might want to check out those two high mass value outliers from harvest 3
```{r}
mass.data %>%
  ggplot(aes(x=time, y=totalSampleDryMass,col=size)) +
  geom_point(position="jitter",alpha=0.6)+theme_bw()+scale_y_log10()

#Might want to check out those two high mass value outliers from harvest 3
filter(mass.data, size=="small", time==25) %>%
  arrange(-totalSampleDryMass)->tmp
tmp[1:2,]
outlier.uniques<-c(outlier.uniques, tmp$unique[1:2])
```
Are these real 0's?
```{r}
mass.data[which(mass.data$totalSampleDryMass==0),]
```
Remove outliers from mass.data and merge time zero with the other harvests to calculate proportion mass remaining at each time point
```{r}
mass.data<-mass.data[!mass.data$unique %in% outlier.uniques,]

#Merge time zero with the other harvests to calculate proportion mass remaining at each time point
mass.data %>%
  filter(time==0) %>%
  rename(timeZeroDensity=density) %>%
  rename(timeZeroMass=totalSampleDryMass) %>%
  select(unique,timeZeroMass,timeZeroDensity)->time_zero

mass.data %>%
  left_join(time_zero,by="unique") %>%
  mutate(pmr=totalSampleDryMass/timeZeroMass) %>%
  mutate(SpeciesCode=tolower(Species)) -> plotting_df
  write_csv(plotting_df,"derived_data/plotting_df.csv")
  
  
  # here are the matching failures which are currently due to the time zero adjustment for moisture
  plotting_df %>%
    filter(is.na(pmr)) %>%
    knitr::kable()
  
```


### Non-linear curve fits of decay trajectories
Using `litterfitter` to apply both negative exponenial and weibull to all species/size classes
```{r,warning=FALSE,message=FALSE,results=FALSE}

#spdf <- fit_all_curves(plotting_df) #this recalculates all the curve fits, uncomment if the data changes
#write_csv(spdf,"derived_data/mass_loss_parameters.csv")
spdf <- read_csv("derived_data/mass_loss_parameters.csv")

ggplot(spdf,aes(x=t70,y=w.t70,col=size))+
  geom_point()+
  labs(x="Time to 30% mass loss (negative exponential)", 
       y="Time to 30% mass loss (Weibull)")+
  geom_abline(slope=1,intercept=0,linetype="dashed")+theme_bw()

```



### Plot beta diversity of microbial community vs distance in decay params
```{r}

#calculate pairwise community distances
sampTab<-CreateSeqSampTab(mass.data) #1. creat sample tab for community sequences samples
comm.dist<-Calc_commDists(sampTab, comm.otu) #2. calc the distances
summ.comm_dist<-SummarizeCommDist_byCodePair(comm.dist) #3. summarize the distances by codePair

#calculate pairwise decay parameter distances
spdf<-mutate(spdf, minAIC = pmin(neg.exp.aic, w.aic) ) #1. find the min AIC for each species+size
spdf<-AddCodeID(sampTab) #2. add code to spdf using sampTab
aic.dist<-Calc_decayParamDiffs(valueCol="minAIC", spdf, sampTab) #3. calc decay param diffs, e.g. minAIC
k.dist<-Calc_decayParamDiffs(valueCol="k", spdf, sampTab)
alpha.dist<-Calc_decayParamDiffs(valueCol="alpha", spdf, sampTab)

#merge community and decay param distances into the same dataframe
comm_decay.dist.aic<-MergeCommNDecaydists_byCodePair(decayparam.dist=aic.dist, summ.comm_dist)
comm_decay.dist.k<-MergeCommNDecaydists_byCodePair(decayparam.dist=k.dist, summ.comm_dist)
comm_decay.dist.alpha<-MergeCommNDecaydists_byCodePair(decayparam.dist=alpha.dist, summ.comm_dist)

# delta minAIC
p.aic<-ggplot(comm_decay.dist.aic, aes(x=mean_comm_dist, y=decayparam_dist, color=size)) + 
  geom_point() + 
  geom_errorbarh(aes(xmin=lower_comm_dist, xmax=upper_comm_dist)) +
  xlab('Mean microbial community distance') + ylab("Delta decay model AIC")

# delta k
p.k<-ggplot(comm_decay.dist.k, aes(x=mean_comm_dist, y=decayparam_dist, color=size)) + 
  geom_point() + 
  geom_errorbarh(aes(xmin=lower_comm_dist, xmax=upper_comm_dist)) +
  xlab('Mean microbial community distance') + ylab("Delta decay model k")

# delta alpha
p.alpha<-ggplot(comm_decay.dist.alpha, aes(x=mean_comm_dist, y=decayparam_dist, color=size)) + 
  geom_point() + 
  geom_errorbarh(aes(xmin=lower_comm_dist, xmax=upper_comm_dist)) +
  xlab('Mean microbial community distance') + ylab("Delta decay model alpha")

#pdf('output/commDist_decayparamDist_byCode.pdf', width=4, height=9)
grid.arrange(p.aic, p.k, p.alpha)
#dev.off()

```
Not a lot of information in mean inital community distance about species+size decay trajectories

### Plot beta diversity of wood traits vs distance in decay params
```{r}

#calculate pairwise wood trait distances
traits.dist<-Calc_woodTraitDist(traits.mean)

#calculate pairwise decay parameter distances
spdf<-mutate(spdf, minAIC = pmin(neg.exp.aic, w.aic) ) #1. find the min AIC for each species+size
spdf<-AddCodeID(sampTab) #2. add code to spdf using sampTab
aic.dist<-Calc_decayParamDiffs(valueCol="minAIC", spdf, sampTab) #3. calc decay param diffs, e.g. minAIC
k.dist<-Calc_decayParamDiffs(valueCol="k", spdf, sampTab)
alpha.dist<-Calc_decayParamDiffs(valueCol="alpha", spdf, sampTab)

#merge wood trait and decay param distances into the same dataframe
wood_decay.dist.aic<-MergeWoodNDecaydists_byCodePair(decayparam.dist=aic.dist, traits.dist)
wood_decay.dist.k<-MergeWoodNDecaydists_byCodePair(decayparam.dist=k.dist, traits.dist)
wood_decay.dist.alpha<-MergeWoodNDecaydists_byCodePair(decayparam.dist=alpha.dist, traits.dist)

# delta minAIC
p.aic<-ggplot(wood_decay.dist.aic, aes(x=woodTraitDist, y=decayparam_dist, color=size)) + 
  geom_point() + 
  xlab('Wood trait distance') + ylab("Delta decay model AIC")

# delta k
p.k<-ggplot(wood_decay.dist.k, aes(x=woodTraitDist, y=decayparam_dist, color=size)) + 
  geom_point() + 
  xlab('Wood trait distance') + ylab("Delta decay model k")

# delta alpha
p.alpha<-ggplot(wood_decay.dist.alpha, aes(x=woodTraitDist, y=decayparam_dist, color=size)) + 
  geom_point() + 
  xlab('Wood trait distance') + ylab("Delta decay model alpha")

#pdf('output/woodTraitDist_decayparamDist_byCode.pdf', width=4, height=9)
grid.arrange(p.aic, p.k, p.alpha)
#dev.off()

```
Seems like there is more information in inital wood trait distance about species+size decay trajectories than there is in the initial mean communities distances

### Look at 3-way relationship between species+size distances: wood trait, microbial community, and k
```{r}

comm_wood_decay.dist.k<-left_join(comm_decay.dist.k, wood_decay.dist.k)

#what is up with the missing data in woodTraitDist?
select(comm_wood_decay.dist.k, size, mean_comm_dist, woodTraitDist, decayparam_dist) %>%
  filter(complete.cases(size, comm_wood_decay.dist.k, mean_comm_dist, woodTraitDist, decayparam_dist)) -> df.k

p1<-ggplot(df.k, aes(x=mean_comm_dist, y=decayparam_dist, color=size)) + 
  geom_point() + xlab("Mean microbial community distance") + ylab("Decay rate (k) distance")

p2<-ggplot(df.k, aes(x=woodTraitDist, y=decayparam_dist, color=size)) + 
  geom_point() +  xlab("Wood trait distance") + ylab("Decay rate (k) distance")

p3<-ggplot(df.k, aes(x=mean_comm_dist, y=woodTraitDist, color=size)) + 
  geom_point() +  xlab("Mean microbial community distance") + ylab("Wood trait distance")

#pdf('output/triDist_k_byCode.pdf', width=6, height=6)
grid.arrange(p1,p2,p3, ncol=2)
#dev.off()

cor(df.k[,-1])

```
Another view that emphasizes the relationship between wood trait distance and decay rate distances between species+size classes.  Mean microbial community distance is not correlated with either variable.

### Plot with species+size beta diversity of microbial community vs AIC of neg.exponential
```{r}

#calculate pairwise community distances
sampTab<-CreateSeqSampTab(mass.data) #1. creat sample tab for community sequences samples
comm.dist<-Calc_commDists(sampTab, comm.otu) #2. calc the distances
filter(comm.dist, code1==code2) %>% #3. isolate just the distances within species+size
  select(sampID1, sampID2, code1, size, dist) %>%
  rename("code"="code1") %>% #rename the cols
  group_by(code) %>%
  summarize(mean=mean(dist), #calculate the mean community dist within code classes
            se=sd(dist)/sqrt(length(dist)),
            upper=mean+se,
            lower=mean-se) -> comm.dist.wth

#combine with decay trajectory params
spdf.sub<-select(spdf, code, neg.exp.aic, w.aic)
comm.dist.wth<-left_join(comm.dist.wth, spdf.sub)

#add back the size and species columns
comm.dist.wth$size<-"large"
comm.dist.wth[tolower(comm.dist.wth$code) == comm.dist.wth$code, "size"]<-"small"
comm.dist.wth$species<-tolower(comm.dist.wth$code)

p.negexp.aic<-ggplot(comm.dist.wth, aes(x=mean, y=neg.exp.aic, color=species, shape=size)) + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower, xmax=upper)) +
  xlab("Mean microbial community distance") + 
  ylab("Negative exponential model AIC") +
  facet_grid(~size)

p.w.aic<-ggplot(comm.dist.wth, aes(x=mean, y=w.aic, color=species, shape=size)) + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower, xmax=upper)) +
  xlab("Mean microbial community distance") + 
  ylab("Weibull model AIC") +
  facet_grid(~size)

#pdf('output/commDist_decayparam_withinCode.pdf', width=8, height=6)
grid.arrange(p.negexp.aic, p.w.aic)
#dev.off()

```
Expected to see a positive relationship between AIC and within species+size class microbial community distance. In other words, expected that samples with similar initial microbial communities would have better-fitting decay models.

The large size samples show no pattern
The small size samples show (maybe) the opposite pattern
