---
title: "Does chemistry or community better predict mass loss?"
date: "10/23/2017"
output: github_document
---


```{r, echo=FALSE, message=FALSE}
#chunk options
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)

#libraries
devtools::install_github("cornwell-lab-unsw/litterfitter")
library(dplyr)
library(ggplot2)
library(readr)
library(vegan)
library(knitr)
library(litterfitter)
library(magrittr)
library(tidyr)
library(gridExtra)
library(rioja)
library(colorspace)

#fxns
source("code/load_fxns.R")
source("code/curve_fitting_fxns.R")
source("code/distance_fxns.R")
source("code/otuIDs_fxns.R")
```

### Load microbial community data
```{r, echo=FALSE}
#stem sample meta data
#stemSamples<-load_stemSamples() #uncomment if the data changes
#write_csv(stemSamples, "derived_data/stemSamples.csv")
stemSamples<-read_csv("derived_data/stemSamples.csv")

#OTU table
#fung.otu<-load_matotu() #uncomment if the data changes
#comm.otu<-add_oomycetes(fung.otu) #add the oomycetes #uncomment if the data changes
#write.csv(comm.otu, "derived_data/comm_otu.csv")
comm.otu<-read.csv("derived_data/comm_otu.csv", row.names=1)

#create sequence sample meta data table
#seqSamples<-load_seqSamples(comm.otu, stemSamples) #uncomment if the data changes
#write_csv(seqSamples, "derived_data/seqSamples.csv")
seqSamples<-read_csv("derived_data/seqSamples.csv")

#taxon lookup info
#taxAndFunguild<-load_TaxAndFunguild(comm.otu) #uncomment if the data changes
#write_csv(taxAndFunguild, "derived_data/taxaAndFunguild.csv")
taxAndFunguild<-read_csv("derived_data/taxaAndFunguild.csv")

#plot_sampleEffortCurves(comm.otu)
```

### Load wood trait data
```{r, echo=FALSE}
#traits.mean<-mergeTraitData() #uncomment if the data changes
#write_csv(traits.mean, "derived_data/traits_mean.csv") 
traits.mean<-read_csv("derived_data/traits_mean.csv")
#missing data
#traits.long<-as.data.frame(gather(traits.mean, key=trait, value=value, -(1:3)))
#filter(traits.long, is.na(value))

traits.codeStem<-mergeTraitData_byStem()
#data that we have
traits.codeStem.long<-as.data.frame(gather(traits.codeStem, key=trait, value=value, -(1:3)))
traits.codeStem.long %>%
  filter(!is.na(value)) %>%
  group_by(code, trait) %>%
  summarize(length(value)) %>%
  spread(key=trait, value='length(value)') -> tmp

### LOAD MASS LOSS DATA and CALCULATE % MASS REMAINING AT EACH TIMEPOINT
#initial_mass <- read_in_initial_mass() #uncomment if the data changes
#harvest_mass<-LoadHarvestFiles()
#mass.data<-bind_rows(initial_mass, harvest_mass)
#missing data
#mass.data %>% filter(is.na(totalSampleDryMass))
#plotting_df<-Calc_massRemaining(mass.data)
#matching failures
# plotting_df %>%
#   filter(is.na(pmr)) %>%
#   select(unique, species, size, time, totalSampleDryMass, notes) %>%
#   spread(key=time, value=totalSampleDryMass)
#remove NAs
#plotting_df %>% filter(!is.na(pmr)) -> plotting_df
#write.csv(plotting_df,"derived_data/plotting_df.csv")
plotting_df<-read.csv("derived_data/plotting_df.csv", row.names=1)

#add codeStem and transform
plotting_df %>%
  select(unique, size, time, pmr) %>%
  separate(unique, into=c("code","StemNposition"), sep=4, extra='merge', remove=FALSE) %>%
  separate(StemNposition, into=c("Stem","position"), sep=1, extra='merge', remove=TRUE) %>%
  mutate(codeStem=paste(code, Stem, sep="")) %>%
  select(codeStem, position, time, pmr) -> pmr.df

#average pmr by codeStem and time
pmr.df %>%
  group_by(codeStem, time) %>%
  summarize(mean.pmr=mean(pmr, na.rm=TRUE),
            sd.pmr=sd(pmr, na.rm=TRUE),
            n.pmr=length(pmr)) -> pmr.byStem.df

pmr.byStem.df$code<-substr(pmr.byStem.df$codeStem, 1, 4)
pmr.byStem.df$species<-tolower(pmr.byStem.df$code)
pmr.byStem.df$size<-"large"
pmr.byStem.df[pmr.byStem.df$code == tolower(pmr.byStem.df$code),"size"]<-"small"
ggplot(pmr.byStem.df, aes(x=time, y=mean.pmr*100, group=codeStem, color=species, linetype=size)) + 
  geom_line() + facet_wrap(~species) +
  xlab("Time (months)") + ylab("Mass remaining (%)") + theme_bw()
#ggsave("output/massLoss_byStem.pdf")

#make it wide
pmr.byStem.df %>%
  select(codeStem, time, mean.pmr) %>%
  spread(key=time, value=mean.pmr) %>%
  rename('time0'=`0`,
         'time7'=`7`,
         'time13'=`13`,
         'time25'=`25`,
         'time37'=`37`) -> pmr.byStem.df.w

### CALCULATE DECAY TRAJECTORY FITS
#spdf <- fit_all_curves(plotting_df) #this recalculates all the curve fits, uncomment if the data changes
#indx<-select(stemSamples, code, species, size)
#spdf<-left_join(spdf, indx) #add code
#write_csv(spdf,"derived_data/mass_loss_parameters.csv")
spdf <- read_csv("derived_data/mass_loss_parameters.csv")

# ggplot(spdf,aes(x=t70,y=w.t70,col=size))+
#   geom_point()+
#   labs(x="Time to 30% mass loss (negative exponential)", 
#        y="Time to 30% mass loss (Weibull)")+
#   geom_abline(slope=1,intercept=0,linetype="dashed")+theme_bw()

#make plot of decay params by wood species
spdf %>%
  gather(key="decayParam",value="value", 1:6) %>%
  filter(decayParam %in% c("k","t70","ne.r2")) %>%
  arrange(decayParam, -value) -> plot.df

# plot t70 and r2
plot.df1<-subset(plot.df, decayParam != "k")
sp.order<-as.character(unique(plot.df1[plot.df1$decayParam=="t70","species"]$species))
plot.df1$species<-factor(plot.df1$species, levels=sp.order)
plot.df1$decayParam<-factor(plot.df1$decayParam, levels=c("t70","ne.r2"))
plot.df1$decayParam<-recode(plot.df1$decayParam, 
                           "t70"="Time to 70% mass remaining (months)",
                           "ne.r2"="Neg. expon. R2")
ggplot(plot.df1, aes(x=species, y=value, shape=size)) + 
  geom_point() + 
  coord_flip() +
  xlab("Wood species") + ylab("") + theme_bw() +
  scale_shape_manual(values=c('large'=19, 'small'=1)) + 
  guides(shape=F) +
  facet_grid(~decayParam, scales="free") 
#ggsave("output/decayParams_t70_and_r2.pdf")

# plot k
ggplot(spdf, aes(x=reorder(species, k), y=k, shape=size)) + 
  geom_point() +
  geom_errorbar(aes(ymin=k.lower, ymax=k.upper)) +
  coord_flip() +
  xlab("Wood species") + ylab("k (year^-1)") + theme_bw() +
  scale_shape_manual(values=c('large'=19, 'small'=1)) + 
  guides(shape=F)
#ggsave("output/decayParams_k.pdf")


```

### Summarize stem-level data
```{r}

# add 'codeStem' to microbial community
seqSamples$codeStem<-paste(seqSamples$code, seqSamples$Stem, sep="")
seqSamples[grepl("NA", seqSamples$codeStem),"codeStem"]<-NA

# bind everything together
pmr.byStem.df.w %>% # mass loss
  full_join(traits.codeStem) %>% #wood traits
  full_join(seqSamples) %>% #microbial data
  select(codeStem, code, seq_sampName, waterperc, density, barkthick, P, K, Ca, Mn, Fe, Zn, N, C, time7, time13, time25, time37) %>%
  filter(!is.na(codeStem))  %>%
  separate(codeStem, into=c("code1","Stem"), sep=4) %>%
  filter(Stem %in% 1:10) -> stem.data

#View(stem.data)

```

##########################################

# Wood traits as a predictor

First, look at just the small stem samples because we have the most trait information on the stem level for theses samples. Compare models using data on code level and codeStem level and with barkthickness and density as predictors to see if codeStem improves model fit...
```{r, echo=FALSE}

# add code to pmr dataset
pmr.byStem.df.w %>%
  separate(codeStem, into=c("code","Stem"), sep=4, extra='merge', remove=FALSE) -> pmr.byStem.df.w

# (1) subset just the small stems
# (2) subset samples with waterperc, density, barkthick trait data
# (3) join with pmr data
# (4) select useful cols
traits.codeStem %>% 
  filter(size=="small") %>%
  filter(!is.na(density) & !is.na(barkthick)) %>%
  left_join(pmr.byStem.df.w) %>%
  select(codeStem, code, size, density, barkthick, time7, time13, time25, time37) -> sm.traits.codeStem
dim(sm.traits.codeStem)


# (1) subset just the small codes, 
# (2) subset samples with waterperc, density, barkthick trait data
# (3) restrict analyses to the same set of wood species as present in stem dataset
# (4) join with pmr data
# (5) select useful cols
traits.mean %>%
  filter(size=="small") %>%
  filter(!is.na(density) & !is.na(barkthick)) %>%
  filter(code %in% unique(sm.traits.codeStem$code)) %>%
  left_join(pmr.byStem.df.w) %>%
  select(codeStem, code, size, density, barkthick, time7, time13, time25, time37) -> sm.traits.code
dim(sm.traits.code)

### density + barkthick
#fit stem-level models
mod.stem.t7<-lm(time7 ~ density + barkthick, data=sm.traits.codeStem)
mod.stem.t13<-lm(time13 ~ density +barkthick, data=sm.traits.codeStem)
mod.stem.t25<-lm(time25 ~ density +barkthick, data=sm.traits.codeStem)
mod.stem.t37<-lm(time37 ~ density +barkthick, data=sm.traits.codeStem)
#fit code-level models
mod.code.t7<-lm(time7 ~ density +barkthick, data=sm.traits.code)
mod.code.t13<-lm(time13 ~ density +barkthick, data=sm.traits.code)
mod.code.t25<-lm(time25 ~ density +barkthick, data=sm.traits.code)
mod.code.t37<-lm(time37 ~ density +barkthick, data=sm.traits.code)
#summarize r2 vals
mod.compare.densitybarkthick<-data.frame(response=c("time7","time13","time25","time37"),
           r2.stem=c(summary(mod.stem.t7)$r.squared,
                     summary(mod.stem.t13)$r.squared,
                     summary(mod.stem.t25)$r.squared,
                     summary(mod.stem.t37)$r.squared),
           
           r2.code=c(summary(mod.code.t7)$r.squared,
                     summary(mod.code.t13)$r.squared,
                     summary(mod.code.t25)$r.squared,
                     summary(mod.code.t37)$r.squared))
mod.compare.densitybarkthick

### just barkthick
#fit stem-level models
mod.stem.t7<-lm(time7 ~ barkthick, data=sm.traits.codeStem)
mod.stem.t13<-lm(time13 ~ barkthick, data=sm.traits.codeStem)
mod.stem.t25<-lm(time25 ~ barkthick, data=sm.traits.codeStem)
mod.stem.t37<-lm(time37 ~ barkthick, data=sm.traits.codeStem)
#fit code-level models
mod.code.t7<-lm(time7 ~ barkthick, data=sm.traits.code)
mod.code.t13<-lm(time13 ~ barkthick, data=sm.traits.code)
mod.code.t25<-lm(time25 ~ barkthick, data=sm.traits.code)
mod.code.t37<-lm(time37 ~ barkthick, data=sm.traits.code)
#summarize r2 vals
mod.compare.barkthick<-data.frame(response=c("time7","time13","time25","time37"),
           r2.stem=c(summary(mod.stem.t7)$r.squared,
                     summary(mod.stem.t13)$r.squared,
                     summary(mod.stem.t25)$r.squared,
                     summary(mod.stem.t37)$r.squared),
           
           r2.code=c(summary(mod.code.t7)$r.squared,
                     summary(mod.code.t13)$r.squared,
                     summary(mod.code.t25)$r.squared,
                     summary(mod.code.t37)$r.squared))
mod.compare.barkthick

# plot that shows variation in barkthick within species
sm.traits.codeStem$species<-tolower(sm.traits.codeStem$code)
ggplot(sm.traits.codeStem, aes(x=species, y=barkthick)) + 
  geom_point(alpha=.5, pch=16) + coord_flip() + theme_bw() +
  xlab("Wood species") + ylab("Bark thickness (mm)")
#ggsave('output/stem_barkthick.pdf')

```
For models with **density + barkthickness**, it looks like stem-level data improves model fit a tiny bit for early percent mass remaining time points (after 7 and 13 months) but not later time points. For models with just **barkthickness**, fits are about the same... slightly better on the stem-level at the last time point

## *Hyp (stem-level)* Stem-specific initial wood traits will predict variation in percent mass loss.
```{r, include=FALSE}
timeList<-list('time7','time13','time25','time37')

#function to pull out samples with the following trait info ...
# stem-level waterperc, xrf, and CN and (small) species-level barkthickness
datasets<-lapply(timeList, CreateTraitPMRpair, traits.codeStem, traits.mean, pmr.byStem.df.w)
names(datasets)<-c('time7','time13','time25','time37')

#fit full models (no barkthick or density because these weren't measured on small stems)
mod.full.t7<-lm(curr.time ~ size + waterperc + barkthick_smspp + P + K + Ca + Mn + Fe + Zn + N + C, data=datasets[['time7']])
mod.full.t13<-lm(curr.time ~ size + waterperc + barkthick_smspp + P + K + Ca + Mn + Fe + Zn + N + C, data=datasets[['time13']])
mod.full.t25<-lm(curr.time ~ size + waterperc + barkthick_smspp + P + K + Ca + Mn + Fe + Zn + N + C, data=datasets[['time25']])
mod.full.t37<-lm(curr.time ~ size + waterperc + barkthick_smspp + P + K + Ca + Mn + Fe + Zn + N + C, data=datasets[['time37']])
mod.full.t37.nobark<-lm(curr.time ~ size + waterperc + P + K + Ca + Mn + Fe + Zn + N + C, data=datasets[['time37']])

#do stepwise model selection
mod.select.t7<-step(mod.full.t7, direction="backward")
mod.select.t13<-step(mod.full.t13, direction="backward")
mod.select.t25<-step(mod.full.t25, direction="backward")
mod.select.t37<-step(mod.full.t37, direction="backward")
mod.select.t37.nobark<-step(mod.full.t37.nobark, direction="backward")

#save the residuals
traitResid.t7<- data.frame(codeStem = datasets[['time7']]$codeStem, trait.resid = mod.select.t7$residuals)
traitResid.t13<- data.frame(codeStem = datasets[['time13']]$codeStem, trait.resid = mod.select.t13$residuals)
traitResid.t25<- data.frame(codeStem = datasets[['time25']]$codeStem, trait.resid = mod.select.t25$residuals)
traitResid.t37<- data.frame(codeStem = datasets[['time37']]$codeStem, trait.resid = mod.select.t37$residuals)

```

### time7 

**less water content and C leads to more mass remaining after 7 months**

```{r, echo=FALSE}
summary(mod.select.t7) # waterperc, C (marginally)
#ggplot(datasets[['time7']], aes(x=waterperc, y=curr.time*100, color=species)) + 
#  geom_point() + ylab("Mass remaining after 7 months (%)")
```

### time 13

**larger size stems, less water content, more P and Mn, and less N leads to more mass remaining after 13 months**  

```{r, echo=FALSE}
summary(mod.select.t13) # size, waterperc, N
#ggplot(datasets[['time13']], aes(x=waterperc, y=curr.time*100, color=species, size=N)) + 
#  geom_point() + ylab("Mass remaining after 13 months (%)") + facet_grid(~size)
```

### time 25

**larger size stems, less water content, more P leads to more mass remaining after 25 months**  

```{r, echo=FALSE}
summary(mod.select.t25) # size, waterperc, P
#ggplot(datasets[['time25']], aes(x=waterperc, y=curr.time*100, color=species, size=P)) + 
#  geom_point() + ylab("Mass remaining after 25 months (%)") + facet_grid(~size)
```

### time 37

**larger size stems, less water content, less thick bark, more P, Mn, and C leads to more mass remaining after 37 months**  

```{r, echo=FALSE}
summary(mod.select.t37) # size, waterperc, barkthick_smspp, P, Mn, C
#ggplot(datasets[['time37']], aes(x=waterperc, y=curr.time*100, color=species, size=P)) + 
#  geom_point() + ylab("Mass remaining after 37 months (%)") + facet_grid(~size)

#summary(mod.select.t37.nobark)
```




##########################################

# Community as a predictor

### First, filter community matrix to include only taxa that are present in a least 20% of all the samples. This step removes taxa that may not contribute much to our understanding of the relationship between species’ multivariate abundance and environment.
```{r, echo=FALSE}

minSamps<-floor(dim(comm.otu)[1] * .2) #how many samples is 20% of them?
dat1 <- apply(comm.otu>0, 2, sum) #how many samples does each OTU show up in?
comm.otu.trimmed <- comm.otu[,dat1>minSamps]

paste("Keep", dim(comm.otu.trimmed)[2], "of", dim(comm.otu)[2], "OTUs")

```


## *Hyp (stem-level)* Stem-specific initial microbial communitiy compositions will predict variation in percent mass loss, particularly in the early stages of decay.
```{r, include=FALSE}

timeList<-list('time7','time13','time25','time37')
datasets<-lapply(timeList, CreateCommPMRpair, comm.mat = comm.otu.trimmed, pmr.byStem.df.w)
names(datasets)<-c('time7','time13','time25','time37')
datasets.nt<-lapply(timeList, CreateCommPMRpair, comm.mat = comm.otu, pmr.byStem.df.w)
names(datasets.nt)<-c('time7','time13','time25','time37')

#fit models
fit.t7 <- WAPLS(datasets[['time7']][['comm']], datasets[['time7']][['pmr']]$curr.time, npls=15)
fit.t13 <- WAPLS(datasets[['time13']][['comm']], datasets[['time13']][['pmr']]$curr.time)
fit.t25 <- WAPLS(datasets[['time25']][['comm']], datasets[['time25']][['pmr']]$curr.time)
fit.t37 <- WAPLS(datasets[['time37']][['comm']], datasets[['time37']][['pmr']]$curr.time)
fit.t7.notrim <- WAPLS(datasets.nt[['time7']][['comm']], datasets.nt[['time7']][['pmr']]$curr.time)
fit.t13.notrim <- WAPLS(datasets.nt[['time13']][['comm']], datasets.nt[['time13']][['pmr']]$curr.time)
fit.t25.notrim <- WAPLS(datasets.nt[['time25']][['comm']], datasets.nt[['time25']][['pmr']]$curr.time)
fit.t37.notrim <- WAPLS(datasets.nt[['time37']][['comm']], datasets.nt[['time37']][['pmr']]$curr.time)

#cross-validate models using the leave-one-out method
fit.t7.cv <- crossval(fit.t7, cv.method="loo")
fit.t13.cv <- crossval(fit.t13, cv.method="loo")
fit.t25.cv <- crossval(fit.t25, cv.method="loo")
fit.t37.cv <- crossval(fit.t37, cv.method="loo")
fit.t7.nt.cv <- crossval(fit.t7.notrim, cv.method="loo")
fit.t13.nt.cv <- crossval(fit.t13.notrim, cv.method="loo")
fit.t25.nt.cv <- crossval(fit.t25.notrim, cv.method="loo")
fit.t37.nt.cv <- crossval(fit.t37.notrim, cv.method="loo")

#perform randomization t-test to test the significance of a cross-validated model....
#rand.t.test(fit.t7.cv) 
#rand.t.test(fit.t7.nt.cv)
#rand.t.test(fit.t13.cv) 
#rand.t.test(fit.t13.nt.cv) #marginally-significant Comp02
#rand.t.test(fit.t25.cv) 
#rand.t.test(fit.t25.nt.cv)
```

### time 7, 13, and 25

**none of the community components are significant predictors**

### time 37

**Comp01 is significant (whole community)**

```{r, echo=FALSE}
#rand.t.test(fit.t37.cv) # signif Comp02, but very little added info in Comp02 so do not interpret
rand.t.test(fit.t37.nt.cv) #signif Comp01
```

This is likely an underlying signature of wood traits on the initial microbial community that is driving the relationship between the community and the mass remaining after 37 months.  Check this out by plotting OTU trait-associated coefs (from boral) versus component coef estimate.

Investigate the biology underlying time37-associated coefs for Comp01
```{r, echo=FALSE, message=FALSE, warning=FALSE}
coef.comp<-fit.t37.nt.cv$coefficients[,'Comp01']
coef.comp.df<-data.frame(OTUId=names(coef.comp), coefComp=coef.comp)

#create df of OTU taxon and guild info matched with coef value
coef.comp.df %>% left_join(taxAndFunguild) -> coef.comp.ann
unique(coef.comp.ann$kingdom)

# #define cols
# colvals<-rainbow_hcl(length(unique(coef.comp.ann$Trophic.Mode)))
# names(colvals)<-unique(coef.comp.ann$Trophic.Mode)
# colvals['unclassified']<-"#D3D3D3"

p.troph<-ggplot(coef.comp.ann, aes(x=Trophic.Mode, y=coefComp)) + 
  geom_jitter() + coord_flip() +
  xlab("Trophic mode") + ylab("Component coefficient estimate") +
  theme_classic() +
  geom_hline(yintercept=0, linetype=2)

p.king<-ggplot(coef.comp.ann, aes(x=kingdom, y=coefComp)) + 
  geom_jitter() + coord_flip() +
  xlab("Kingdom") + ylab("Component coefficient estimate") +
  theme_classic() +
  geom_hline(yintercept=0, linetype=2)

p.phylum<-ggplot(coef.comp.ann, aes(x=phylum, y=coefComp)) + 
  geom_jitter() + coord_flip() +
  xlab("Phylum") + ylab("Component coefficient estimate") +
  theme_classic() +
  geom_hline(yintercept=0, linetype=2)

grid.arrange(p.troph, p.king, p.phylum)



#plot these OTU decay coef versus waterperc coef from boral model

```

Look at the relationship between OTU wood trait coefs and the WA-PLS component scores
```{r}

xVar.df<-read.csv("data/xVar_OTUcoefs.csv", row.names=1) #import wood trait coefs estimated by boral in the wooddecay repo

xVar.df %>%
  left_join(coef.comp.ann) %>% # left join is going to drop the oomycetes that weren't included in the boral analysis
  filter(runNum=="runNum1") -> tmp.df #just look at the first model run estimates

# look at the wood traits included in the best model to explain pmr at 37 months
# larger size stems, less water content, less thick bark, (more P and Mn -- small effect sizes), and more C leads to more mass remaining after 37 months
# size was included as a roweffect in the boral model, so there are no OTU-specific estimates

tmp.df %>%
  select(OTUId, phylum, Trophic.Mode, coefComp, waterperc, barkthick, C) %>%
  gather(key="trait", value="coefEst", -(1:4)) %>%
  arrange(-coefComp) -> tmp.df1

#check out outliers
#tmp.df1[1:20,] #very few of the top ranking OTUs are taxon ID'd

p<-ggplot(tmp.df1, aes(x=coefEst, y=coefComp)) + 
  geom_point() + theme_bw() +
  ylab("Assoc. w/ more mass at 37 mo. (WA-PLS score)") + 
  xlab("Wood trait response (boral coef estimate)") +
  facet_wrap(phylum~ trait)
p

tmp.df1 %>%
  filter(phylum=="Ascomycota") %>%
  filter(trait=="barkthick") -> tmp

mod<-lm(coefComp ~ coefEst, data=tmp)
summary(mod) 
# signif relationship w/in ascos+barkthick (not on whole community)
```
When looking at these barkthickness OTU coefs, remember that the boral model was fit based on small species-level bark thickness data...

The asco response to barkthickness is driving the WA-PLS association. It also seems like there are some asco and basidio outliers that are associated with low water content and carry decay information.


```{r}

tmp.df1 %>%
  filter(Trophic.Mode %in% c("Pathotroph","Saprotroph")) -> tmp

p<-ggplot(tmp, aes(x=coefEst, y=coefComp)) + 
  geom_point() + theme_bw() +
  ylab("Assoc. w/ more mass at 37 mo. (WA-PLS score)") + 
  xlab("Wood trait response (boral coef estimate)") +
  facet_grid(Trophic.Mode~ trait)
p

tmp %>%
  filter(trait=="barkthick") %>%
  filter(Trophic.Mode=="Saprotroph")-> tmp.bt.sap

mod<-lm(coefComp ~ coefEst, data=tmp.bt.sap)
summary(mod) 
# signif relationship w/in sapros+barkthick (not on whole community)

tmp %>%
  filter(trait=="waterperc") %>%
  filter(Trophic.Mode=="Saprotroph")-> tmp.bt.wp

mod<-lm(coefComp ~ coefEst, data=tmp.bt.wp)
summary(mod) 
# NOT a signif relationship w/in sapros+waterperc

```
Known saprotrophs respond to barkthickness and in doing so predict decay.  In contrast, the response of pathogens to barkthickness does not carry information about decay. There's also a non-significant but trending relationship between saprotroph responses to water content and decay. --- This is getting a bit far from the real data, but still intriguing?
I *think* this shows that the presence of a given bark-phillic (and water-phobic) saprotroph in the initial community is more likely to explain mass remaining than the presence of non-saprotroph with an equally strong bark 'preference'.


##########################################

# Community+traits as a predictor

## *Hyp1 (stem-level)* After accounting for variation in decay due to wood traits (no models with density, includes small-species level bark thickness), stem-specific initial microbial communitiy compositions will predict variation in percent mass loss, particularly in the early stages of decay.

```{r, include=FALSE, results=FALSE, message=FALSE}
#run rioja::WAPLS on wood trait residuals

dataset.t7<-CreateCommTraitResidpair(timePoint="time7", comm.mat = comm.otu.trimmed, 
                                      traitResid = traitResid.t7)
dataset.t13<-CreateCommTraitResidpair(timePoint="time13", comm.mat = comm.otu.trimmed, 
                                      traitResid = traitResid.t13)
dataset.t25<-CreateCommTraitResidpair(timePoint="time25", comm.mat = comm.otu.trimmed, 
                                      traitResid = traitResid.t25)
dataset.t37<-CreateCommTraitResidpair(timePoint="time37", comm.mat = comm.otu.trimmed, 
                                      traitResid = traitResid.t37)

dataset.t7.notrim<-CreateCommTraitResidpair(timePoint="time7", comm.mat = comm.otu, 
                                      traitResid = traitResid.t7)
dataset.t13.notrim<-CreateCommTraitResidpair(timePoint="time13", comm.mat = comm.otu, 
                                      traitResid = traitResid.t13)
dataset.t25.notrim<-CreateCommTraitResidpair(timePoint="time25", comm.mat = comm.otu, 
                                      traitResid = traitResid.t25)
dataset.t37.notrim<-CreateCommTraitResidpair(timePoint="time37", comm.mat = comm.otu, 
                                      traitResid = traitResid.t37)


#fit models
fit.tr.t7 <- WAPLS(dataset.t7[['comm']], dataset.t7[['traitresid']]$trait.resid)
fit.tr.t13 <- WAPLS(dataset.t13[['comm']], dataset.t13[['traitresid']]$trait.resid)
fit.tr.t25 <- WAPLS(dataset.t25[['comm']], dataset.t25[['traitresid']]$trait.resid)
fit.tr.t37 <- WAPLS(dataset.t37[['comm']], dataset.t37[['traitresid']]$trait.resid)
fit.tr.t7.nt <- WAPLS(dataset.t7.notrim[['comm']], dataset.t7.notrim[['traitresid']]$trait.resid)
fit.tr.t13.nt <- WAPLS(dataset.t13.notrim[['comm']], dataset.t13.notrim[['traitresid']]$trait.resid)
fit.tr.t25.nt <- WAPLS(dataset.t25.notrim[['comm']], dataset.t25.notrim[['traitresid']]$trait.resid)
fit.tr.t37.nt <- WAPLS(dataset.t37.notrim[['comm']], dataset.t37.notrim[['traitresid']]$trait.resid) #look at more components with the argument npls=20

#cross-validate models using the leave-one-out method
fit.tr.t7.cv <- crossval(fit.tr.t7, cv.method="loo")
fit.tr.t13.cv <- crossval(fit.tr.t13, cv.method="loo")
fit.tr.t25.cv <- crossval(fit.tr.t25, cv.method="loo")
fit.tr.t37.cv <- crossval(fit.tr.t37, cv.method="loo")
fit.tr.t7.cv.nt <- crossval(fit.tr.t7.nt, cv.method="loo")
fit.tr.t13.cv.nt <- crossval(fit.tr.t13.nt, cv.method="loo")
fit.tr.t25.cv.nt <- crossval(fit.tr.t25.nt, cv.method="loo")
fit.tr.t37.cv.nt <- crossval(fit.tr.t37.nt, cv.method="loo")

#perform randomization t-test to test the significance of a cross-validated model
#rand.t.test(fit.tr.t7.cv) 
#rand.t.test(fit.tr.t7.cv.nt)
#rand.t.test(fit.tr.t13.cv) 
#rand.t.test(fit.tr.t13.cv.nt) # comp2 has a signif pval, but...
#screeplot(fit.tr.t13.cv.nt)# the cross-validated RMSE is way higher than the model RMSE, suggesting that even the first component doesn't perform well on the leave-one-out validation dataset, plus the R2 just decreases with more components

#rand.t.test(fit.tr.t25.cv) 
#rand.t.test(fit.tr.t25.cv.nt)
#rand.t.test(fit.tr.t37.cv) 
#rand.t.test(fit.tr.t37.cv.nt) # comp2 has a signif pval, but...
#screeplot(fit.tr.t37.cv.nt) # again, the cross-validated RMSE is way higher than the model RMSE, suggesting that even the first component doesn't perform well on the leave-one-out validation dataset, plus the R2 just decreases with more components


```

### time 7, 13, 25, 37

**none of the community components are significant predictors**

Closer look at time13 findings...  
```{r, echo=FALSE}
rand.t.test(fit.tr.t13.cv.nt) # comp2 has a signif pval, but...
screeplot(fit.tr.t13.cv.nt)# the cross-validated RMSE is way higher than the model RMSE, suggesting that even the first component doesn't perform well on the leave-one-out validation dataset, plus the R2 just decreases with more components
```  

Closer look at time37 findings...  
```{r, echo=FALSE}
rand.t.test(fit.tr.t37.cv.nt) # comp2 has a signif pval, but...
screeplot(fit.tr.t37.cv.nt)# the cross-validated RMSE is way higher than the model RMSE, suggesting that even the first component doesn't perform well on the leave-one-out validation dataset, plus the R2 just decreases with more components
```  

There are two cases where there's a large % decrease in model RMSE from Component 1 to Component 2. This happens when using the whole community dataset to predict trait residuals at time13 and time37. In both cases the cross-validated RMSE is way higher than the model RMSE for all the components, suggesting that even the first community component doesn't perform well on the leave-one-out validation dataset.  Also, the cross-validated R-squared values (correlation between the observed and predicted values from the "loo" validation dataset) show that the model fit decreases after Component 1.  If there were a global maximum such that we saw an increase in R2 after adding more Components then maybe we could interpret Component 2, but there is no evidence of a better fitting model with more components based on the cross-validation results.



##########################################

# Diversity (and diversity of specific clades) as a predictor  

**Note that the full community matrix was used for these analyses**

## *Hyp-a (stem-level)* Greater microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will lead to less mass remaining esp. at early time steps because of the selection effect for fast decayers and complementarity among taxa for decay.  
Hyp-Alt: Greater microbial diversity will lead to more mass remaining because taxa will be allocating more of their resources to combat one another.

```{r}

# summarize the diversity in each sample
rich.df<-Calc_richOTU(taxAndFunguild, comm.otu) #these have codeStem rows that need to be excluded because it just used the seq_sampName information....this will get fixed in the next step
H.df<-Calc_H.OTU(taxAndFunguild, comm.otu)

# create a merged df with pmr
rich.pmr<-left_join(pmr.byStem.df.w, rich.df) %>% filter(!is.na(seq_sampName))
H.pmr<-left_join(pmr.byStem.df.w, H.df) %>% filter(!is.na(seq_sampName))

# fit models
mod1<-lm(time7~size+sub_rich, data=rich.pmr)
mod2<-lm(time13~size+sub_rich, data=rich.pmr)
mod3<-lm(time25~size+sub_rich, data=rich.pmr)
mod4<-lm(time37~size+sub_rich, data=rich.pmr)
mod.rich.list<-list(mod1, mod2, mod3, mod4)

mod1<-lm(time7~size+sub_rich, data=H.pmr)
mod2<-lm(time13~size+sub_rich, data=H.pmr)
mod3<-lm(time25~size+sub_rich, data=H.pmr)
mod4<-lm(time37~size+sub_rich, data=H.pmr)
mod.H.list<-list(mod1, mod2, mod3, mod4)

#summary
#lapply(mod.rich.list, summary)
#lapply(mod.H.list, summary)

#example plots
#ggplot(rich.pmr, aes(y=time7, x=sub_rich)) + geom_point() + 
#  ylab("Mass remaining after 7 months (%)") + xlab("OTU richness")
#ggplot(H.pmr, aes(x=time7, y=sub_rich)) + geom_point() +
#  ylab("Mass remaining after 7 months (%)") + xlab("OTU diversity (H)")

```

### Richness, Shannon's H

**No pattern**


## *Hyp-b (stem-level)* Greater saprotroph and basidiomycete richness will lead to less mass remaining esp. at early time steps because the community does not need to wait for the arrival of key decayers to act on the wood substrate.  
Hyp-Alt: Greater saprotroph and basidiomycete richness will lead to more mass remaining because decayers will be allocating more of their resources to combat one another.

```{r}

# summarize the presence of ... in each sample
sapro.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Sapro", taxAndFunguild, comm.otu=comm.otu)  
basidio.df<-Calc_richOTUtype(colNam="phylum", grepTerm="Basid", taxAndFunguild, comm.otu=comm.otu)

# create a merged df wtih spdf
sapro.pmr<-left_join(pmr.byStem.df.w, sapro.df) %>% filter(!is.na(seq_sampName))
basidio.pmr<-left_join(pmr.byStem.df.w, basidio.df) %>% filter(!is.na(seq_sampName))

# fit models
mod1<-lm(time7~size+sub_rich, data=sapro.pmr)
mod2<-lm(time13~size+sub_rich, data=sapro.pmr)
mod3<-lm(time25~size+sub_rich, data=sapro.pmr)
mod4<-lm(time37~size+sub_rich, data=sapro.pmr)
mod.sapro.list<-list(mod1, mod2, mod3, mod4)

mod1<-lm(time7~size+sub_rich, data=basidio.pmr)
mod2<-lm(time13~size+sub_rich, data=basidio.pmr)
mod3<-lm(time25~size+sub_rich, data=basidio.pmr)
mod4<-lm(time37~size+sub_rich, data=basidio.pmr)
mod.basidio.list<-list(mod1, mod2, mod3, mod4)

#summary
#lapply(mod.sapro.list, summary)
#lapply(mod.basidio.list, summary)

#example plots
#ggplot(sapro.pmr, aes(y=time7, x=sub_rich)) + geom_point() + 
#  ylab("Mass remaining after 7 months (%)") + xlab("Saprotroph richness")
#ggplot(basidio.pmr, aes(x=time7, y=sub_rich)) + geom_point() +
#  ylab("Mass remaining after 7 months (%)") + xlab("Basidio richness")


```

### Saprotroph richness, Basidio richness

**No pattern**


## *Hyp-c (stem-level)* Greater pathogen and oomycete richness will lead to more mass remaining because the presence of these organisms will inhibit the establishment and activity of decayers.

```{r}

# summarize the presence of ... in each sample
patho.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Patho", taxAndFunguild, comm.otu=comm.otu)  
oomy.df<-Calc_richOTUtype(colNam="kingdom", grepTerm="Protist", taxAndFunguild, comm.otu=comm.otu)

# create a merged df with pmr
patho.pmr<-left_join(pmr.byStem.df.w, patho.df) %>% filter(!is.na(seq_sampName))
oomy.pmr<-left_join(pmr.byStem.df.w, oomy.df) %>% filter(!is.na(seq_sampName))

# fit models
mod1<-lm(time7~size+sub_rich, data=patho.pmr)
mod2<-lm(time13~size+sub_rich, data=patho.pmr)
mod3<-lm(time25~size+sub_rich, data=patho.pmr)
mod4<-lm(time37~size+sub_rich, data=patho.pmr)
mod.patho.list<-list(mod1, mod2, mod3, mod4)

mod1<-lm(time7~size+sub_rich, data=oomy.pmr)
mod2<-lm(time13~size+sub_rich, data=oomy.pmr)
mod3<-lm(time25~size+sub_rich, data=oomy.pmr)
mod4<-lm(time37~size+sub_rich, data=oomy.pmr)
mod.oomy.list<-list(mod1, mod2, mod3, mod4)

#summary
#lapply(mod.patho.list, summary)
#lapply(mod.oomy.list, summary)

#example plots
#ggplot(patho.pmr, aes(y=time7, x=sub_rich)) + geom_point() + 
#  ylab("Mass remaining after 7 months (%)") + xlab("Pathogen richness")
#ggplot(oomy.pmr, aes(x=time7, y=sub_rich)) + geom_point() +
#  ylab("Mass remaining after 7 months (%)") + xlab("Oomycete richness")


```

### Pathogen richness, oomycete richness

**No pattern**





##############################################

# Diversity plus traits as a predictor

## *Hyp (stem-level)* After accounting for variation in decay due to wood traits, initial microbial diversity (richness, Shannon diversity, ... add phylogenetic diversity) will predict variation in percent mass loss, esp. at early time points.

```{r}

# summarize the presence of ... in each sample (same as chunks above)
rich.df<-Calc_richOTU(taxAndFunguild, comm.otu) 
H.df<-Calc_H.OTU(taxAndFunguild, comm.otu)
sapro.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Sapro", taxAndFunguild, comm.otu=comm.otu)  
basidio.df<-Calc_richOTUtype(colNam="phylum", grepTerm="Basid", taxAndFunguild, comm.otu=comm.otu)
patho.df<-Calc_richOTUtype(colNam="Trophic.Mode", grepTerm="Patho", taxAndFunguild, comm.otu=comm.otu)  
oomy.df<-Calc_richOTUtype(colNam="kingdom", grepTerm="Protist", taxAndFunguild, comm.otu=comm.otu)

# create a merged df with trait residuals
trait.residuals.list<-list(t7=traitResid.t7, 
                           t13=traitResid.t13, 
                           t25=traitResid.t25, 
                           t37=traitResid.t37)

#merge the trait residuals and diversity dataframe
rich.tr.list<-Create_rich_tr_DF(trait.residuals.list, rich.df)
H.tr.list<-Create_rich_tr_DF(trait.residuals.list, H.df)
sapro.tr.list<-Create_rich_tr_DF(trait.residuals.list, sapro.df)
basidio.tr.list<-Create_rich_tr_DF(trait.residuals.list, basidio.df)
patho.tr.list<-Create_rich_tr_DF(trait.residuals.list, patho.df)
oomy.tr.list<-Create_rich_tr_DF(trait.residuals.list, oomy.df)

# fit models
mod.rich<-FitResid_diversity_byStem(rich.tr.list)
mod.H<-FitResid_diversity_byStem(H.tr.list)
mod.sapro<-FitResid_diversity_byStem(sapro.tr.list)
mod.basidio<-FitResid_diversity_byStem(basidio.tr.list)
mod.patho<-FitResid_diversity_byStem(patho.tr.list)
mod.oomy<-FitResid_diversity_byStem(oomy.tr.list)

# summary
#lapply(mod.rich, summary)
#lapply(mod.H, summary)
#lapply(mod.sapro, summary)
#lapply(mod.basidio, summary)
#lapply(mod.patho, summary)
#lapply(mod.oomy, summary)


#example plots
ggplot(rich.tr.list[['t7']], aes(y=trait.resid, x=sub_rich)) + geom_point() + 
  ylab("Trait residuals at 7 months") + xlab("OTU richness")

```

### Richness, Shannon's H, Saprotroph richness, Basidio richness, Pathogen richness, Oomycete richness

**No pattern**




##############################################

# Relationship between wood traits and community

## *Hyp (stem-level)* Initial microbial communitiy compositions will covary with initial wood traits

```{r}

#stem-level trait set
traits.codeStem %>%
    filter(!is.na(waterperc) & !is.na(P) & !is.na(K) & 
             !is.na(Ca) & !is.na(Mn) & !is.na(Fe) & !is.na(Zn) & !is.na(N) & !is.na(C)) -> curr.traits
  
#add species-level traits, get rid of rows for which there is missing community data
  traits.mean %>%
    select(code, barkthick) %>%
    rename('barkthick_smspp'='barkthick')-> select.traits.mean
  curr.traits %>%
    left_join(select.traits.mean) %>%
    filter(codeStem %in% row.names(comm.otu)) %>%
    select(codeStem, size, waterperc, barkthick_smspp, P, K, Ca, Mn, Fe, Zn, N, C) -> curr.traits

#make sure dimensions of the community matrix match
comm.otu1<-comm.otu[row.names(comm.otu) %in% curr.traits$codeStem,]

#make a envVars matrix for model fitting
envVars<-as.matrix(curr.traits[,-(1:2)])

#fit models
fit.cca <- cca(comm.otu1 ~ envVars)
#fit.cca
#plot(fit.cca)
anova(fit.cca)

```




##############################################

## Extra pieces

1. *code/testing_time_zero.Rmd* -- Including t=0 points to fit decay model affects the liklihood and the model selection criteria, but the curve fits are identical with this formulation.  Excluding the t=0 fits has an effect of prefering simpler models, which is the same effect as increasing the penalty for model complexity. 

2. *code/initialDist_vs_decayDist_btwCode.Rmd* -- No apparent relationship between species+size dissimilarities in initial microbial community composition (bray and jaccard) and decay trajectory params

3. *code/boralOTUpairs_vs_decay.Rmd* -- No apparent relationship between frequency of boral-ID'd positively/negatively correlated OTU pairs and decay params

4. *code/withinInitialDist_vs_decayR2.Rmd* -- No apparent relationship between initial microbial diversity WITHIN species+size and decay model R2

5. *code/unexpectedTaxa.Rmd* -- Mycorrhizal fungi and animal-associated fungi that somehow made it into our OTU table

6. *code/code_level_analyses.Rmd* -- Aggregated data to the code level, taking trait means, community means, and estimating the fit params for each code's decay trajectory in neg.exp and weibold models...   

### **Code-level findings**  

- Traits explain ~ 60-70% of variation in decay over 37 months (r2, k, t70)  

    a. Greater water content and greater Zn and N leads to better-fitting decay models
    b. Small size stems, greater water content, thinner bark, less Ca, more Zn, and more N lead to faster decay  
    c. Small stem sizes, less water content, thicker bark, more Ca, less Zn, and less N lead to longer wood “70%”-lives
    
- Neither community components, overall diversity, nor clade-based diversity metrics are significant predictors of r2, k, t70  

- After accounting for variation in decay due to wood traits, neither the community components, overall diversity, nor clade-based diversity metrics are significant predictors of r2, k, t70



