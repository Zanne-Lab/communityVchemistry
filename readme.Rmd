---
title: "Community v chemistry -- Recent analyses"
date: "10/23/2017"
output: github_document
---

## Repo outline

### Main analyses

1. How do wood species and sizes vary in decay?
- script: *decayPatterns.Rmd*
- summary: output/decayfits.pdf

2. Do wood traits explain decay? 
- script: *woodtraits_explainDecay.Rmd*
- summary: 
    - Fast decayers (alpha) have low density
    - Samples with S-shaped trajectories (beta) have low N and high density
    - Difficult to predict decayers (low r2) have low N, high density, and belong to the small size class
    - Low water content predicts more mass remaining across all time points
    - Low N and small size class predict more mass remaining at early-mid time points
    - High C predicts more mass remaining at late time points

3. Does endophyte composition explain decay?
- script: *endoComp_explainDecay.Rmd*
- summary: No. There is a relationship between composition and percent mass remaining after 37 months, but this is likely driven by the role of water content (and P?) on the microbial community and decay.

4. Does endophyte diversity explain decay? *
- script: *endoDiv_explainDecay.Rmd*
- summary:
    - More saprotrophs leads to less mass remaining after 25 and 37 months, but only in small stems
    - More pathotrophs leads to less mass remaining after 37 months, but only in small stems
    - Higher saprotroph richness leads to faster decay than would be expected based on wood traits alone
    - Higher saprotroph richness leads to trajectories that are less s-shaped than based on wood traits alone


### Other pieces

- How does including t=0 points affect the decay model fit? Including it affects the liklihood and the model selection criteria, but the curve fits are identical.  Excluding t=0 leads to prefering simpler models, which is the same effect as increasing the penalty for model complexity -- *code/testing_time_zero.Rmd* 

- Do endophyte community dissimilarities correlate with decay trajectory parameters? No relationships -- *code/initialDist_vs_decayDist_btwCode.Rmd*

- Is there a relationship between the frequency of highly correlated (negative or positive) OTU pairs identified via boral and decay parameters? Nope -- *code/boralOTUpairs_vs_decay.Rmd*

- Is there a relationship between initial microbial diversity WITHIN species+size categories and decay model R2? Nope -- *code/withinInitialDist_vs_decayR2.Rmd*

- Exclude mycorrhizal fungi and animal-associated fungi that somehow made it into our OTU table -- *code/unexpectedTaxa.Rmd*


## Make figures

```{r loadforfigs}
#libraries, fxns, data

#---------------------------#
#libraries
library(knitr) #r markdown
library(readr) #read/write
library(magrittr) #data formatting
library(tidyr) #data formatting
library(dplyr) #data formatting
library(ggplot2) #plotting
library(grid) #plotting
library(gridExtra)
library(corrplot)

#devtools::install_github("cornwell-lab-unsw/litterfitter") #fit decay models to timeseries
#library(litterfitter) #fit decay models to timeseries
#library(lmtest) # for coxtest()
#library(vegan) #diversity metrics
#library(rioja) #WA-PLS

#---------------------------#
#fxns
source("code/load_microbeData_fxns.R")
source("code/load_traitData_fxns.R")
source("code/load_decayData_fxns.R")
source("code/check_fxns.R")
source("code/summaryTable_fxns.R")
source("code/analysisDF_fxns.R")

#---------------------------#
#data -- microbes and sample meta

stemSamples <- load_stemSamples() # in code/load_microbeData_fxns.R
fung.otu <- load_matotu() 
comm.otu <- add_oomycetes(fung.otu) #add the oomycetes
seqSamples <- load_seqSamples(comm.otu, stemSamples) #create sequence sample meta data table
taxAndFunguild <- load_TaxAndFunguild(comm.otu) #taxon lookup info

#---------------------------#
#data -- wood traits

# all trait data
#trait.data.l <- mergeTraitData()
#head(trait.data.l)
#rm(trait.data.l)

# averaged by code
#if fill.densitybark == TRUE, then use small stem estimates to approximate large stem density and bark thickness
traits.code <- trait.means_byCode(stemSamples, fill.densitybark = TRUE)
#trait.sds_byCode(stemSamples) # within code variation
#trait.n_byCode(stemSamples) # number of code samples that were aggregated

# averaged by codeStem
traits.stem <- trait.means_byStem(stemSamples)
#trait.sds_byStem(stemSamples) # within codeStem variation
#trait.n_byStem(stemSamples) # number of codeStem samples that were aggregated

#---------------------------#
#data -- mass loss

# load mass loss data and calculate percent mass remaining (pmr)
initial_mass <- read_in_initial_mass()
harvest_mass <- LoadHarvestFiles()
pmr <- Calc_massRemaining(initial_mass, harvest_mass)

# average pmr for each stem and timepoint
pmr_byStem <- AvgPMR_byStem(pmr)

#---------------------------#
# calculate decay trajectory fits for each species+size

#decayfits <- fit_all_curves(pmr, stemSamples) #this recalculates all the curve fits, uncomment if the data changes
#write_csv(decayfits,"derived_data/decayfits.csv")
decayfits <- read_csv("derived_data/decayfits.csv")
indx <- unique(stemSamples[,c("code","Binomial","size")])
decayfits %>%
  left_join(indx) -> decayfits

# weibull params
# alpha = shape param
# beta = scale param

```

Main text figures
```{r}
#decayPatterns
makefig__decayfits(decayfits) # output/figures/maintext/decayfits.pdf
makefig__pmr_byStem(pmr_byStem) # output/figures/maintext/pmr_byStem.pdf

#woodtraits_explainDecay
makefig__traits_explain_decayParams(traits.stem, traits.code, pmr_byStem) # output/figures/maintext/traits_explain_decayparams.pdf
makefig__traits_explain_pmr(traits.stem, traits.code, pmr_byStem) # output/figures/maintext/traits_explain_pmr.pdf

```

Supplementary figures
```{r}
#decayPatterns
makefig__compare_t60(decayfits) # output/figures/supplementary/compare_t60.pdf
makefig__compare_aic(decayfits) # output/figures/supplementary/compare_aic.pdf

#woodtraits_explainDecay
makefig__variation_densityNbarkthick(traits.stem, traits.code, pmr_byStem) # output/figures/supplementary/variation_densityNbarkthick.pdf

  
```


3. Does endophyte composition explain decay?
- script: *endoComp_explainDecay.Rmd*

4. Does endophyte diversity explain decay? *
- script: *endoDiv_explainDecay.Rmd*




## Recent findings

```{r, include = F}
#chunk options

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

Load libraries, functions, data
```{r load}
#libraries, fxns, data

#---------------------------#
#libraries
library(knitr) #r markdown
library(readr) #read/write
library(magrittr) #data formatting
library(tidyr) #data formatting
library(dplyr) #data formatting
library(ggplot2) #plotting
library(grid) #plotting
library(gridExtra)
library(corrplot)

#devtools::install_github("cornwell-lab-unsw/litterfitter") #fit decay models to timeseries
library(litterfitter) #fit decay models to timeseries
#library(lmtest) # for coxtest()
#library(vegan) #diversity metrics
#library(rioja) #WA-PLS

#---------------------------#
#fxns
source("code/load_microbeData_fxns.R")
source("code/load_traitData_fxns.R")
source("code/load_decayData_fxns.R")
source("code/check_fxns.R")
source("code/summaryTable_fxns.R")
source("code/analysisDF_fxns.R")

#---------------------------#
#data -- microbes and sample meta

stemSamples <- load_stemSamples() # in code/load_microbeData_fxns.R
fung.otu <- load_matotu() 
comm.otu <- add_oomycetes(fung.otu) #add the oomycetes
seqSamples <- load_seqSamples(comm.otu, stemSamples) #create sequence sample meta data table
taxAndFunguild <- load_TaxAndFunguild(comm.otu) #taxon lookup info

#---------------------------#
#data -- wood traits

# all trait data
#trait.data.l <- mergeTraitData()
#head(trait.data.l)
#rm(trait.data.l)

# averaged by code
#if fill.densitybark == TRUE, then use small stem estimates to approximate large stem density and bark thickness
traits.code <- trait.means_byCode(stemSamples, fill.densitybark = TRUE)
#trait.sds_byCode(stemSamples) # within code variation
#trait.n_byCode(stemSamples) # number of code samples that were aggregated

# averaged by codeStem
traits.stem <- trait.means_byStem(stemSamples)
#trait.sds_byStem(stemSamples) # within codeStem variation
#trait.n_byStem(stemSamples) # number of codeStem samples that were aggregated

#---------------------------#
#data -- mass loss

# load mass loss data and calculate percent mass remaining (pmr)
initial_mass <- read_in_initial_mass()
harvest_mass <- LoadHarvestFiles()
pmr <- Calc_massRemaining(initial_mass, harvest_mass)

# average pmr for each stem and timepoint
pmr_byStem <- AvgPMR_byStem(pmr)

#---------------------------#
# calculate decay trajectory fits for each species+size

#decayfits <- fit_all_curves(pmr, stemSamples) #this recalculates all the curve fits, uncomment if the data changes
#write_csv(decayfits,"derived_data/decayfits.csv")
decayfits <- read_csv("derived_data/decayfits.csv")
indx <- unique(stemSamples[,c("code","Binomial","size")])
decayfits %>%
  left_join(indx) -> decayfits

# weibull params
# alpha = shape param
# beta = scale param

```

Load new data
```{r}
cfract <- read_csv(file = "data/Marissa_Chemistry_Data_export.csv")
cfract <- cfract[complete.cases(cfract),] # get rid of empty row from the excel file
```

I think there is a typo and JASC2 was entered twice instead of JASC3. My original datasheet that I sent included JASC3. It would be good to double check this with Shawn's lab.
```{r}
cfract[cfract$codeStem == "JASC2",c("codeStem","labID")]

#replace
cfract %>%
  mutate(codeStem = ifelse(codeStem == "JASC2" &  labID %in% c(47,48), 
                           "JASC3", 
                           codeStem)) -> cfract
```

Look for analytical reps that are way different
```{r}
num.out <- length(unique(cfract$labID))/2
cfract %>%
  mutate(rep = paste0("rep",rep(c(1,2), times = num.out))) %>%
  select(codeStem, rep, perc.Total.lignin, Arabinose, Rhamnose, Galactose, Glucose, Xylose, Mannose, Total) %>%
  gather(key = "type", value = "value", -c(codeStem, rep)) %>%
  spread(key = rep, value = value) %>%
  mutate(diff = abs(rep1 - rep2)) -> tmp

#plot difference between analytical rep1 and rep2
ggplot(tmp, aes(x = codeStem, y = diff)) +
  geom_point() +
  facet_wrap(~type, scales = "free_x") +
  theme_bw() +
  coord_flip()

```

Maybe go back and investigate the JASC/Arabinose and ACPA/Xylose outliers. For now, just average the analytical reps and merge with traits.stem (see code/load_traitData_fxns.R)

Check out correlations among C fractions and other traits. Exclude two samples for which there isn't waterperc data. Remember that there is no stem-level barkthick or density data for large stem samples.
```{r}
cfract.load<- load_Cfract()
traits.stem %>%
  left_join(cfract.load) %>%
  filter(!is.na(Total)) %>%
  select(-c(barkthick, density)) -> traits.stem.sel

#two samples are missing waterperc data
traits.stem.sel %>%
  filter(is.na(waterperc)) %>%
  select(codeStem, waterperc) 

#remove them
traits.stem.sel %>%
  filter(!is.na(waterperc)) -> traits.stem.sel

#grab just the matrix of traits
traits.stem.sel %>%
  select(-c(species, size, code, unique, Stem)) -> matonly
matonly.s <- scale(as.matrix(matonly[,-1]))

# plot correlations
corrplot(cor(matonly.s), type = "lower")
```

Check out samples in trait space
```{r}
pca <- prcomp(matonly.s)
df <- data.frame(pca$x[,1:2], 
                 traits.stem.sel[,c("codeStem","species","code","size")])
datapc <- data.frame(varnames=rownames(pca$rotation), pca$rotation[,1:2])
mult <- min(
  (max(df[,"PC1"]) - min(df[,"PC2"])/(max(datapc[,"PC2"])-min(datapc[,"PC2"]))),
  (max(df[,"PC2"]) - min(df[,"PC1"])/(max(datapc[,"PC1"])-min(datapc[,"PC1"])))
)
datapc <- transform(datapc,
                    v1 = .7 * mult * datapc$PC1,
                    v2 = .7 * mult * datapc$PC2)
  
plot_12 <- ggplot(data=datapc, aes(x=v1, y=v2, label=varnames)) + 
  geom_text(size=3, vjust=1, color=1) + 
  geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),
               arrow=arrow(length=unit(0.2,"cm")), alpha=0.75, color=1) + 
  coord_fixed() +
  geom_point(mapping=aes(x=PC1, y=PC2, 
                        color = species), data=df, inherit.aes = FALSE) +
  theme_bw() + xlab("PC1") + ylab("PC2")
#plot_12
#ggsave(plot_12, filename = "output/stem_traitord.pdf")
# for some reason this plot knit with more extra data points? it seems to work fine in ggsave

summary(pca)
```
![](output/stem_traitord.pdf)

Load new versions of trait data
```{r}
traits.code <- trait.means_byCode_new(stemSamples, fill.densitybark = T)
traits.stem <- trait.means_byStem_new(stemSamples)
```

Do wood C fractions explain decay?

(by code)
```{r}
#merge traits and response variables into 1 df
decayfits %>%
  select(code, species, size, 
         ne.r2, k, t70, 
         w.r2, alpha, beta, w.t70) %>%
  left_join(traits.code) %>% 
  filter(!is.na(P)) %>%
  filter(!is.na(waterperc)) -> decayfits.traits

# subset by wood fract data
decayfits.traits %>%
  filter(!is.na(Arabinose)) -> decayfits.traits

#set up full models
respVars <- list("k","t70","ne.r2", "alpha","beta","w.t70","w.r2")
rhs <- "waterperc + N + Arabinose + Galactose + Glucose + Mannose + perc.Total.lignin + Rhamnose + Xylose" # got rid of size because only looking at large stems
mod.full.list<-lapply(respVars, ModelFit_manyYs, rhs, curr.data=decayfits.traits) # summaryTable_fxns.R

#do stepwise model selection #uncomment if data changes
mod.select.list<-lapply(mod.full.list, function(x) {
  x.updated<-update(x, . ~ ., data = model.frame(x))
  mod.select<-step(x.updated, direction="backward")
  return(mod.select)
  })
names(mod.select.list) <- respVars

#plot
sum.list<-lapply(mod.select.list, summary)
coefs.df<-PullLmCoefs(sum.list, unlist(respVars))
fitstat.df<-PullLmFitStats(sum.list, unlist(respVars))
fitstat.df %>%
  gather(key = "respvar", value = "value", -c(term)) %>%
  filter(term == "r.squared") %>%
  select(-term) %>%
  rename('r.squared'=value) -> r2.df
coefs.df %>%
  left_join(r2.df) %>%
  filter(respvar %in% c("alpha","beta","w.t70","w.r2")) -> coefs.df

ggplot(coefs.df, aes(x = respvar, y = term, fill = r.squared)) +
  geom_tile() + geom_text(aes(label = round(est, digits = 2))) +
  xlab("Response variable") + ylab("Wood trait") +
  theme_classic()

```

- alpha: Codes that decay quickly have more Rhamnose
- beta: Codes with s-shaped trajectories have low N, Mannose, and Glactose
- w.r2: Codes with better model fits have more Rhamnose
- w.t70: Codes with longer "half lives" have more Rhamnose and less N

(by stem)
```{r}
# create dataframes
# stem-level waterperc, xrf, and CN and (small) species-level barkthickness and density

respVars <- list("time7", "time13", "time25", "time37","time59")
datasets<-lapply(respVars, function(x) {
  result<-CreateTraitPMRpair(x, traits.stem, traits.code, pmr_byStem) #analysisDF_fxns.R
  return(result)
})
names(datasets)<-respVars

#set up full models
rhs <- "waterperc + N + Arabinose + Galactose + Glucose + Mannose + perc.Total.lignin + Rhamnose + Xylose"
lhs <- "curr.pmr"
mod.full.list<-lapply(datasets, function(x) {
  result<-ModelFit_manyYs(y=lhs, rhs=rhs, curr.data=x)
  return(result)
})

#do stepwise model selection
mod.select.list<-lapply(mod.full.list, function(x) {
  x.updated<-update(x, . ~ ., data = model.frame(x))
  mod.select<-step(x.updated, direction="backward")
  return(mod.select)
  })

#plot
sum.list<-lapply(mod.select.list, summary)
coefs.df<-PullLmCoefs(sum.list, unlist(respVars))
fitstat.df<-PullLmFitStats(sum.list, unlist(respVars))
fitstat.df %>%
  gather(key = "respvar", value = "value", -c(term)) %>%
  filter(term == "r.squared") %>%
  select(-term) %>%
  rename('r.squared'=value) -> r2.df
coefs.df %>%
  left_join(r2.df) -> coefs.df

coefs.df$respvar<- factor(coefs.df$respvar, levels = c("time7","time13","time25","time37","time59"))

ggplot(coefs.df, aes(x = respvar, y = term, fill = r.squared)) +
  geom_tile() + geom_text(aes(label = round(est, digits = 2))) +
  xlab("Response variable") + ylab("Wood trait") +
  theme_classic()

```

- Glucose and waterperc are important for explaining pmr at each time point. Stems with low glucose and waterperc tend to have more mass remaining.
- High Rhamnose and low N are associated with more mass remaining after 25 months


