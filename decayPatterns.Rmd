---
title: "How do wood species and sizes vary in decay?"
author: "Marissa Lee"
date: "12/2/2018"
output: github_document
---
```{r, include = F}
#chunk options
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

Load libraries, functions, data
```{r load}

#---------------------------#
#libraries
library(knitr) #r markdown
library(readr) #read/write
library(magrittr) #data formatting
library(tidyr) #data formatting
library(dplyr) #data formatting
library(ggplot2) #plotting
library(grid) #plotting
library(gridExtra)
#devtools::install_github("cornwell-lab-unsw/litterfitter") #fit decay models to timeseries
library(litterfitter) #fit decay models to timeseries
#library(lmtest) # for coxtest()
#library(vegan) #diversity metrics
#library(rioja) #WA-PLS

#---------------------------#
#fxns
source('code/helper_fxns.R')
sourceDir('code')

#---------------------------#
#data

# stems in the study
stemSamples <- load_stemSamples() # this function is in load_microbeData.R

# stem mass
initial_mass <- read_in_initial_mass()
harvest_mass <- LoadHarvestFiles()
pmr <- Calc_massRemaining(initial_mass, harvest_mass) # calculate percent mass remaining (pmr)
pmr_byStem <- AvgPMR_byStem(pmr) # average pmr for each stem and timepoint

# decay fits
#decayfits <- fit_all_curves(pmr, stemSamples) #this recalculates all the curve fits, uncomment if the data changes; for each species+size
#write_csv(decayfits,"derived_data/decayfits.csv")
decayfits <- read_csv("derived_data/decayfits.csv")
indx <- unique(stemSamples[,c("code","Binomial","size")])
decayfits %>%
  left_join(indx) -> decayfits
# weibull params
# alpha = shape param
# beta = scale param

```

Plot percent mass remaining (pmr) for each sample over time
```{r}
ggplot(pmr, aes(y=pmr, x=time, color = size)) + 
  geom_point(alpha=.8) +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  facet_wrap(~species) +
  geom_smooth()
```

Compare the negative exp. vs weibull models by plotting time to 70% mass remaining (t70) for each species+size
```{r}
ggplot(decayfits,aes(x=t50,y=w.t50,col=size))+
  geom_point()+
  labs(x="Time to 50% mass loss (negative exponential)",
       y="Time to 50% mass loss (Weibull)")+
  geom_abline(slope=1,intercept=0,linetype="dashed")+theme_bw()
```

Another view...
Figure S2. Comparison of negative exp and weibull models using t70
```{r}
makefig__compare_t60(decayfits) # output/figures/supplementary/compare_t60.pdf
```
![](output/figures/supplementary/compare_t60.pdf)

Figure S3. Comparison of negative exp and weibull models using AIC
```{r}
makefig__compare_aic(decayfits) # output/figures/supplementary/compare_aic.pdf
```
![](output/figures/supplementary/compare_aic.pdf)

```{r checkmissing}
#load community data to check for missing samples
#stemSamples <- load_stemSamples()
#fung.otu <- load_matotu() 
#comm.otu <- add_oomycetes(fung.otu) #add the oomycetes
#seqSamples <- load_seqSamples(comm.otu, stemSamples)

#checkMissing_stems(traits.stem, seqSamples, pmr_byStem)

#issue #31 -- There are 2 unique codeStem ids that are found in the trait data (xrf sample names) and the sequence data, but not in the stemSamples data (deployment sample names).  These codeStem ids are not found in the percent mass loss data.  Because the main goal is to analyze decay responses, I'm going to continue to leave these codeStems out of the stemSamples dataframe. Is it possible that stem id numbers got switched? Something to follow-up on.

```


Figure 1. Wood species x decay params (weibull model)
```{r}
makefig__decayfits(decayfits) # output/figures/maintext/decayfits.pdf

```
![](output/figures/maintext/decayfits.pdf)

Figure 2. Time x percent mass remaining
```{r}
makefig__pmr_byStem(pmr_byStem) # output/figures/maintext/pmr_byStem.pdf
```
![](output/figures/maintext/pmr_byStem.pdf)






