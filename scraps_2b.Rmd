---
title: "Scraps from 2b_woodTraits_explainDecay"
author: "Marissa Lee"
date: "7/28/2020"
output: html_document
---

Note -- this is broken
```{r}
# 6 - create prediction dataframes for each trait and model

scaled.traitvars
mod.list
scaled.traitvars %>%
    purrr::set_names() %>%
    map(~preddat_fun_bysize_allmodels(models = mod.list,
                                      data = decayfits.traits, # see helper_fxns.R
                                      curr.traitVar = .x,
                                      data.list = F)) -> preddat
```


Prediction plots -- doesn't work now
```{r}
# result.traitsDecay$preddat$Ca_s %>%
#   filter(respvar == c("w.t50","beta")) -> tmp1
# tmp1
# 
# p <- ggplot(tmp1, aes(x = Ca, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   #geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = respvar, color = size)) +
#   #geom_rug(sides="b", aes(color = size)) +
#   geom_point(aes(y = respval, color = size)) +
#   labs(x = "Ca (%)",
#        y = "Decay response") +
#   theme_classic() +
#   facet_wrap(~respvar, scales = "free_y")
# p
# 
# result.traitsDecay$preddat$waterperc_s %>%
#   filter(respvar == c("w.t50","beta")) %>%
#   mutate(respvar = factor(respvar, levels = c("w.t50","beta"), 
#                          labels = c("Years to 50% mass loss",
#                                     "Scale param."))) -> tmp1
# 
# tmp1
# p <- ggplot(tmp1, aes(x = waterperc, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   geom_point(aes(y = respval, color = size)) +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = .fitted, color = size)) +
#   geom_rug(sides="b", aes(color = size)) +
#   labs(x = "Water content (% in fresh wood)",
#        y = "Decay response") +
#   theme_classic() +
#   facet_wrap(~respvar, scales = "free_y")
# p 
# 
# plots.water <- list(p)
# 
# plots.ca = list(p)

# plots_explainDecay.list[['traits.code']] <- list(plots.water = plots.water,
#                                                  plots.ca = plots.ca,
#                                                  plots.size = plots.size)

```


- Model fits: Models at mid time points tend to fit better, all models had R2 ~ 50%

- Water content was the most influential trait, especially for explaining mass loss at mid to late decay stages (25-59 months); More water led to lower percent mass remaining
- Size was also influential, especially for explaining mass loss at earlier decay stages (7 and 13 months); large stems had greater percent mass remaining during early time points

Prediction plots -- doesn't work now
```{r}
# result.traitsPMR$preddat$waterperc_s %>%
#   mutate(respvar = factor(respvar, 
#                           levels = c("time7","time13","time25","time37","time59"))) -> tmp1
# p <- ggplot(tmp1, aes(x = waterperc, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = respvar, color = size)) +
#   geom_rug(sides="b", aes(color = size)) +
#   labs(x = "Water content (% in fresh wood)",
#        y = "% Mass remaining after X months") +
#   theme_classic() +
#   facet_grid(~respvar)
# p
# 
# plots <- list(p)
# 
# plots_explainDecay.list[['traits.stem']] <- list(plots = plots)
```

- Model fits: Over 50% of variance in decay R2 and time to 50% mass loss was explained by C fractions. Less explanatory power for beta (scale) and alpha (shape).
- Lignin was the most influential trait, especially for model fit; less lignin led to better fitting models. More lignin led to longer wait times, slower decay rates (beta), and less(?) S-shaped decay (alpha).
- Rhamnose and Glucose were important in explaining variance in wait times and the scale parameter beta. More rhamanose and glucose led to longer wait times and slower decay trajectories.

Prediction plots -- doesn't work now
```{r}
result.cfractDecay$preddat$Lignin_s %>%
  mutate(respvar = factor(respvar, levels = c("w.t50","w.r2","beta","alpha"),
                          labels = c("Years to 50% mass loss",
                                     "Weibull R2",
                                     "Scale param.",
                                     "Shape param."))) -> tmp1

p <- ggplot(tmp1, aes(x = Lignin, y = .fitted, fill = size)) +
  geom_line(aes(color = size)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
  #geom_point(aes(y = .fitted, color = size)) +
  geom_rug(sides="b", aes(color = size)) +
  labs(x = "Lignin (%)",
       y = "Decay response") +
  theme_classic() +
  facet_wrap(~respvar, scales = "free_y")
p
plots.l <- list(p)

######
result.cfractDecay$preddat$Rhamnose_s %>%
  filter(respvar %in% c("w.t50","beta")) %>%
  mutate(respvar = factor(respvar, levels = c("w.t50","beta"),
                          labels = c("Years to 50% mass loss",
                                     "Scale param."))) -> tmp1

result.cfractDecay$preddat$Glucose_s %>%
  filter(respvar %in% c("w.t50","beta")) %>%
  mutate(respvar = factor(respvar, levels = c("w.t50","beta"),
                          labels = c("Years to 50% mass loss",
                                     "Scale param."))) -> tmp2

p.1 <- ggplot(tmp1, aes(x = Rhamnose, y = .fitted, fill = size)) +
  geom_line(aes(color = size)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
  #geom_point(aes(y = .fitted, color = size)) +
  geom_rug(sides="b", aes(color = size)) +
  labs(x = "Rhamnose (%)",
       y = "Decay response") +
  theme_classic() +
  facet_wrap(~respvar, scales = "free_y")
p.1

p.2 <- ggplot(tmp2, aes(x = Glucose, y = .fitted, fill = size)) +
  geom_line(aes(color = size)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
  #geom_point(aes(y = .fitted, color = size)) +
  geom_rug(sides="b", aes(color = size)) +
  labs(x = "Glucose (%)",
       y = "Decay response") +
  theme_classic() +
  facet_wrap(~respvar, scales = "free_y")
p.2

grid.arrange(p.1, p.2, ncol = 1)
plots.rhgl <- list(p.1, p.2)

######
plots_explainDecay.list[['cfract.code']] <- list(plots.l = plots.l,
                                                 plots.rhgl = plots.rhgl)
```


- Model fits: Relatively poor model fits. Maximum R2 is 0.45 and that is for time25. Minimum R2 is .17 which is for time7

- Arabinose is the only influential fraction for time7; more arabinose led to less mass remaining. Looking at the plot, this is could be driven by the high arabinose low mass remaining point...
- Xylose is the most influential fraction for time25; more xylose led to less mass remaining. Rhamnose was also influential at timethis time point; more rhamnose led to more mass remaining. Mannose was the most influential fraction for time 37; more mannose led to more mass remaining.
- Lignin was the most influential fraction for time59 (and was generally more informative at the last two time points); more lignin led to more mass remaining.

Prediction plots -- doesn't work now
```{r}
# result.cfractPMR$preddat$Arabinose_s %>%
#   mutate(respvar = factor(respvar, levels = c("time7","time13","time25","time37","time59"))) -> tmp
# 
# p.early <- ggplot(tmp, aes(x = Arabinose, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = .fitted, color = size)) +
#   geom_rug(sides="b", aes(color = size)) +
#   labs(x = "Arabinose (%)",
#        y = "% Mass remaining after X months") +
#   theme_classic() +
#   facet_grid(~respvar)
# p.early
# 
# plots.early <- list(p.early)
# 
# ####
# result.cfractPMR$preddat$Xylose_s %>%
#   mutate(respvar = factor(respvar, levels = c("time7","time13","time25","time37","time59"))) %>%
#   filter(respvar == "time25")-> tmp
# 
# p.1 <- ggplot(tmp, aes(x = Xylose, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = respval, color = size)) +
#   geom_rug(sides="b", aes(color = size)) +
#   labs(x = "Xylose (%)",
#        y = "% Mass remaining after X months") +
#   theme_classic() +
#   facet_grid(~respvar)
# p.1
# 
# result.cfractPMR$preddat$Rhamnose_s %>%
#   mutate(respvar = factor(respvar, levels = c("time7","time13","time25","time37","time59"))) %>%
#   filter(respvar %in% c("time25"))-> tmp
# 
# p.2 <- ggplot(tmp, aes(x = Rhamnose, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = .fitted, color = size)) +
#   geom_rug(sides="b", aes(color = size)) +
#   labs(x = "Rhamnose (%)",
#        y = "% Mass remaining after X months") +
#   theme_classic() +
#   facet_grid(~respvar)
# p.2
# 
# result.cfractPMR$preddat$Rhamnose_s %>%
#   mutate(respvar = factor(respvar, levels = c("time7","time13","time25","time37","time59"))) %>%
#   filter(respvar %in% c("time37"))-> tmp
# p.3 <- ggplot(tmp, aes(x = Rhamnose, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = .fitted, color = size)) +
#   geom_rug(sides="b", aes(color = size)) +
#   labs(x = "Rhamnose (%)",
#        y = "% Mass remaining after X months") +
#   theme_classic() +
#   facet_grid(~respvar)
# p.3
# 
# result.cfractPMR$preddat$Mannose_s %>%
#   mutate(respvar = factor(respvar, levels = c("time7","time13","time25","time37","time59"))) %>%
#   filter(respvar == "time37")-> tmp
# 
# p.4 <- ggplot(tmp, aes(x = Mannose, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = .fitted, color = size)) +
#   geom_rug(sides="b", aes(color = size)) +
#   labs(x = "Mannose (%)",
#        y = "% Mass remaining after X months") +
#   theme_classic() +
#   facet_grid(~respvar)
# p.4
# 
# grid.arrange(p.1, p.2, p.3, p.4)
# plots.mid <- list(p.1, p.2, p.3, p.4)
# 
# ####
# result.cfractPMR$preddat$Lignin_s %>%
#   mutate(respvar = factor(respvar, levels = c("time7","time13","time25","time37","time59"))) -> tmp
# 
# p <- ggplot(tmp, aes(x = Lignin, y = .fitted, fill = size)) +
#   geom_line(aes(color = size)) +
#   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .25) +
#   #geom_point(aes(y = respval, color = size)) +
#   geom_rug(sides="b", aes(color = size)) +
#   labs(x = "Lignin (%)",
#        y = "% Mass remaining after X months") +
#   theme_classic() +
#   facet_grid(~respvar)
# p
# 
# plots.l <- list(p)
# 
# #####
# plots_explainDecay.list[['cfract.stem']] <- list(plots.early = plots.early,
#                                                  plots.mid = plots.mid,
#                                                  plots.l = plots.l)

CreateTraitPMRpair<-function(respVar, traits.stem, traits.code, pmr_byStem, traitVars.stem){
  
  #make a dataframe using the current time point's pmr and remove NAs
  pmr_byStem %>%
    select("codeStem", respVar) %>%
    rename("curr.pmr" = respVar) %>%
    filter(!is.na(curr.pmr)) -> pmr.noNAs
  #subset the trait matrix using these unique codeStems
  traits.stem %>%
    filter(codeStem %in% pmr.noNAs$codeStem) -> curr.traits
  #make sure there are no NAs in waterperc or chemistry data
  curr.traits %>%
    filter(!is.na(waterperc) & !is.na(P) & !is.na(K) & !is.na(Ca) & !is.na(Mn) & !is.na(Fe) & !is.na(Zn) & !is.na(N) & !is.na(C)) -> curr.traits
  
  #add species-level traits
  traits.code %>%
    select(code, barkthick, density) %>%
    rename('barkthick_smspp'='barkthick',
           'density_smspp'='density')-> select.traits.code
  curr.traits %>%
    left_join(select.traits.code) -> curr.traits
  
  #get rid of pmr rows for which there is missing trait data
  pmr.noNAs %>%
    filter(codeStem %in% curr.traits$codeStem) -> curr.pmr
  
  #merge the dataframes
  curr.df<-left_join(curr.pmr, curr.traits) 
  #add code and species and size
  curr.df<-separate(curr.df, col=codeStem, into=c("code","Stem"), sep=4, remove=FALSE)
  curr.df$species<-tolower(curr.df$code)
  curr.df$size<-"large"
  curr.df[curr.df$code == tolower(curr.df$code),"size"]<-"small"
  
  return(curr.df)
  
}

doAnalysis_traits_explain_pmr <- function(datasets, stem.respVars, traitVars.stem, cfract){
  
  #isolate trait data and scale it
  datasets %>%
    map(~ungroup(.x, codeStem)) %>%
    map(~mutate_at(.x, vars(traitVars.stem), list(s = scale2))) -> datasets.s # see helper_fxns.R
  
  #set up full models
  scaled.traitvars <- paste(traitVars.stem ,"s",sep = "_")
  if(cfract == F){
    rhsVars <- paste(c("size",scaled.traitvars))
  }else{
    rhsVars <- paste(c(scaled.traitvars))
  }
  rhs <- paste(rhsVars, collapse = " + ")
  print(rhs)
  lhs <- "curr.pmr"
  
  # fit models
  datasets.s %>%
    map(~fit.lm(y = lhs, rhs, data = .x)) -> mod.full.list  # see helper_fxns.R
  
  #do stepwise model selection
  map2(.x = mod.full.list, 
       .y = datasets.s, ~backward_selection(.x, data = .y)) -> mod.select.list  # see helper_fxns.R
  
  #extract and save the residuals
  mod.select.list %>%
    map(~residuals(.x)) %>%
    map2(.y = datasets.s, 
         ~data.frame(resid=.x, codeStem = .y$codeStem)) %>%
    bind_rows(.id = "resp") -> residuals
  
  #create prediction dataframes for each trait and model
  scaled.traitvars %>%
    purrr::set_names() %>%
    map(~preddat_fun_bysize_allmodels(models = mod.select.list,
                                      data = datasets.s, # see helper_fxns.R
                                      curr.traitVar = .x,
                                      data.list = T)) -> preddat
  
  #save model fit stats
  mod.select.list %>%
    map(~summary(.x)) %>%
    map(~data.frame(Fstat = round(.x$fstatistic['value'], digits=2),
                    numdf = .x$fstatistic['numdf'],
                    dendf = .x$fstatistic['dendf'],
                    r.squared = round(.x$r.squared, digits=2))) %>%
    list_to_df() %>%
    select(-source) %>%
    t() -> fitstats

  result.traitsPMR <- list(
    data = datasets,
    respVars = stem.respVars,
    models = mod.select.list,
    residuals = residuals,
    preddat = preddat,
    fitstats = fitstats)
  
  return(result.traitsPMR)
  
}

#--------------------------------------#
# stem-level Cfractions

CreateCfractPMRpair<-function(respVar, traits.stem.cfract, pmr_byStem, traitVars.cfract){
  
  #make a dataframe using the current time point's pmr and remove NAs
  pmr_byStem %>%
    select("codeStem", respVar) %>%
    rename("curr.pmr" = respVar) %>%
    filter(!is.na(curr.pmr)) -> pmr.noNAs
  #subset the trait matrix using these unique codeStems
  traits.stem.cfract %>%
    filter(codeStem %in% pmr.noNAs$codeStem) -> curr.traits
  #make sure there are no NAs 
  curr.traits <- curr.traits[complete.cases(curr.traits),]
  
  #get rid of pmr rows for which there is missing trait data
  pmr.noNAs %>%
    filter(codeStem %in% curr.traits$codeStem) -> curr.pmr
  
  #merge the dataframes
  curr.df<-left_join(curr.pmr, curr.traits) 
  
  #add code and species and size
  curr.df<-separate(curr.df, col=codeStem, into=c("code","Stem"), sep=4, remove=FALSE)
  curr.df$species<-tolower(curr.df$code)
  curr.df$size<-"large"
  curr.df[curr.df$code == tolower(curr.df$code),"size"]<-"small"
  
  return(curr.df)
  
}


makefig__traits_explain_pmr <- function(result.list, traitVars.stem, cfract){
  
  #set up plotting dataframe
  plot.obj <- MakeLm_plottingDF(mod.list = result.list$models, respvars = result.list$respVars)
  #plot.obj$plotting.df
  #plot.obj$r2.df
  
  #define wood trait levels
  traitVars.stem.s <- c(paste(traitVars.stem, "s", sep = "_"))
  if(cfract == F){
    trait.levels <- c("sizesmall", traitVars.stem.s)
    trait.labels <- c("sizesmall", traitVars.stem)
  }else{
    trait.levels <- c(traitVars.stem.s)
    trait.labels <- c(traitVars.stem)
  }
  plot.obj$plotting.df$term <- factor(plot.obj$plotting.df$term, 
                                      levels = rev(trait.levels),
                                      labels = rev(trait.labels))
  
  #define response variable levels
  respvar.levels <- unlist(result.list$respVars)
  plot.obj$plotting.df %>%
    filter(respvar %in% respvar.levels) %>%
    mutate(respvar = factor(respvar, levels = respvar.levels)) -> plot.obj$plotting.df
  
  #plot
  plot.obj$plotting.df
  p <- ggplot(plot.obj$plotting.df, aes(x = respvar, y = term, fill = etasq)) +
    geom_tile(color = "black") + 
    geom_text(aes(label = round(est, digits = 2)), size = 3) +
    xlab("Response variable") + ylab("Wood trait") +
    theme_classic() +
    scale_fill_distiller(direction = 1) +
    scale_y_discrete(limits = rev(trait.labels))
  p
  
  result <- list(p = p, p.r2 = plot.obj$r2.df)
  return(result)
}

```


