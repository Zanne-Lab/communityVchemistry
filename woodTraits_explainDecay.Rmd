---
title: "Do wood traits explain decay?"
author: "Marissa Lee"
date: "12/2/2018"
output: github_document
---

```{r, include = F}
#chunk options

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

Load libraries, functions, data
```{r load}
#libraries, fxns, data

#---------------------------#
#libraries

library(knitr) #r markdown
library(readr) #read/write
library(magrittr) #data formatting
library(tidyr) #data formatting
library(dplyr) #data formatting
library(ggplot2) #plotting
library(grid) #plotting
library(gridExtra)
#devtools::install_github("cornwell-lab-unsw/litterfitter") #fit decay models to timeseries
library(litterfitter) #fit decay models to timeseries
library(lmtest) # for coxtest()
#library(vegan) #diversity metrics
#library(rioja) #WA-PLS

#---------------------------#
#fxns

source("code/load_microbeData_fxns.R")
source("code/load_traitData_fxns.R")
source("code/load_decayData_fxns.R")
source("code/check_fxns.R")
source("code/summaryTable_fxns.R")
source("code/analysisDF_fxns.R")

#---------------------------#
#data -- sample meta

stemSamples <- load_stemSamples() # in code/load_microbeData_fxns.R

#---------------------------#
#data -- wood traits

# all trait data
#trait.data.l <- mergeTraitData()
#head(trait.data.l)
#rm(trait.data.l)

# averaged by code
#if fill.densitybark == TRUE, then use small stem estimates to approximate large stem density and bark thickness
traits.code <- trait.means_byCode(stemSamples, fill.densitybark = TRUE)
#trait.sds_byCode(stemSamples) # within code variation
#trait.n_byCode(stemSamples) # number of code samples that were aggregated

# averaged by codeStem
traits.stem <- trait.means_byStem(stemSamples)
#trait.sds_byStem(stemSamples) # within codeStem variation
#trait.n_byStem(stemSamples) # number of codeStem samples that were aggregated

#---------------------------#
#data -- mass loss

# load mass loss data and calculate percent mass remaining (pmr)
initial_mass <- read_in_initial_mass()
harvest_mass <- LoadHarvestFiles()
pmr <- Calc_massRemaining(initial_mass, harvest_mass)

# average pmr for each stem and timepoint
pmr_byStem <- AvgPMR_byStem(pmr)

#---------------------------#
# calculate decay trajectory fits for each species+size

#decayfits <- fit_all_curves(pmr, stemSamples) #this recalculates all the curve fits, uncomment if the data changes
#write_csv(decayfits,"derived_data/decayfits.csv")
decayfits <- read_csv("derived_data/decayfits.csv")
indx <- unique(stemSamples[,c("code","Binomial","size")])
decayfits %>%
  left_join(indx) -> decayfits

# weibull params
# alpha = shape param
# beta = scale param

```

We expect initial wood traits will explain varitation in species+size decay rate (k and t70), species+size lagginess (alpha), and stem-level percent mass remaining at 7, 13, 25, and 37 months of decay. Specifically, we expect samples with (a) high water percent, (b) low density and total C, (c) high macro and micro nutrients, and (d) thicker bark (potential mech: limiting microbial colonization) to have faster decay and less lagginess. 

## *Hyp (species+size-level)* Species+size-level initial wood traits will predict variation decay rates and lagginess.
```{r}

#merge traits and response variables into 1 df
decayfits %>%
  select(code, species, size, 
         ne.r2, k, t70, 
         w.r2, alpha, beta, w.t70) %>%
  left_join(traits.code) %>% 
  filter(!is.na(P)) %>%
  filter(!is.na(waterperc)) -> decayfits.traits

#set up full models
respVars <- list("k","t70","ne.r2", "alpha","beta","w.t70","w.r2")
rhs <- "size + waterperc + density + barkthick + P + K + Ca + Mn + Fe + Zn + N + C"
mod.full.list<-lapply(respVars, ModelFit_manyYs, rhs, curr.data=decayfits.traits) # summaryTable_fxns.R

#do stepwise model selection #uncomment if data changes
# mod.select.list<-lapply(mod.full.list, function(x) {
#   x.updated<-update(x, . ~ ., data = model.frame(x))
#   mod.select<-step(x.updated, direction="backward")
#   return(mod.select)
#   })
# names(mod.select.list) <- respVars
# #saveRDS(mod.select.list, file = "derived_data/modSelect.RData")
mod.select.list <- readRDS(file = "derived_data/modSelect.RData")

#summarize the best models
prettyTab <- MakeLmSummaryTable(respvars=unlist(respVars), mod.list=mod.select.list) # summaryTable_fxns.R
write.csv(prettyTab, "output/traitsummary_code.csv")

#plot
sum.list<-lapply(mod.select.list, summary)
coefs.df<-PullLmCoefs(sum.list, unlist(respVars))
fitstat.df<-PullLmFitStats(sum.list, unlist(respVars))
fitstat.df %>%
  gather(key = "respvar", value = "value", -c(term)) %>%
  filter(term == "r.squared") %>%
  select(-term) %>%
  rename('r.squared'=value) -> r2.df
coefs.df %>%
  left_join(r2.df) %>%
  filter(respvar %in% c("alpha","beta","w.t70","w.r2")) -> coefs.df

ggplot(coefs.df, aes(x = respvar, y = term, fill = r.squared)) +
  geom_tile() + geom_text(aes(label = round(est, digits = 4))) +
  xlab("Response variable") + ylab("Wood trait") +
  theme_classic()
```

Variation in w.t70 and beta (shape param) were best explained by traits (high r2); whereas traits explained much less variation in alpha (scale) and w.r2.

- alpha: Samples that decay fast have low density. Other fast-decay attributes include: thin bark, low C, high N, and belonging to the large size class.
- beta: Samples with a stronger S-shaped decay trajectory have low N and high density. Other attributes include: thick bark, high C, and belonging to the large size class.
- w.r2: Samples with tightly-fitting decay models have high N, low density, and belong to the large size class.
- w.t70: Samples with long wait times to 70% mass remaining have low N and belong to the large size class. Other attributes include: thick bark, high C, and low water content.


```{r}
#extract and save the residuals
dataset.list<-rep(list(decayfits.traits), length(respVars))
names(mod.select.list)<-respVars
traitResiduals.code<-ExtractResids(mod.list=mod.select.list, dataset.list=dataset.list, sampleName = "code") # summaryTable_fxns.R

rm(mod.full.list, mod.select.list, 
   prettyTab, decayfits.traits)

```

## *Hyp (stem-level)* Stem-level initial wood traits will predict variation in percent mass loss at each time step.

First, we need to decide what trait data (and samples) to include in this analysis since we don't have full coverage of stem-level trait data. Density and bark thickness were only measured on small sized stems.  If there is not be very much within-species variation in these traits that contribute to variation in percent mass loss than we can justify including species-level estimates of these traits in the stem-level model. 

Plot the small-sized stem-level measures of density and barkthick
```{r}

# prep a dataset with pmr, stem-level and code-level density and barkthick
traits.stem %>%
  filter(size=="small") %>%
  select(codeStem, code, density, barkthick) %>%
  filter(!is.na(density) & !is.na(barkthick)) %>%
  rename("density_stem"="density",
         "barkthick_stem"="barkthick") -> db.stem
traits.code %>%
  filter(size=="small") %>%
  select(code, density, barkthick) %>%
  filter(!is.na(density) & !is.na(barkthick)) %>%
  rename("density_code"="density",
         "barkthick_code"="barkthick") -> db.code
db.stem %>%
  left_join(db.code) %>%
  left_join(pmr_byStem) -> db.df

# look at the within-species variation in density and barkthick
p.denVar<-ggplot(db.df, 
                 aes(x=reorder(code, density_code), y=density_stem)) + 
  geom_point() + theme_bw() + coord_flip() +
  xlab("Wood species") + ylab("Density (g/cm3)")
p.barVar<-ggplot(db.df, 
                 aes(x=reorder(code, barkthick_code), y=barkthick_stem)) + 
  geom_point() + theme_bw() + coord_flip() +
  xlab("Wood species") + ylab("Bark thickness (mm)") +
  theme(axis.text.y = element_blank(), 
            axis.ticks.y = element_blank(), 
            axis.title.y = element_blank(),
            plot.margin = unit(c(0,1,0,0), "lines"),
            plot.background = element_blank())
grid.newpage()
grid.draw(cbind(ggplotGrob(p.denVar), ggplotGrob(p.barVar), size = "last"))

#pdf("output/variation_densityNbarkthick.pdf", width=5, height=5)
#grid.newpage()
#grid.draw(cbind(ggplotGrob(p.denVar), ggplotGrob(p.barVar), size = "last"))
#dev.off()

rm(db.stem, db.code, p.denVar, p.barVar)

```

A few species have a relatively large amount of within-species variation in density (i.e. alli) and barkthickness (i.e. leer and cota).

Compare model fits (r2) using stem and species-level data to identify how much information about percent mass remaining is lost by using species-level estimates.
```{r}

#set up models
respVars <- list("time7", "time13", "time25", "time37","time59")
mod.stem_density.list <- lapply(respVars, ModelFit_manyYs, rhs="density_stem", curr.data=db.df) # summaryTable_fxns.R
mod.code_density.list <- lapply(respVars, ModelFit_manyYs, rhs="density_code", curr.data=db.df) # summaryTable_fxns.R
mod.stem_barkthick.list <- lapply(respVars, ModelFit_manyYs, rhs="barkthick_stem", curr.data=db.df) # summaryTable_fxns.R
mod.code_barkthick.list <- lapply(respVars, ModelFit_manyYs, rhs="barkthick_code", curr.data=db.df) # summaryTable_fxns.R

#cox test to compare non-nested models
# if the first model (M1) contains the correct set of regressors, then a fit of the regressors from the second model (M2) to the fitted values from M1 should have no further explanatory value. But if it has, it can be concluded that M1 does not contain the correct set of regressors
cox.density <- Do_coxTests(mod.stem_density.list, 
               mod.code_density.list, 
               respvars=unlist(respVars))
# stem level density information improves estimates for time7 and time59
cox.barkthick <- Do_coxTests(mod.stem_barkthick.list, 
                             mod.code_barkthick.list, 
                             respvars=unlist(respVars))

#annotation <- c("M1 = stem, M2 = code")
extr_cox_results <-function(x){
  df <- data.frame(mod = row.names(x), pval = x$`Pr(>|z|)`)
  return(df)
}

cox.density.df <- list_to_df(lapply(cox.density, extr_cox_results))
cox.density.df$meas <- "density"
cox.barkthick.df <- list_to_df(lapply(cox.barkthick, extr_cox_results))
cox.barkthick.df$meas <- "barkthick"
cox.df <- rbind(cox.density.df, cox.barkthick.df)
write.csv(cox.df, file="output/smallsize_codeVstem_cox.csv")

rm(db.df, mod.stem_density.list, mod.code_density.list, mod.stem_barkthick.list, mod.code_barkthick.list)

```

- For density -- Stem-level data (relative to code-level data) improves estimates of pmr after 7 and 59 months.
- For barkthickness -- Stem-level data (relative to code-level data) does not improve estimates of pmr at any time point.

Compile a "stem-level" dataframe with (a) stem-level percent mass remaining values, (b) stem-level traits including waterperc and chemistry along, and (c) small species-level density and bark thickness data. Use model selection to determine which traits to include.
```{r, results=FALSE}

# create dataframes
# stem-level waterperc, xrf, and CN and (small) species-level barkthickness and density
datasets<-lapply(respVars, function(x) {
  result<-CreateTraitPMRpair(x, traits.stem, traits.code, pmr_byStem) #analysisDF_fxns.R
  return(result)
})
names(datasets)<-respVars

#set up full models
rhs <- "size + waterperc + density_smspp + barkthick_smspp + P + K + Ca + Mn + Fe + Zn + N + C"
lhs <- "curr.pmr"
mod.full.list<-lapply(datasets, function(x) {
  result<-ModelFit_manyYs(y=lhs, rhs=rhs, curr.data=x)
  return(result)
})

# #do stepwise model selection
# mod.select.list<-lapply(mod.full.list, function(x) {
#   x.updated<-update(x, . ~ ., data = model.frame(x)) 
#   mod.select<-step(x.updated, direction="backward")
#   return(mod.select)
#   })
# saveRDS(mod.select.list, file = "derived_data/modSelect_stem.RData")
mod.select.list <- readRDS(file = "derived_data/modSelect_stem.RData")

#summarize the best models
prettyTab <- MakeLmSummaryTable(respvars=unlist(respVars), mod.list=mod.select.list) # summaryTable_fxns.R
write.csv(prettyTab, "output/traitsummary_stem.csv")

#plot
sum.list<-lapply(mod.select.list, summary)
coefs.df<-PullLmCoefs(sum.list, unlist(respVars))
fitstat.df<-PullLmFitStats(sum.list, unlist(respVars))
fitstat.df %>%
  gather(key = "respvar", value = "value", -c(term)) %>%
  filter(term == "r.squared") %>%
  select(-term) %>%
  rename('r.squared'=value) -> r2.df
coefs.df %>%
  left_join(r2.df) -> coefs.df

coefs.df$respvar<- factor(coefs.df$respvar, levels = c("time7","time13","time25","time37","time59"))

ggplot(coefs.df, aes(x = respvar, y = term, fill = r.squared)) +
  geom_tile() + geom_text(aes(label = round(est, digits = 4))) +
  xlab("Response variable") + ylab("Wood trait") +
  theme_classic()

```

The explanatory power of wood traits were lowest for the first decay time point (7 months). Samples had more mass remaining...

- All time points: Low water content
- Early-to-mid time points: Low N and belonged to the small size class
- Mid time points: High P and low Zn
- Late time point: High C and thin bark

```{r}
#extract and save the residuals
traitResiduals.stem<-ExtractResids(mod.list=mod.select.list, dataset.list=datasets, sampleName = "codeStem") # summaryTable_fxns.R

rm(dataset.list, datasets, lhs, rhs, mod.full.list, mod.select.list, respVars, prettyTab)

```




