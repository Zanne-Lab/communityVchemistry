---
title: "Do wood traits explain decay?"
author: "Marissa Lee"
date: "12/2/2018"
output: github_document
---

```{r, include = F}
#chunk options
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

Load libraries, functions, data
```{r load}

#---------------------------#
#libraries
library(knitr) #r markdown
library(readr) #read/write
library(magrittr) #data formatting
library(tidyr) #data formatting
library(dplyr) #data formatting
library(ggplot2) #plotting
library(grid) #plotting
library(gridExtra)
#devtools::install_github("cornwell-lab-unsw/litterfitter") #fit decay models to timeseries
library(litterfitter) #fit decay models to timeseries
library(lmtest) # for coxtest()
#library(vegan) #diversity metrics
#library(rioja) #WA-PLS
library(GGally)

#---------------------------#
#fxns
source('code/helper_fxns.R')
sourceDir('code')

#---------------------------#
#data

# stems in the study
stemSamples <- load_stemSamples() # this function is in load_microbeData.R

# stem mass
initial_mass <- read_in_initial_mass()
harvest_mass <- LoadHarvestFiles()
pmr <- Calc_massRemaining(initial_mass, harvest_mass) # calculate percent mass remaining (pmr)
pmr_byStem <- AvgPMR_byStem(pmr) # average pmr for each stem and timepoint
stem.respVars <- list("time7", "time13", "time25", "time37","time59")

# decay fits
#decayfits <- fit_all_curves(pmr, stemSamples) #this recalculates all the curve fits, uncomment if the data changes; for each species+size
#write_csv(decayfits,"derived_data/decayfits.csv")
decayfits <- read_csv("derived_data/decayfits.csv")
indx <- unique(stemSamples[,c("code","Binomial","size")])
decayfits %>%
  left_join(indx) -> decayfits
code.respVars <- list("k","t60","ne.r2", "alpha","beta","w.t60","w.r2") # weibull params: alpha = shape param, beta = scale param

# wood traits
#trait.data.l <- mergeTraitData() # all trait data
traits.code <- trait.means_byCode_new(stemSamples, fill.densitybark = TRUE) # averaged by code; if fill.densitybark == TRUE, then use small stem estimates to approximate large stem density and bark thickness
#trait.sds_byCode(stemSamples) # within code variation
#trait.n_byCode(stemSamples) # number of code samples that were aggregated
traits.stem <- trait.means_byStem_new(stemSamples) # averaged by codeStem
#trait.sds_byStem(stemSamples) # within codeStem variation
#trait.n_byStem(stemSamples) # number of codeStem samples that were aggregated

```

Check out correlations among traits and produce bivariate plots. Exclude C fraction data...
```{r}
cfract.traits <- c("Arabinose","Galactose","Glucose","Mannose","perc.Total.lignin","Rhamnose","Xylose")
traits.code %>%
  select(-cfract.traits) %>%
  filter(!is.na(C)) -> traits.code.noc
matonly <- traits.code.noc[,!colnames(traits.code.noc) %in% c("code", "species", "size")]
matonly.s <- scale(as.matrix(matonly[,-1]))
corrplot(cor(matonly.s), type = "lower", diag = F)
ggpairs(data = matonly)

```

Include C fraction data and exclude samples w/o this information
```{r}
traits.code %>%
  filter(!is.na(Arabinose)) -> traits.code.c
matonly <- traits.code.c[,!colnames(traits.code.c) %in% c("code", "species", "size")]
matonly.s <- scale(as.matrix(matonly[,-1]))
corrplot(cor(matonly.s), type = "lower", diag = F)
ggpairs(data = matonly)

```

We expect initial wood traits will explain varitation in species+size decay rate (k and t70), species+size lagginess (alpha), and stem-level percent mass remaining at 7, 13, 25, and 37 months of decay. Specifically, we expect samples with (a) high water percent, (b) low density and total C, (c) high macro and micro nutrients, and (d) thicker bark (potential mech: limiting microbial colonization) to have faster decay and less lagginess. 

## *Hyp (species+size-level)* Species+size-level initial wood traits will predict variation decay rates and lagginess.
```{r}
makefig__traits_explain_decayParams(decayfits, traits.code) # output/figures/maintext/traits_explain_decayparams.pdf

#save the resulting object that contains residual values
#result.traitsDecay <- doAnalysis_traits_explain_decayParams(decayfits, traits.code) # this fxn is called in the makefig fxn above
```
![](output/figures/maintext/traits_explain_decayparams.pdf)

Variation in w.t70 and beta (shape param) were best explained by traits (high r2); whereas traits explained much less variation in alpha (scale) and w.r2.

- alpha: Samples that decay fast have low density. Other fast-decay attributes include: thin bark, low C, high N, and belonging to the large size class.
- beta: Samples with a stronger S-shaped decay trajectory have low N and high density. Other attributes include: thick bark, high C, and belonging to the large size class.
- w.r2: Samples with tightly-fitting decay models have high N, low density, and belong to the large size class.
- w.t70: Samples with long wait times to 70% mass remaining have low N and belong to the large size class. Other attributes include: thick bark, high C, and low water content.


## *Hyp (stem-level)* Stem-level initial wood traits will predict variation in percent mass loss at each time step.

First, we need to decide what trait data (and samples) to include in this analysis since we don't have full coverage of stem-level trait data. Density and bark thickness were only measured on small sized stems.  If there is not be very much within-species variation in these traits that contribute to variation in percent mass loss than we can justify including species-level estimates of these traits in the stem-level model. 

Plot the small-sized stem-level measures of density and barkthick
```{r}
makefig__variation_densityNbarkthick(traits.stem, traits.code, pmr_byStem) # output/figures/supplementary/variation_densityNbarkthick.pdf

```
![](output/figures/supplementary/variation_densityNbarkthick.pdf)

A few species have a relatively large amount of within-species variation in density (i.e. alli) and barkthickness (i.e. leer and cota).

Compare model fits (r2) using stem and species-level data to identify how much information about percent mass remaining is lost by using species-level estimates.
```{r}
cox.df <- doAnalysis_variation_densityNbarkthick(traits.stem, traits.code, pmr_byStem) 
cox.df
write.csv(cox.df, file="output/tables/supplementary/smallsize_codeVstem_cox.csv")

```

- For density -- Stem-level data (relative to code-level data) improves estimates of pmr after 7 and 59 months.
- For barkthickness -- Stem-level data (relative to code-level data) does not improve estimates of pmr at any time point.

Compile a "stem-level" dataframe with (a) stem-level percent mass remaining values, (b) stem-level traits including waterperc and chemistry along, and (c) small species-level density and bark thickness data. Use model selection to determine which traits to include.
```{r, results=FALSE}

makefig__traits_explain_pmr(traits.stem, traits.code, pmr_byStem) # output/figures/maintext/traits_explain_pmr.pdf

#save the resulting object that contains residual values
#result.traitsPMR <- doAnalysis_traits_explain_pmr(pmr_byStem, traits.code, traits.stem) # this fxn is called in the makefig fxn above

```
![](output/figures/maintext/traits_explain_pmr.pdf)

Visualize stem samples in trait space
```{r}
pca <- prcomp(matonly.s)
df <- data.frame(pca$x[,1:2], 
                 traits.code.c[,c("species","code","size")])
datapc <- data.frame(varnames=rownames(pca$rotation), pca$rotation[,1:2])
mult <- min(
  (max(df[,"PC1"]) - min(df[,"PC2"])/(max(datapc[,"PC2"])-min(datapc[,"PC2"]))),
  (max(df[,"PC2"]) - min(df[,"PC1"])/(max(datapc[,"PC1"])-min(datapc[,"PC1"])))
)
datapc <- transform(datapc,
                    v1 = .7 * mult * datapc$PC1,
                    v2 = .7 * mult * datapc$PC2)
  
plot_12 <- ggplot(data=datapc, aes(x=v1, y=v2, label=varnames)) + 
  geom_text(size=3, vjust=1, color=1) + 
  geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),
               arrow=arrow(length=unit(0.2,"cm")), alpha=0.75, color=1) + 
  coord_fixed() +
  geom_point(mapping=aes(x=PC1, y=PC2, 
                        color = species), data=df, inherit.aes = FALSE) +
  theme_bw() + xlab("PC1") + ylab("PC2")
plot_12

summary(pca)
```


The explanatory power of wood traits were lowest for the first decay time point (7 months). Samples had more mass remaining...

- All time points: Low water content
- Early-to-mid time points: Low N and belonged to the small size class
- Mid time points: High P and low Zn
- Late time point: High C and thin bark




