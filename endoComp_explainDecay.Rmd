---
title: "Does endophyte composition explain decay?"
author: "Marissa Lee"
date: "12/2/2018"
output: github_document
---

```{r, include = F}
#chunk options
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

Load libraries, functions, data
```{r load}

#---------------------------#
#libraries
library(knitr) #r markdown
library(readr) #read/write
library(magrittr) #data formatting
library(tidyr) #data formatting
library(dplyr) #data formatting
library(ggplot2) #plotting
library(grid) #plotting
library(gridExtra)
#devtools::install_github("cornwell-lab-unsw/litterfitter") #fit decay models to timeseries
library(litterfitter) #fit decay models to timeseries
library(lmtest) # for coxtest()
library(vegan) #diversity metrics
library(rioja) #WA-PLS

#---------------------------#
#fxns
source('code/helper_fxns.R')
sourceDir('code')

#---------------------------#
#data

# stems in the study
stemSamples <- load_stemSamples() # this function is in load_microbeData.R

# stem mass
initial_mass <- read_in_initial_mass()
harvest_mass <- LoadHarvestFiles()
pmr <- Calc_massRemaining(initial_mass, harvest_mass) # calculate percent mass remaining (pmr)
pmr_byStem <- AvgPMR_byStem(pmr) # average pmr for each stem and timepoint
stem.respVars <- list("time7", "time13", "time25", "time37","time59")

# decay fits
#decayfits <- fit_all_curves(pmr, stemSamples) #this recalculates all the curve fits, uncomment if the data changes; for each species+size
#write_csv(decayfits,"derived_data/decayfits.csv")
decayfits <- read_csv("derived_data/decayfits.csv")
indx <- unique(stemSamples[,c("code","Binomial","size")])
decayfits %>%
  left_join(indx) -> decayfits
code.respVars <- list("k","t60","ne.r2", "alpha","beta","w.t60","w.r2") # weibull params: alpha = shape param, beta = scale param

# wood traits
#trait.data.l <- mergeTraitData() # all trait data
traits.code <- trait.means_byCode(stemSamples, fill.densitybark = TRUE) # averaged by code; if fill.densitybark == TRUE, then use small stem estimates to approximate large stem density and bark thickness
#trait.sds_byCode(stemSamples) # within code variation
#trait.n_byCode(stemSamples) # number of code samples that were aggregated
traits.stem <- trait.means_byStem(stemSamples) # averaged by codeStem
#trait.sds_byStem(stemSamples) # within codeStem variation
#trait.n_byStem(stemSamples) # number of codeStem samples that were aggregated

# wood trait residuals (see `woodTraits_explainDecay.Rmd')
result.traitsDecay <- doAnalysis_traits_explain_decayParams(decayfits, traits.code, code.respVars)
traitResiduals.code <- result.traitsDecay$traitResiduals.code
result.traitsPMR <- doAnalysis_traits_explain_pmr(pmr_byStem, traits.code, traits.stem, stem.respVars)
traitResiduals.stem <- result.traitsPMR$traitResiduals.stem

#microbes
microb.data <- load_MicrobeCollection(stemSamples)
taxAndFunguild <- microb.data$taxAndFunguild
comm.otu <- microb.data$comm.otu
seqSamples <- microb.data$seqSamples

```

Figure S1. Sample-effort curves
```{r}
#this takes a while... uncomment if the data changes
#plot_sampleEffortCurves(comm.otu) # output/figures/supplementary/sampleEffortCurve.pdf

```

Filter community matrix to include only taxa that are present in a least 20% of all the samples. This step removes taxa that may not contribute much to our understanding of the relationship between speciesâ€™ multivariate abundance and environment.
```{r}
comm.otu.trimmed <- removeRareOTUs(comm.otu)
```

## *Hyp (species+size-level)* Species+size-level (average) initial microbial community composition will predict variation in decay model fit (r2), rate (t70, k), and lagginess (alpha).
```{r, message = F, results = F}
cvfit.results.code <- doAnalysis_endoComp_explainDecay(comm.otu, seqSamples, decayfits, code.respVars)
cvfit.results.code$prettyTabs # will merge this with the other summary table to export as a csv in the next chunk
```

None of the components are significant.


## *Hyp (stem-level)* Stem-level initial microbial communitiy compositions will predict variation in percent mass loss, particularly in the early stages of decay.
```{r, message = F, results = F}

cvfit.results.stem <- doAnalysis_endoComp_explainPMR(comm.otu, pmr_byStem, stem.respVars)
cvfit.results.stem$prettyTabs

commTab <- maketab_endoComp_explain(cvfit.results.code, cvfit.results.stem, code.respVars, stem.respVars)
write.csv(commTab, file="output/tables/supplementary/commcompsummary.csv")
```

Comp01 (of the non-trimmed community) is a significant predictor of percent mass remaining at 37 months. 


Plot the distribution of WA-PLS scores
```{r}
makefig__wapls_score_time37(cvfit.results.stem, taxAndFunguild) # output/figures/supplementary/wapls_score_time37.pdf
```
[](output/figures/supplementary/wapls_score_time37.pdf)

Who is in the top and bottom 1%?
```{r}
otucats <- maketab__wapls_score_time37_otuCats(cvfit.results.stem, taxAndFunguild)
otucats
write.csv(otucats, file = "output/tables/supplementary/wapls_score_time37_otuCats.csv")
```
Many of the bottom 1% OTUs are classified as saprotrophs.  That makes sense since low WA-PLS scores indicate an association with high mass loss (i.e. less mass remaining) at time37.

But saprotrophs are also found at many points along the gradient...
```{r, message=FALSE, warning=FALSE}
makefig__wapls_score_time37_otuCats(cvfit.results.stem, taxAndFunguild) # output/figures/supplementary/wapls_score_time37_otuCats.pdf

```
[](output/figures/supplementary/wapls_score_time37_otuCats.pdf)

Is this because there is an underlying signature of wood traits on the initial microbial community that is driving the relationship between the community and the mass remaining after 37 months?  The next analysis ("Community+traits" as predictor) will test this formally. Just out of curiousity, I'd like to pull in OTU "niche" info from the boral analysis to see if there's a relationship between OTU WA-PLS scores and wood trait coeffient estimates.

Reminder of which wood traits were included in the best model to explain pmr at time37...
[](output/figures/maintext/traits_explain_pmr.pdf)
More water leads to less mass remaining; more P leads to more mass remaining

Plot OTU wood trait estimates (from boral) versus signif WA-PLS score.
```{r}
makefig__wapls_score_time37_boral(cvfit.results.stem, taxAndFunguild) # output/figures/supplementary/wapls_score_time37_boral.pdf

```
[](output/figures/supplementary/wapls_score_time37_boral.pdf)
There's a weak negative relationship between an OTU's WA-PLS score and waterperc coefficient (slope=-2.3, p=.03), suggesting that OTUs that "prefer" high-water niche space are associated with less mass remaining at time37.


##########################################

# Community+traits as a predictor

## *Hyp (species+size-level)* After accounting for variation in decay due to wood traits, average initial microbial communitiy compositions will predict variation in decay model fit (r2), rate (t70, k), and lagginess (alpha).
```{r, message=FALSE, results = F}
cvfit.results.code <- doAnalysis_endoComp_explainDecayResids(comm.otu, seqSamples, decayfits, code.respVars, traitResiduals.code)
cvfit.results.code$prettyTabs
```

Community data doesn't improve our understanding of decay rates (k, t70) or variation in decay rate (ne.r2) beyond what is known from the trait data.


## *Hyp (stem-level)* After accounting for variation in decay due to wood traits (no models with density, includes small-species level bark thickness), stem-specific initial microbial communitiy compositions will predict variation in percent mass loss, particularly in the early stages of decay.
```{r, message=FALSE, results = F}
cvfit.results.stem <- doAnalysis_endoComp_explainPMRResids(comm.otu, pmr_byStem, stem.respVars, traitResiduals.stem)
cvfit.results.stem$prettyTabs

#Notes about how to interpret WA-PLS...
#rand.t.test(fit.tr.t13.cv.nt) # comp2 has a signif pval, but...
#screeplot(fit.tr.t13.cv.nt)
#There are two cases where there's a large % decrease in model RMSE from Component 1 to Component 2. This happens when using the whole community dataset to predict trait residuals at time13 and time37. In both cases the cross-validated RMSE is way higher than the model RMSE for all the components, suggesting that even the first community component doesn't perform well on the leave-one-out validation dataset.  Also, the cross-validated R-squared values (correlation between the observed and predicted values from the "loo" validation dataset) show that the model fit decreases after Component 1.  If there were a global maximum such that we saw an increase in R2 after adding more Components then maybe we could interpret Component 2, but there is no evidence of a better fitting model with more components based on the cross-validation results.

commTab <- maketab_endoComp_explain(cvfit.results.code, cvfit.results.stem, code.respVars, stem.respVars)
write.csv(commTab, file="output/tables/supplementary/commcompsummary_traitresid.csv")

```

Community data doesn't improve our understanding of mass loss (pmr after 7, 13, 25, 37, and 59 months) beyond what is known from the trait data.



# Relationship between wood traits and community

## *Hyp (species+size-level)* Initial microbial communitiy compositions will covary with initial wood traits

Use ordistep to find the best combination of traits to constrain variation in the endophyte community
```{r}
makefigs__endoComp_woodTraits(comm.otu, seqSamples, traits.code) # output/figures/supplementary/dbRDA_code.pdf

```
[](output/figures/supplementary/dbRDA_code.pdf)

Anova-like tables
```{r}
tab.list <- maketabs__endoComp_woodTraits(comm.otu, seqSamples, traits.code)
tab.list
write.csv(tab.list$an.nt.code, file="output/tables/supplementary/dbRDAanova_nt_code.csv")
write.csv(tab.list$an.t.code, file="output/tables/supplementary/dbRDAanova_t_code.csv")

```


## *Hyp (stem-level)* Average initial microbial communitiy compositions will covary with initial wood traits
```{r}
makefigs__endoComp_woodTraits.stem(comm.otu, traits.code, traits.stem) # output/figures/supplementary/dbRDA_stem.pdf

```

Anova-like tables
```{r}

tab.list <- maketabs__endoComp_woodTraits.stem(comm.otu, traits.code, traits.stem)
tab.list
write.csv(tab.list$an.nt.stem, file="output/tables/supplementary/dbRDAanova_nt_stem.csv")
write.csv(tab.list$an.t.stem, file="output/tables/supplementary/dbRDAanova_t_stem.csv")

```



